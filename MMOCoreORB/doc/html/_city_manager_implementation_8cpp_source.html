<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Core3: /Users/victor/git/Core3Mda/MMOCoreORB/src/server/zone/managers/city/CityManagerImplementation.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Core3
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_075bb3ff235063c77951cd176d15a741.html">server</a></li><li class="navelem"><a class="el" href="dir_9e27d73ba17b043ea65c9708c594875e.html">zone</a></li><li class="navelem"><a class="el" href="dir_09f2800c98a68987a1cd7da559bc6100.html">managers</a></li><li class="navelem"><a class="el" href="dir_c77124aa802a476cd14d4a6b1b110452.html">city</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">CityManagerImplementation.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_city_manager_implementation_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * CityManagerImplementation.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *  Created on: Oct 10, 2010</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *      Author: crush</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &quot;engine/engine.h&quot;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_manager_8h.html">CityManager.h</a>&quot;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_chat_manager_8h.html">server/chat/ChatManager.h</a>&quot;</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="server_2zone_2_zone_8h.html">server/zone/Zone.h</a>&quot;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_zone_server_8h.html">server/zone/ZoneServer.h</a>&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="server_2zone_2objects_2player_2_player_object_8h.html">server/zone/objects/player/PlayerObject.h</a>&quot;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="server_2zone_2managers_2object_2_object_manager_8h.html">server/zone/managers/object/ObjectManager.h</a>&quot;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_structure_manager_8h.html">server/zone/managers/structure/StructureManager.h</a>&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_planet_manager_8h.html">server/zone/managers/planet/PlanetManager.h</a>&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_player_manager_8h.html">server/zone/managers/player/PlayerManager.h</a>&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_structure_object_8h.html">server/zone/objects/structure/StructureObject.h</a>&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_region_8h.html">server/zone/objects/region/Region.h</a>&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_region_8h.html">server/zone/objects/region/CityRegion.h</a>&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_specialization_session_8h.html">server/zone/objects/player/sessions/CitySpecializationSession.h</a>&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_treasury_withdrawal_session_8h.html">server/zone/objects/player/sessions/CityTreasuryWithdrawalSession.h</a>&quot;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_sui_transfer_box_8h.html">server/zone/objects/player/sui/transferbox/SuiTransferBox.h</a>&quot;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_sui_message_box_8h.html">server/zone/objects/player/sui/messagebox/SuiMessageBox.h</a>&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_sui_input_box_8h.html">server/zone/objects/player/sui/inputbox/SuiInputBox.h</a>&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_treasury_deposit_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/CityTreasuryDepositSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_manage_militia_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/CityManageMilitiaSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_add_militia_member_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/CityAddMilitiaMemberSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_register_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/CityRegisterSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_mayoral_vote_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/CityMayoralVoteSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_adjust_tax_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/CityAdjustTaxSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_set_tax_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/CitySetTaxSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_citizen_list_8h.html">server/zone/objects/region/CitizenList.h</a>&quot;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_building_object_8h.html">server/zone/objects/building/BuildingObject.h</a>&quot;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_tax_pay_mail_task_8h.html">TaxPayMailTask.h</a>&quot;</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_shared_structure_object_template_8h.html">server/zone/templates/tangible/SharedStructureObjectTemplate.h</a>&quot;</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_rename_city_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/RenameCitySuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#ifndef CITY_DEBUG</span></div>
<div class="line"><a name="l00041"></a><span class="lineno"><a class="code" href="_city_manager_implementation_8cpp.html#af3a0d5cbc90b5f7a5c198e7661603b0c">   41</a></span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define CITY_DEBUG</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<a class="code" href="class_cities_allowed.html">CitiesAllowed</a> CityManagerImplementation::citiesAllowedPerRank;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<a class="code" href="class_city_specialization_map.html">CitySpecializationMap</a> CityManagerImplementation::citySpecializations;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<a class="code" href="class_city_tax_map.html">CityTaxMap</a> CityManagerImplementation::cityTaxes;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;Vector&lt;uint8&gt; CityManagerImplementation::citizensPerRank;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;Vector&lt;uint16&gt; CityManagerImplementation::radiusPerRank;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="keywordtype">int</span> CityManagerImplementation::cityUpdateInterval = 0;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="keywordtype">int</span> CityManagerImplementation::newCityGracePeriod = 0;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;uint64 CityManagerImplementation::citySpecializationCooldown = 0;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keywordtype">int</span> CityManagerImplementation::cityVotingDuration = 0;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;uint64 CityManagerImplementation::treasuryWithdrawalCooldown = 0;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;byte CityManagerImplementation::cityVotingCycles = 0;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;byte CityManagerImplementation::cityVotingCyclesUntilLocked = 0;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keywordtype">int</span> CityManagerImplementation::decorationsPerRank = 10;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="keywordtype">float</span> CityManagerImplementation::maintenanceDiscount = 1.0f;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a08dd8c888b5905b41b22c4a4e40b64d7">   59</a></span>&#160;<span class="keywordtype">void</span> CityManagerImplementation::loadLuaConfig() {</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        info(<span class="stringliteral">&quot;Loading configuration file.&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        Lua* lua = <span class="keyword">new</span> Lua();</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        lua-&gt;init();</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        lua-&gt;runFile(<span class="stringliteral">&quot;scripts/managers/city_manager.lua&quot;</span>);</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        LuaObject luaObject = lua-&gt;getGlobalObject(<span class="stringliteral">&quot;CitiesAllowed&quot;</span>);</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        <span class="keywordflow">if</span> (luaObject.isValidTable()) {</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt;= luaObject.getTableSize(); ++i) {</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;                        LuaObject planetCitiesAllowed = luaObject.getObjectAt(i);</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;                        <span class="keywordflow">if</span> (planetCitiesAllowed.isValidTable()) {</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                                String planet = planetCitiesAllowed.getStringAt(1);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;                                LuaObject citiesAllowed = planetCitiesAllowed.getObjectAt(2);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                                <span class="keywordflow">if</span> (citiesAllowed.isValidTable()) {</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;                                        Vector &lt; byte &gt; table;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 1; j &lt;= citiesAllowed.getTableSize(); ++j) {</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                                                table.add(citiesAllowed.getIntAt(j));</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                                        }</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                                        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4a6e9ef5adf8ef1d05cfac10b46ded61">citiesAllowedPerRank</a>.put(planet, table);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                                }</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                                citiesAllowed.pop();</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                        }</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                        planetCitiesAllowed.pop();</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                }</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        }</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        luaObject.pop();</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        luaObject = lua-&gt;getGlobalObject(<span class="stringliteral">&quot;CitySpecializations&quot;</span>);</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa497717f9cff392a7d369a74e741af39">citySpecializations</a>.<a class="code" href="class_city_specialization_map.html#a49b24489c15c4af7006a73e829ddaa3e">readObject</a>(&amp;luaObject);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        luaObject.pop();</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        info(</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                        <span class="stringliteral">&quot;Loaded &quot;</span> + String::valueOf(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa497717f9cff392a7d369a74e741af39">citySpecializations</a>.size())</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                                        + <span class="stringliteral">&quot; city specializations.&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        luaObject = lua-&gt;getGlobalObject(<span class="stringliteral">&quot;CityTaxes&quot;</span>);</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a237d57a92e7fc9be9c859bb0e7118118">cityTaxes</a>.<a class="code" href="class_city_tax_map.html#a059a2e2bc55a70f1f091b9b477fea2a9">readObject</a>(&amp;luaObject);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        luaObject.pop();</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        info(<span class="stringliteral">&quot;Loaded &quot;</span> + String::valueOf(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a237d57a92e7fc9be9c859bb0e7118118">cityTaxes</a>.size()) + <span class="stringliteral">&quot; city tax rules.&quot;</span>,</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                        <span class="keyword">true</span>);</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        <span class="comment">//Only load the static values on the first zone.</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a58a6fcf5e6ea07c6e2f6b6354e8e3358">cityUpdateInterval</a> = lua-&gt;getGlobalInt(<span class="stringliteral">&quot;CityUpdateInterval&quot;</span>);</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a78ece5e2271aa7ae08fb600399bdd6be">newCityGracePeriod</a> = lua-&gt;getGlobalInt(<span class="stringliteral">&quot;NewCityGracePeriod&quot;</span>);</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a923b352a8a782a1b3e8de39e3f4b95fe">citySpecializationCooldown</a> = lua-&gt;getGlobalLong(</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                        <span class="stringliteral">&quot;CitySpecializationCooldown&quot;</span>);</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#afc5b8f19d39fa62c384673342f19d78a">cityVotingDuration</a> = lua-&gt;getGlobalInt(<span class="stringliteral">&quot;CityVotingDuration&quot;</span>);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a16c62c9c1da1be45848fd0b2f76501b1">treasuryWithdrawalCooldown</a> = lua-&gt;getGlobalLong(</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;                        <span class="stringliteral">&quot;TreasuryWithdrawalCooldown&quot;</span>);</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4cc0335576874ff093d26ff865cb630f">cityVotingCycles</a> = lua-&gt;getGlobalByte(<span class="stringliteral">&quot;CityVotingCycles&quot;</span>);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a8171b108d1f402c03b9c6ccd1ff77dca">cityVotingCyclesUntilLocked</a> = lua-&gt;getGlobalByte(</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;                        <span class="stringliteral">&quot;CityVotingCyclesUntilLocked&quot;</span>);</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#acff7e85fe64edea54512de7904f1b99e">decorationsPerRank</a> = lua-&gt;getGlobalInt(<span class="stringliteral">&quot;DecorationsPerRank&quot;</span>);</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> = lua-&gt;getGlobalFloat(<span class="stringliteral">&quot;maintenanceDiscount&quot;</span>);</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        luaObject = lua-&gt;getGlobalObject(<span class="stringliteral">&quot;CitizensPerRank&quot;</span>);</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="keywordflow">if</span> (luaObject.isValidTable()) {</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt;= luaObject.getTableSize(); ++i)</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7843d372fff4f95966d6b40365bda53c">citizensPerRank</a>.add(luaObject.getIntAt(i));</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        }</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        luaObject.pop();</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        luaObject = lua-&gt;getGlobalObject(<span class="stringliteral">&quot;RadiusPerRank&quot;</span>);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        <span class="keywordflow">if</span> (luaObject.isValidTable()) {</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt;= luaObject.getTableSize(); ++i)</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ad79d7ab45533faee283cc9834ee849ef">radiusPerRank</a>.add(luaObject.getIntAt(i));</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;        }</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        luaObject.pop();</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="keyword">delete</span> lua;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        lua = NULL;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;}</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#acc7acdf1ace1c04f505f655b7bef9a12">  147</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#acc7acdf1ace1c04f505f655b7bef9a12">CityManagerImplementation::loadCityRegions</a>() {</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        info(<span class="stringliteral">&quot;Loading any remaining city regions.&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        ObjectDatabaseManager* dbManager = ObjectDatabaseManager::instance();</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        ObjectDatabase* cityRegionsDB =</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                        ObjectDatabaseManager::instance()-&gt;loadObjectDatabase(</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;                                        <span class="stringliteral">&quot;cityregions&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="keywordflow">if</span> (cityRegionsDB == NULL) {</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;                error(<span class="stringliteral">&quot;Could not load the city regions database.&quot;</span>);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        }</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <span class="keywordtype">int</span> i = 0;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                ObjectDatabaseIterator iterator(cityRegionsDB);</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                ObjectInputStream* objectData = <span class="keyword">new</span> ObjectInputStream(2000);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                uint64 objectID;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                <span class="keywordflow">while</span> (iterator.getNextKeyAndValue(objectID, objectData)) {</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                        Reference&lt;CityRegion*&gt; <span class="keywordtype">object</span> = Core::getObjectBroker()-&gt;lookUp(objectID).castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>*&gt;();</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                        <span class="keywordflow">if</span> (<span class="keywordtype">object</span> != NULL &amp;&amp; object-&gt;getZone() != NULL) {</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                                ++i;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                                <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.put(object-&gt;getRegionName(), object);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                                error(</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                                                <span class="stringliteral">&quot;Failed to load city region with objectid: &quot;</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                                                                + String::valueOf(objectID));</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                        }</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                        objectData-&gt;clear();</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                }</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;                <span class="keyword">delete</span> objectData;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        } <span class="keywordflow">catch</span> (DatabaseException&amp; e) {</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                error(<span class="stringliteral">&quot;Failed loading city regions: &quot;</span> + e.getMessage());</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        }</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        info(<span class="stringliteral">&quot;Loaded &quot;</span> + String::valueOf(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.size()) + <span class="stringliteral">&quot; player city regions.&quot;</span>,</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;                        <span class="keyword">true</span>);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;}</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div>
<div class="line"><a name="l00195"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a994112b13dffde38c88c18701ec1a98c">  195</a></span>&#160;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a994112b13dffde38c88c18701ec1a98c">CityManagerImplementation::createCity</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor,</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                <span class="keyword">const</span> String&amp; cityName, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y) {</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        ManagedReference&lt;CityRegion*&gt; city = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>();</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        ObjectManager::instance()-&gt;persistObject(city, 1, <span class="stringliteral">&quot;cityregions&quot;</span>);</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        city-&gt;setCustomRegionName(cityName);</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        city-&gt;setZone(mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a83c519b8b1e57fcc329e85689ef9fb1a">getZone</a>());</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        city-&gt;setCityRank(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa4f33cd081599752ae889cc6565e459f">OUTPOST</a>);</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        city-&gt;setMayorID(mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>());</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_region.html">Region</a>* region =</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                        city-&gt;addRegion(x, y, <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ad79d7ab45533faee283cc9834ee849ef">radiusPerRank</a>.get(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa4f33cd081599752ae889cc6565e459f">OUTPOST</a> - 1), <span class="keyword">true</span>);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        city-&gt;rescheduleUpdateEvent(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a78ece5e2271aa7ae08fb600399bdd6be">newCityGracePeriod</a> * 60); <span class="comment">//Minutes</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        city-&gt;resetVotingPeriod();</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        <span class="comment">//TODO: Send email to mayor.</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.put(cityName, city);</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="keywordflow">return</span> city;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;}</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div>
<div class="line"><a name="l00216"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a23496dac85f2d30b0e90148887c6cab3">  216</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a23496dac85f2d30b0e90148887c6cab3">CityManagerImplementation::isCityRankCapped</a>(<span class="keyword">const</span> String&amp; planetName,</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;                byte rank) {</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        Vector &lt; byte &gt; *citiesAllowed = &amp;<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4a6e9ef5adf8ef1d05cfac10b46ded61">citiesAllowedPerRank</a>.get(planetName);</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        byte maxAtRank = citiesAllowed-&gt;get(rank - 1);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <span class="comment">// http://www.swgemu.com/archive/scrapbookv51/data/20070127193144/index.html  for information</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        byte totalAtRank = 0;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        Locker _lock(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a15497f5fb1c92d32f56c7aff060f0f81">_this</a>.get());</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.size(); ++i) {</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.get(i);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                <a class="code" href="classserver_1_1zone_1_1_zone.html">Zone</a>* cityZone = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a38a4f242f4f0fab87dda020dcf433563">getZone</a>();</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                <span class="keywordflow">if</span> (cityZone == NULL || cityZone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#a351fb1c2dc9bfd55792c4c41d0ec3343">getZoneName</a>() != planetName)</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>() &gt;= rank) {</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                        <span class="keywordflow">if</span> (++totalAtRank &gt;= maxAtRank) {</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                        }</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                }</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        }</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        <span class="keywordflow">return</span> (totalAtRank &gt;= maxAtRank);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;}</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7346338386d934df2b154a3ef878d3c1">  243</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7346338386d934df2b154a3ef878d3c1">CityManagerImplementation::sendCityReport</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <span class="keyword">const</span> String&amp; planetName, byte rank){</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        Locker _lock(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a15497f5fb1c92d32f56c7aff060f0f81">_this</a>.get(),creature);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        Vector &lt; byte &gt; *citiesAllowed = &amp;<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4a6e9ef5adf8ef1d05cfac10b46ded61">citiesAllowedPerRank</a>.get(planetName.toLowerCase());</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        <span class="keywordflow">if</span>(citiesAllowed-&gt;size()== 0){</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;INVALID PLANET&quot;</span>);</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        }</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        byte maxAtRank = citiesAllowed-&gt;get(rank - 1);</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <span class="keywordtype">int</span> totalCitiesAtRank = 0;</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="keywordtype">int</span> totalErroredCities = 0;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        StringBuffer report;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        report &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;===============================&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        report &lt;&lt; <span class="stringliteral">&quot;City Report / Planet = &quot;</span> &lt;&lt; planetName.toUpperCase() &lt;&lt; <span class="stringliteral">&quot;  Rank = &quot;</span> &lt;&lt; String::valueOf(rank) &lt;&lt; endl;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        report &lt;&lt; <span class="stringliteral">&quot;===================================&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        report &lt;&lt; <span class="stringliteral">&quot;City, citizens, structures, treasury, Loc, Next Update&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.size(); ++i) {</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.get(i);</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                <a class="code" href="classserver_1_1zone_1_1_zone.html">Zone</a>* cityZone = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a38a4f242f4f0fab87dda020dcf433563">getZone</a>();</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                <span class="keywordflow">if</span> (cityZone == NULL) {</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                                totalErroredCities++;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                }</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                <span class="keywordflow">if</span>( cityZone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#a351fb1c2dc9bfd55792c4c41d0ec3343">getZoneName</a>().toLowerCase() != planetName.toLowerCase() || city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>() != rank ) {</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                }</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                totalCitiesAtRank++;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                report &lt;&lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; String::valueOf(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa6caecdd8107e0a89f219c72f939a449">getCitizenCount</a>())</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                        &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; String::valueOf((<span class="keywordtype">int</span>)city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a365c80b4b636af52d9d69c95ec375205">getCityTreasury</a>())</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                        &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; String::valueOf(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a70c9899ed731ba749a36bb83d44c18eb">getAllStructuresCount</a>())</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                        &lt;&lt; <span class="stringliteral">&quot;,x: &quot;</span> &lt;&lt; String::valueOf(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0806f9e67b556b86442a5ad5d2b4d652">getPositionX</a>()) &lt;&lt; <span class="stringliteral">&quot; y:&quot;</span> &lt;&lt; String::valueOf(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ae3c1e84fd1e6d63d899a1110a8c8a3a9">getPositionY</a>())</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                        &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0e3025f8bf933d14de1e06e6cc77dae7">getNextUpdateTime</a>()-&gt;getFormattedTime()&lt;&lt;  endl;</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        }</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        report &lt;&lt; <span class="stringliteral">&quot;==============================&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        report &lt;&lt; <span class="stringliteral">&quot;Total Cities at rank: &quot;</span> &lt;&lt; String::valueOf(totalCitiesAtRank) &lt;&lt; endl;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        report &lt;&lt; <span class="stringliteral">&quot;Max at rank: &quot;</span> &lt;&lt; String::valueOf(maxAtRank) &lt;&lt; endl;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        report &lt;&lt; <span class="stringliteral">&quot;Total Errored Cities (all planets &amp; ranks): &quot;</span> &lt;&lt; String::valueOf(totalErroredCities) &lt;&lt; endl;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        report &lt;&lt; <span class="stringliteral">&quot;==============================&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(report.toString());</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;}</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div>
<div class="line"><a name="l00300"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a6165e1e75584e46826298ccb66cd6508">  300</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a6165e1e75584e46826298ccb66cd6508">CityManagerImplementation::validateCityInRange</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature,</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;                <a class="code" href="classserver_1_1zone_1_1_zone.html">Zone</a>* zone, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y) {</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        Vector3 testPosition(x, y, 0);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        Locker locker(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a15497f5fb1c92d32f56c7aff060f0f81">_this</a>.get());</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.size(); ++i) {</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.get(i);</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;                <a class="code" href="classserver_1_1zone_1_1_zone.html">Zone</a>* cityZone = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a38a4f242f4f0fab87dda020dcf433563">getZone</a>();</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                <span class="keywordflow">if</span> (cityZone == zone) {</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                                Vector3 position(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0806f9e67b556b86442a5ad5d2b4d652">getPositionX</a>(), city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ae3c1e84fd1e6d63d899a1110a8c8a3a9">getPositionY</a>(), 0);</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                                <span class="keywordflow">if</span> (position.squaredDistanceTo(testPosition) &lt; 1024 * 1024) {</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                                        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> msg(<span class="stringliteral">&quot;player_structure&quot;</span>,</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                                                        <span class="stringliteral">&quot;city_too_close&quot;</span>);</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                                        msg.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(msg);</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                                        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                                }</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                        } <span class="keywordflow">catch</span> (Exception&amp; e) {</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                        }</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                }</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        }</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;}</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div>
<div class="line"><a name="l00332"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7300c6f90d951f3c44e1f83a5bf188b7">  332</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7300c6f90d951f3c44e1f83a5bf188b7">CityManagerImplementation::validateCityName</a>(<span class="keyword">const</span> String&amp; name) {</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        Locker locker(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a15497f5fb1c92d32f56c7aff060f0f81">_this</a>.get());</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.contains(name) || <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.contains(name.toLowerCase()))</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;}</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div>
<div class="line"><a name="l00341"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ab38583558abb3b05813127987a2b1426">  341</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ab38583558abb3b05813127987a2b1426">CityManagerImplementation::promptCitySpecialization</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        <span class="comment">//if (city-&gt;getCityRank() &lt; CityRegion::RANK_TOWNSHIP) {</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="comment">//mayor-&gt;sendSystemMessage(&quot;@city/city:no_rank_spec&quot;); //Your city must be at least rank 3 before you can set a specialization</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="comment">//return;</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="comment">//}</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        <span class="keywordflow">if</span> (!mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a00d3ae68696c723a5c492034584c981d">checkCooldownRecovery</a>(<span class="stringliteral">&quot;city_specialization&quot;</span>)) {</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;spec_time&quot;</span>); <span class="comment">//You can&#39;t set another city spec right now. Time Remaining: %TO</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                Time* timeRemaining = mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad5a0e79832f01f0b233d75e33b83f5cf">getCooldownTime</a>(<span class="stringliteral">&quot;city_specialization&quot;</span>);</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                params.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                                String::valueOf(</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                                                round(abs(timeRemaining-&gt;miliDifference() / 1000.f)))</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                                                + <span class="stringliteral">&quot; seconds&quot;</span>);</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(params);</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        }</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        ManagedReference&lt;CitySpecializationSession*&gt; session =</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                        <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sessions_1_1_city_specialization_session.html">CitySpecializationSession</a>(mayor, city, terminal);</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#aa2090f0934065e8c52d2841d9540ddd4">addActiveSession</a>(<a class="code" href="class_session_facade_type.html#a72fdb7f3768e8edc4f8610d2bf4ac181">SessionFacadeType::CITYSPEC</a>, session);</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        session-&gt;initializeSession();</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;}</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div>
<div class="line"><a name="l00366"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a91ded41f11c81386034d12ee5b03545d">  366</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a91ded41f11c81386034d12ee5b03545d">CityManagerImplementation::changeCitySpecialization</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor, <span class="keyword">const</span> String&amp; spec) {</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        Locker _clock(city, mayor);</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a8e6a2ca2b834129d98c7696a81652911">setCitySpecialization</a>(spec);</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="preprocessor">#ifndef CITY_DEBUG</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;<span class="preprocessor"></span>        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a9267544fb30b04445f5b2933f4b11907">addCooldown</a>(<span class="stringliteral">&quot;city_specialization&quot;</span>, <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a923b352a8a782a1b3e8de39e3f4b95fe">citySpecializationCooldown</a>); <span class="comment">//1 week.</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="preprocessor"></span>        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;spec_set&quot;</span>); <span class="comment">//The city&#39;s specialization has been set to %TO.</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        params.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(spec);</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(params);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;        <a class="code" href="class_citizen_list.html">CitizenList</a>* cityMilitia = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a5af0e107e2bbe4fa51ad899496513f97">getMilitiaMembers</a>();</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        SortedVector&lt;uint64&gt; militiaMembers;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        <span class="comment">//Resetting the city radius will remove it and reinsert it, updating it to everything in the area.</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; cityMilitia-&gt;size(); ++i) {</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                militiaMembers.put(cityMilitia-&gt;get(i));</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        }</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a41aedb5573c8cc6c81ddbc48ddd1048c">setRadius</a>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a3b40000e39fee269b14c46d91eeb188c">getRadius</a>());</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; militiaMembers.size(); ++i) {</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a1154da55b449deae66073193a3f8c50c">addMilitiaMember</a>(militiaMembers.get(i));</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        }</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;}</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;</div>
<div class="line"><a name="l00396"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a8c789ecdd52ac889fc0e3fe627a5fb2d">  396</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a8c789ecdd52ac889fc0e3fe627a5fb2d">CityManagerImplementation::sendStatusReport</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        <span class="comment">/* Status Report - Lists basic information about the city.</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">         * Shows the city name, current Mayor, the waypoint for the city,</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="comment">         * the city radius, number of citizens, number of structures in the city, the city specialization,</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment">         * tax information, and the travel cost.</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;        ManagedReference&lt;SuiListBox*&gt; list = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(creature,</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                        <a class="code" href="class_sui_window_type.html#ac1be144f90bd928410a113c266a7e4f3">SuiWindowType::CITY_STATUS_REPORT</a>, 0x00);</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        list-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:city_info_t&quot;</span>); <span class="comment">//City Status Report</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        list-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:city_info_d&quot;</span>); <span class="comment">//A report of the current city follows.</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        list-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        list-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;        ManagedReference&lt;SceneObject*&gt; mayor = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>());</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        list-&gt;addMenuItem(<span class="stringliteral">&quot;@city/city:name_prompt &quot;</span> + city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>()); <span class="comment">//Name:</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;        <span class="keywordflow">if</span> (mayor != NULL)</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                list-&gt;addMenuItem(</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                                <span class="stringliteral">&quot;@city/city:mayor_prompt &quot;</span> + mayor-&gt;getDisplayedName()); <span class="comment">//Mayor:</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        StringBuffer location;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        location &lt;&lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0806f9e67b556b86442a5ad5d2b4d652">getPositionX</a>() &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ae3c1e84fd1e6d63d899a1110a8c8a3a9">getPositionY</a>();</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        list-&gt;addMenuItem(<span class="stringliteral">&quot;@city/city:location_prompt &quot;</span> + location.toString()); <span class="comment">//Location:</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        list-&gt;addMenuItem(</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                        <span class="stringliteral">&quot;@city/city:radius_prompt &quot;</span> + String::valueOf(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a3b40000e39fee269b14c46d91eeb188c">getRadius</a>())); <span class="comment">//Radius:</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        list-&gt;addMenuItem(</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                        <span class="stringliteral">&quot;@city/city:reg_citizen_prompt &quot;</span> + String::valueOf(</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa6caecdd8107e0a89f219c72f939a449">getCitizenCount</a>())); <span class="comment">//Registered Citizens:</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;        list-&gt;addMenuItem(</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                        <span class="stringliteral">&quot;@kb/kb_player_cities_n:civic_structures_n &quot;</span> + String::valueOf(</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                                         city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa13d95546a90b2bb1b8530db6f3fcc0e">getStructuresCount</a>())); <span class="comment">//Structures:</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        <span class="comment">//Show total number of all structures for debugging purposes</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <span class="comment">// TODO: Remove</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        list-&gt;addMenuItem(</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                        <span class="stringliteral">&quot;@city/city:structures_prompt &quot;</span> + String::valueOf(</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a70c9899ed731ba749a36bb83d44c18eb">getAllStructuresCount</a>())); <span class="comment">//Structures:</span></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;        list-&gt;addMenuItem(</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                        <span class="stringliteral">&quot;@city/city:decorations &quot;</span> + String::valueOf(</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aac874fe482ee7ca468ecb41d603b532a">getDecorationCount</a>())); <span class="comment">// Decorations</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        list-&gt;addMenuItem(</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                        <span class="stringliteral">&quot;@city/city:specialization_prompt &quot;</span> + city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#af04b8f1d4e6cf8b5f2fecce013b8a438">getCitySpecialization</a>()); <span class="comment">//Specialization:</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a237d57a92e7fc9be9c859bb0e7118118">cityTaxes</a>.size(); ++i) {</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                <a class="code" href="class_city_tax.html">CityTax</a>* cityTax = &amp;<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a237d57a92e7fc9be9c859bb0e7118118">cityTaxes</a>.get(i);</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                <span class="keywordtype">int</span> tax = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad75b644dcefcee69fb2d04bc066d57eb">getTax</a>(i);</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                String prompt = cityTax-&gt;<a class="code" href="class_city_tax.html#a575fd08dc25ebdca802a86aa3bf27094">getStatusPrompt</a>();</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                <span class="keywordflow">if</span> (prompt.isEmpty())</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                list-&gt;addMenuItem(prompt + <span class="stringliteral">&quot; &quot;</span> + String::valueOf(tax));</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        }</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        <span class="comment">//TODO: Tax information and travel cost.</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(list-&gt;generateMessage());</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;}</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div>
<div class="line"><a name="l00461"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a96ab98cdcbbfb16af21def6869cccf31">  461</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a96ab98cdcbbfb16af21def6869cccf31">CityManagerImplementation::sendStructureReport</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        Locker clocker(city);</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        ManagedReference&lt;SuiListBox*&gt; maintList = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(creature,</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                        <a class="code" href="class_sui_window_type.html#a28d1c9f0547f66def0bcf6e492c16f64">SuiWindowType::CITY_TREASURY_REPORT</a>);</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        maintList-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:structure_list_d&quot;</span>);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa13d95546a90b2bb1b8530db6f3fcc0e">getStructuresCount</a>(); i++) {</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;                ManagedReference&lt;StructureObject*&gt; structure = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa93555dd8ca38b76fb752a883248a1b3">getCivicStructure</a>(</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                                i);</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                <span class="keywordflow">if</span> (structure != NULL)</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                        maintList-&gt;addMenuItem(</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;                                        structure-&gt;getDisplayedName() + <span class="stringliteral">&quot; - Condition : &quot;</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;                                                        + String::valueOf(</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                                                                        (1.0f * structure-&gt;getMaxCondition()</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                                                                                        - structure-&gt;getConditionDamage())</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                                                                                        / structure-&gt;getMaxCondition()</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;                                                                                        * 100) + <span class="stringliteral">&quot;%&quot;</span>, i);</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        }</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aac874fe482ee7ca468ecb41d603b532a">getDecorationCount</a>(); i++) {</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                ManagedReference&lt;StructureObject*&gt; deco = cast&lt;StructureObject*&gt; (</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ab5d8853aaf48f02823e05630818d8748">getCityDecoration</a>(i));</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                <span class="keywordflow">if</span> (deco != NULL)</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                        maintList-&gt;addMenuItem(</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                                        deco-&gt;getDisplayedName() + <span class="stringliteral">&quot; - Condition : &quot;</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                                        + String::valueOf(</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                                                        (1.0f * deco-&gt;getMaxCondition()</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;                                                                        - deco-&gt;getConditionDamage())</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                                                                        / deco-&gt;getMaxCondition()</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                                                                        * 100) + <span class="stringliteral">&quot;%&quot;</span>, i);</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        }</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a7154531890864f9e6cc348d32caad0a8">addSuiBox</a>(maintList);</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(maintList-&gt;generateMessage());</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;}</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div>
<div class="line"><a name="l00506"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a45bdbc7ef80e075a55cfe0e296b4d285">  506</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a45bdbc7ef80e075a55cfe0e296b4d285">CityManagerImplementation::promptWithdrawCityTreasury</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keywordflow">if</span> (!city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0c5202dda669ec9be2e86cc8055d5ea1">isMayor</a>(mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>()))</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="keywordflow">if</span> (!mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a00d3ae68696c723a5c492034584c981d">checkCooldownRecovery</a>(<span class="stringliteral">&quot;city_withdrawal&quot;</span>)</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                        &amp;&amp; !mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>()-&gt;isPrivileged()) {</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:withdraw_daily&quot;</span>); <span class="comment">//You may only withdraw from the city treasury once per day.</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        }</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        ManagedReference&lt;CityTreasuryWithdrawalSession*&gt; session =</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;                        <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sessions_1_1_city_treasury_withdrawal_session.html">CityTreasuryWithdrawalSession</a>(mayor, city, terminal);</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#aa2090f0934065e8c52d2841d9540ddd4">addActiveSession</a>(<a class="code" href="class_session_facade_type.html#a43914e6d3b9017d792259c4a1a165065">SessionFacadeType::CITYWITHDRAW</a>, session);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        session-&gt;initializeSession();</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;}</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div>
<div class="line"><a name="l00523"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ab977956ea02d004ff4e2f5a3f18fcb4f">  523</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ab977956ea02d004ff4e2f5a3f18fcb4f">CityManagerImplementation::withdrawFromCityTreasury</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor, <span class="keywordtype">int</span> value, <span class="keyword">const</span> String&amp; reason, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a365c80b4b636af52d9d69c95ec375205">getCityTreasury</a>() &lt;= 0) {</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:no_money&quot;</span>); <span class="comment">//There isn&#39;t any money to transfer!</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        }</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        ManagedReference&lt;CityTreasuryWithdrawalSession*&gt;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                        session =</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                                        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a574a6ad43037b1d25e948c9cdb21be18">getActiveSession</a>(<a class="code" href="class_session_facade_type.html#a43914e6d3b9017d792259c4a1a165065">SessionFacadeType::CITYWITHDRAW</a>).castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sessions_1_1_city_treasury_withdrawal_session.html">CityTreasuryWithdrawalSession</a>*&gt;();</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <span class="keywordflow">if</span> (session == NULL)</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <span class="keywordflow">if</span> (!mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a00d3ae68696c723a5c492034584c981d">checkCooldownRecovery</a>(<span class="stringliteral">&quot;city_withdrawal&quot;</span>)</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                        &amp;&amp; !mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>()-&gt;isPrivileged()) {</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:withdraw_daily&quot;</span>); <span class="comment">//You may only withdraw from the city treasury once per day.</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                session-&gt;cancelSession();</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        }</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="keywordtype">int</span> maxWithdrawal = MIN(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#afb2e5b304e42c30475d23443074f1555">getMaxWithdrawal</a>(), city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a365c80b4b636af52d9d69c95ec375205">getCityTreasury</a>());</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        <span class="keywordflow">if</span> (value &lt; 0) {</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:withdraw_treasury&quot;</span>); <span class="comment">//You must select a positive amount to withdraw from the treasury.</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                session-&gt;cancelSession();</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;        }</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        <span class="keywordflow">if</span> (value &gt; maxWithdrawal) {</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:withdraw_treasury_error&quot;</span>); <span class="comment">//Unable to complete withdraw. Please try again.</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                session-&gt;cancelSession();</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        }</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a8aec8bbd499984291aeb0bc7ccfd18b0">addBankCredits</a>(value, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a81104254cd7036ea2e674fa47ca92cf7">subtractFromCityTreasury</a>(value);</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a9267544fb30b04445f5b2933f4b11907">addCooldown</a>(<span class="stringliteral">&quot;city_withdrawal&quot;</span>,</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a16c62c9c1da1be45848fd0b2f76501b1">CityManagerImplementation::treasuryWithdrawalCooldown</a>);</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        session-&gt;cancelSession();</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        <span class="comment">//tODO: Send some message about receiving credits.</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> emailBody(<span class="stringliteral">&quot;@city/city:treasury_withdraw_body&quot;</span>);</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#aa35ce7d0a7a3b96baff3e88100b3f5f8">setDI</a>(value);</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(mayor);</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#a46d29e48d6738ce32cc73e6e7225bdf7">setTT</a>(reason);</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        Locker clock(city, mayor);</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa31cb49656b2d044e646c23d2074bcea">sendMail</a>(city, <span class="stringliteral">&quot;@city/city:treasury_withdraw_from&quot;</span>, <span class="stringliteral">&quot;@city/city:treasury_withdraw&quot;</span>,</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                        emailBody, NULL);</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;}</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div>
<div class="line"><a name="l00584"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7f16644fa9b71fc833d2fe28ea932052">  584</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7f16644fa9b71fc833d2fe28ea932052">CityManagerImplementation::promptDepositCityTreasury</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        ManagedReference&lt;SuiTransferBox*&gt; transfer = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_transfer_box.html">SuiTransferBox</a>(creature,</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                        <a class="code" href="class_sui_window_type.html#afa028a2bb9ec3edab78b3583626a75c7">SuiWindowType::CITY_TREASURY_DEPOSIT</a>);</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        transfer-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:treasury_deposit&quot;</span>); <span class="comment">//Treasury Deposit</span></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        transfer-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:treasury_deposit_d&quot;</span>); <span class="comment">//Enter the amount you would like to transfer to the treasury.</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        transfer-&gt;addFrom(<span class="stringliteral">&quot;@city/city:total_funds&quot;</span>,</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;                        String::valueOf(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a3e78db552e8aa8f9e5e81d72d88f3b73">getCashCredits</a>()),</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                        String::valueOf(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a3e78db552e8aa8f9e5e81d72d88f3b73">getCashCredits</a>()), <span class="stringliteral">&quot;1&quot;</span>);</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        transfer-&gt;addTo(<span class="stringliteral">&quot;@city/city:treasury&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>);</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        transfer-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        transfer-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        transfer-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_city_treasury_deposit_sui_callback.html">CityTreasuryDepositSuiCallback</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>, city));</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a7154531890864f9e6cc348d32caad0a8">addSuiBox</a>(transfer);</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(transfer-&gt;generateMessage());</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;}</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;</div>
<div class="line"><a name="l00607"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a53728b4ad945e724dc750b3a1a7adae7">  607</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a53728b4ad945e724dc750b3a1a7adae7">CityManagerImplementation::depositToCityTreasury</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <span class="keywordtype">int</span> amount) {</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        <span class="keywordtype">int</span> cash = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a3e78db552e8aa8f9e5e81d72d88f3b73">getCashCredits</a>();</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        <span class="keywordtype">int</span> total = cash - amount;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        <span class="keywordflow">if</span> (total &lt; 1 || amount &gt; cash) {</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:positive_deposit&quot;</span>); <span class="comment">//You must select a positive amount to transfer to the treasury.</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        }</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        <span class="comment">//if (total &gt; creature-&gt;getCashCredits()) {</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        <span class="comment">//Player doesn&#39;t have that many credits</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        <span class="comment">//return;</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="comment">//}</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ae0727f1e54814b4cb4a40c193e092b99">addToCityTreasury</a>(total);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a403e0ac095a11784dc1daa3db8cba351">subtractCashCredits</a>(total);</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;deposit_treasury&quot;</span>); <span class="comment">//You deposit %DI credits into the treasury.</span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        params.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#aa35ce7d0a7a3b96baff3e88100b3f5f8">setDI</a>(total);</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(params);</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;}</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div>
<div class="line"><a name="l00631"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a841fbf5010f97bf193a91a67a698d174">  631</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a841fbf5010f97bf193a91a67a698d174">CityManagerImplementation::sendCitizenshipReport</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        <span class="comment">//Check if they already have the window open.</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        <span class="keywordflow">if</span> (ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a28e55f1da8ea7d975b8a2d9d3c68550a">hasSuiBoxWindowType</a>(<a class="code" href="class_sui_window_type.html#ac030c54711db3b1588cbf4acd9c76bbf">SuiWindowType::CITY_CITIZEN_REPORT</a>))</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        ManagedReference&lt;SuiListBox*&gt; listbox = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(creature,</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                        <a class="code" href="class_sui_window_type.html#ac030c54711db3b1588cbf4acd9c76bbf">SuiWindowType::CITY_CITIZEN_REPORT</a>);</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        listbox-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:citizen_list_t&quot;</span>); <span class="comment">//City Citizenship Report</span></div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        listbox-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:citizen_list_d&quot;</span>); <span class="comment">//The following is a list of the currently declared citizens (residents) of this city. All citizens are elligible to vote.</span></div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        listbox-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        listbox-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        <a class="code" href="class_citizen_list.html">CitizenList</a>* citizenList = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a4b20894db20b3255da35b65f2b93a24b">getCitizenList</a>();</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; citizenList-&gt;size(); ++i) {</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                ManagedReference&lt;SceneObject*&gt; citizen = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                                citizenList-&gt;get(i));</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                <span class="keywordflow">if</span> (citizen != NULL) {</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                        String name = citizen-&gt;getDisplayedName();</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#af015eddbca57218902c4f68722146529">isMilitiaMember</a>(citizen-&gt;getObjectID()))</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                                name += <span class="stringliteral">&quot; (Militia)&quot;</span>;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                        listbox-&gt;addMenuItem(name);</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                }</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        }</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a7154531890864f9e6cc348d32caad0a8">addSuiBox</a>(listbox);</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(listbox-&gt;generateMessage());</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;}</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div>
<div class="line"><a name="l00669"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a96c07fa265b025c57bbba9bde5060680">  669</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a96c07fa265b025c57bbba9bde5060680">CityManagerImplementation::processCityUpdate</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city) {</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;        info(<span class="stringliteral">&quot;Processing city update: &quot;</span> + city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        <span class="keywordtype">int</span> cityRank;</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        <span class="keywordtype">float</span> radius;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                cityRank = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>();</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;                <span class="keywordflow">if</span> (cityRank == <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a14f3ad6202f487f689b5d3db3d82dfd0">CLIENT</a>)</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                        <span class="keywordflow">return</span>; <span class="comment">//It&#39;s a client region.</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                radius = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a3b40000e39fee269b14c46d91eeb188c">getRadius</a>();</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        } <span class="keywordflow">catch</span> (Exception&amp; e) {</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                error(</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;                                e.getMessage()</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;                                                + <span class="stringliteral">&quot;in CityManagerImplementation::processCityUpdate&quot;</span>);</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        }</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        Locker <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a1393454953396e85abca95f96e53002b">lock</a>(city);</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a7bc938c2ff7cc44feba04c76a92f78c7">cleanupCitizens</a>();</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        <span class="keywordtype">int</span> citizens = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa6caecdd8107e0a89f219c72f939a449">getCitizenCount</a>();</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <span class="keywordflow">if</span> (cityRank - 1 &gt;= <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7843d372fff4f95966d6b40365bda53c">citizensPerRank</a>.size())</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;        <span class="keywordtype">int</span> maintainCitizens = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7843d372fff4f95966d6b40365bda53c">citizensPerRank</a>.get(cityRank - 1);</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        <span class="keywordflow">if</span> (citizens &lt; maintainCitizens) {</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;                <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a65e7d04b97721c169d4c9cc38f1be387">contractCity</a>(city);</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cityRank &lt; <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a8ed5cca987f59248cd6e04f5b3e5079a">METROPOLIS</a>) {</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;                <span class="keywordtype">int</span> advanceCitizens = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7843d372fff4f95966d6b40365bda53c">citizensPerRank</a>.get(cityRank);</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                <span class="keywordflow">if</span> (citizens &gt;= advanceCitizens)</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd8c58cb1865d1e4bc2fbdbe62b871d9">expandCity</a>(city);</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        }</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa613392b7f2546036715ef06d656da58">updateCityVoting</a>(city);</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        ManagedReference&lt;SceneObject*&gt; mayor = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>());</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        <span class="keywordflow">if</span> (mayor != NULL &amp;&amp; mayor-&gt;isPlayerCreature()) {</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                Reference&lt;PlayerObject*&gt; ghost =</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                                mayor-&gt;getSlottedObject(<span class="stringliteral">&quot;ghost&quot;</span>).castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>*&gt; ();</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#ac71e2c1717091e3cc64f7bbac238c6f1">addExperience</a>(<span class="stringliteral">&quot;political&quot;</span>, 750, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        }</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a548d07c7b86e21dc156ce72ce8e10558">rescheduleUpdateEvent</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a58a6fcf5e6ea07c6e2f6b6354e8e3358">cityUpdateInterval</a> * 60);</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#acafd328cd016082d242993dc40af5d4b">processIncomeTax</a>(city);</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a3dce981980e487a30a05740e89b56657">cleanupDuplicateCityStructures</a>();</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        <span class="keywordflow">if</span>( city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aac874fe482ee7ca468ecb41d603b532a">getDecorationCount</a>() &gt; (<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#acff7e85fe64edea54512de7904f1b99e">decorationsPerRank</a> * city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>())){</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aaa5824116da8ea476b67b25a43de8d19">cleanupDecorations</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#acff7e85fe64edea54512de7904f1b99e">decorationsPerRank</a> * city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>());</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        }</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa9353f32720eb52d907ee597e0d1db2d">deductCityMaintenance</a>(city);</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;}</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;</div>
<div class="line"><a name="l00735"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#acafd328cd016082d242993dc40af5d4b">  735</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#acafd328cd016082d242993dc40af5d4b">CityManagerImplementation::processIncomeTax</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city) {</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        <span class="keywordtype">int</span> incomeTax = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a26c734b76aefb64b48d2e0efc0920c43">getIncomeTax</a>();</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;        <span class="keywordflow">if</span> (incomeTax &lt;= 0)</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        ManagedReference&lt;SceneObject*&gt; mayorObject = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>());</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        <span class="keywordflow">if</span> (mayorObject == NULL || !mayorObject-&gt;isPlayerCreature()) {</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                error(</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                                <span class="stringliteral">&quot;Mayor is null or not set in process income tax for city: &quot;</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                                                + city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        }</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor = mayorObject.castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>*&gt; ();</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;        String mayorName = mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>();</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        <a class="code" href="class_citizen_list.html">CitizenList</a>* citizens = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a4b20894db20b3255da35b65f2b93a24b">getCitizenList</a>();</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        Reference&lt;TaxPayMailTask*&gt; task = <span class="keyword">new</span> <a class="code" href="class_tax_pay_mail_task.html">TaxPayMailTask</a>(incomeTax, mayorName,</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                        chatManager, city);</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; citizens-&gt;size(); ++i) {</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                uint64 oid = citizens-&gt;get(i);</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                ManagedReference&lt;SceneObject*&gt; obj = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(oid);</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;                <span class="keywordflow">if</span> (obj == NULL || !obj-&gt;isPlayerCreature())</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* citizen = obj.castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>*&gt; ();</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;                task-&gt;addCitizen(citizen);</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        }</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        task-&gt;execute();</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;}</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="comment">// pay city hall first</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;<span class="comment">// next pay civic structures</span></div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;</div>
<div class="line"><a name="l00780"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa9353f32720eb52d907ee597e0d1db2d">  780</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa9353f32720eb52d907ee597e0d1db2d">CityManagerImplementation::deductCityMaintenance</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city) {</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        <span class="keywordtype">int</span> totalPaid = 0;</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        Locker _lock(city);</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        <span class="comment">// pay city hall maintenanance first</span></div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        <a class="code" href="class_template_manager.html">TemplateManager</a>* templateManager = TemplateManager::instance();</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        <span class="keywordflow">if</span> (templateManager == NULL)</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        ManagedReference&lt;StructureObject*&gt; ch = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a471c584ed2befda8a2d9e9ca1287cb4e">getCityHall</a>();</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;        <span class="keywordflow">if</span> (ch == NULL || ch-&gt;getObjectTemplate() == NULL)</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        Reference&lt;SharedStructureObjectTemplate*&gt; structureTemplate = cast&lt;</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;                        <a class="code" href="class_shared_structure_object_template.html">SharedStructureObjectTemplate</a>*&gt; (ch-&gt;getObjectTemplate());</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <span class="keywordflow">if</span> (structureTemplate == NULL)</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        <span class="keywordtype">int</span> thisCost = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> * structureTemplate-&gt;getCityMaintenanceAtRank(</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>() - 1);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#af04b8f1d4e6cf8b5f2fecce013b8a438">getCitySpecialization</a>() != <span class="stringliteral">&quot;&quot;</span>) {</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;                <a class="code" href="class_city_specialization.html">CitySpecialization</a>* spec = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abef3f0a0193809488108f3285cd34fee">getCitySpecialization</a>(</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;                                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#af04b8f1d4e6cf8b5f2fecce013b8a438">getCitySpecialization</a>());</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                <span class="keywordflow">if</span> (spec != NULL)</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                        thisCost += spec-&gt;<a class="code" href="class_city_specialization.html#ae006c9f8a85002311153eb6380da90e8">getCost</a>();</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        }</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        <span class="keywordflow">if</span>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad56c53a132122899eb6ddda90cf7e3b4">isRegistered</a>())</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                thisCost += 5000;</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        <span class="comment">//info(&quot;should pay &quot; + String::valueOf(thisCost),true);</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;        <span class="keywordtype">int</span> lastPaid = 0;</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        lastPaid = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a3380612015b20ad08e3f42ae2c5364cf">collectCivicStructureMaintenance</a>(ch, city, thisCost);</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        totalPaid += lastPaid;</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa13d95546a90b2bb1b8530db6f3fcc0e">getStructuresCount</a>(); i++){</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                ManagedReference&lt;StructureObject*&gt; str = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa93555dd8ca38b76fb752a883248a1b3">getCivicStructure</a>(i);</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                <span class="keywordflow">if</span>(str != NULL &amp;&amp; str != ch){</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                        structureTemplate = cast&lt;SharedStructureObjectTemplate*&gt; (str-&gt;getObjectTemplate());</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                        thisCost = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> * structureTemplate-&gt;getCityMaintenanceAtRank(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>() - 1);</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;                        <span class="comment">//info(&quot;maint on &quot; + str-&gt;getObjectNameStringIdName() + &quot; &quot; + String::valueOf(thisCost),true);</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;                        totalPaid += <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a3380612015b20ad08e3f42ae2c5364cf">collectCivicStructureMaintenance</a>(str, city, thisCost);</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                }</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        }</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aac874fe482ee7ca468ecb41d603b532a">getDecorationCount</a>() - 1; i &gt;= 0; i--){</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                ManagedReference&lt;SceneObject*&gt; decoration = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ab5d8853aaf48f02823e05630818d8748">getCityDecoration</a>(i);</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;                <span class="keywordflow">if</span>(decoration == NULL)</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;                <span class="keywordflow">if</span>( decoration-&gt;isStructureObject()){</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;                        <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure = cast&lt;StructureObject*&gt;(decoration.get());</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                        <span class="keywordflow">if</span>(structure != NULL){</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                                structureTemplate = cast&lt;SharedStructureObjectTemplate*&gt;(structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a49977bbe7ffeb660df3173c94421068b">getObjectTemplate</a>());</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                                thisCost = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> * structureTemplate-&gt;getCityMaintenanceAtRank(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>() - 1);</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                                totalPaid += <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a3380612015b20ad08e3f42ae2c5364cf">collectCivicStructureMaintenance</a>(structure, city, thisCost);</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                        }</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                        thisCost = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> * 1500;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                        totalPaid += <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#afc46659464a64620af2bc1d3cdac744c">collectNonStructureMaintenance</a>(decoration, city, thisCost);</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;                }</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        }</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a4b347ca199a62a035b87c509cab1cbb4">getMissionTerminalCount</a>() - 1; i &gt;= 0; i--){</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;                totalPaid += <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#afc46659464a64620af2bc1d3cdac744c">collectNonStructureMaintenance</a>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a2d919f46e00bfa81405beb4a095cb98d">getCityMissionTerminal</a>(i), city, 1500);</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;        }</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a1909bfc6ff4c1976edc852b9121e4626">getSkillTrainerCount</a>() -1; i &gt;=0; i--){</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;                totalPaid += <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#afc46659464a64620af2bc1d3cdac744c">collectNonStructureMaintenance</a>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#af029271a23f82bb97fefe096bb530d0d">getCitySkillTrainer</a>(i), city, 1500);</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        }</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a5c399ca9221826a4c007b5663f24cfb9">sendMaintenanceEmail</a>(city, totalPaid);</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;}</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;</div>
<div class="line"><a name="l00870"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#afc46659464a64620af2bc1d3cdac744c">  870</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#afc46659464a64620af2bc1d3cdac744c">CityManagerImplementation::collectNonStructureMaintenance</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* <span class="keywordtype">object</span>, <a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city, <span class="keywordtype">int</span> maintenanceDue){</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        <span class="keywordflow">if</span>(<span class="keywordtype">object</span> == NULL || city == NULL)</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        <span class="keywordtype">int</span> amountPaid = 0;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;        <span class="keywordflow">if</span>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a365c80b4b636af52d9d69c95ec375205">getCityTreasury</a>() &gt;= maintenanceDue){</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a81104254cd7036ea2e674fa47ca92cf7">subtractFromCityTreasury</a>(maintenanceDue);</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;                amountPaid = maintenanceDue;</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;                Locker clock(<span class="keywordtype">object</span>,city);</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;                <span class="comment">// can probably be moved to cityregion notifyExit</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                <span class="keywordflow">if</span>(object-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ab17367b6d362e6937a63e804ba786c5f">isMissionTerminal</a>())</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a30405c7498511f86474fa5d4a2f3da">removeMissionTerminal</a>(<span class="keywordtype">object</span>);</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (object-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ab1f0853628db2f1ddb6b5947292ca5e0">isDecoration</a>())</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a533fe02101d4d796e564c187e00bfe7a">removeDecoration</a>(<span class="keywordtype">object</span>);</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (object-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a15243e0ebb0b13d048aadc3da4b3a441">isCreatureObject</a>())</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a2ad39236d1fc2ed9ed32e59eff9d57d6">removeSkillTrainers</a>(<span class="keywordtype">object</span>);</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;                <span class="keywordtype">object</span>-&gt;destroyObjectFromWorld(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                <span class="keywordtype">object</span>-&gt;destroyObjectFromDatabase();</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        }</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        <span class="keywordflow">return</span> amountPaid;</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;}</div>
<div class="line"><a name="l00896"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a3380612015b20ad08e3f42ae2c5364cf">  896</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a3380612015b20ad08e3f42ae2c5364cf">CityManagerImplementation::collectCivicStructureMaintenance</a>(</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure, <a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city, <span class="keywordtype">int</span> maintenanceDue) {</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        <span class="keywordtype">int</span> amountPaid = 0;</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a365c80b4b636af52d9d69c95ec375205">getCityTreasury</a>() &gt;= maintenanceDue) {</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                <span class="comment">//info(&quot;paid in full&quot;,true);</span></div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                <span class="comment">// we have enough to pay the full amount.  subtract from city</span></div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a81104254cd7036ea2e674fa47ca92cf7">subtractFromCityTreasury</a>(maintenanceDue);</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                amountPaid = maintenanceDue;</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                <span class="comment">// now try to fix the surplus maintenance if the CH is decayed</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                <span class="keywordtype">int</span> amountOwed = abs(structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a3669b3cc362d7836a17638d07090d68b">getSurplusMaintenance</a>());</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;                <span class="keywordflow">if</span> (amountOwed &gt; 0) {</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a365c80b4b636af52d9d69c95ec375205">getCityTreasury</a>() &gt;= amountOwed) {</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                                <span class="comment">//info(&quot;paid off old debt too&quot;,true);</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a81104254cd7036ea2e674fa47ca92cf7">subtractFromCityTreasury</a>(amountOwed);</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                                structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#a0181514dd0927a31a438548a81bce620">setConditionDamage</a>(0);</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                                structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a13674df7ce0b1caf43381f5a4f4ec815">setSurplusMaintenance</a>(0);</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                                amountPaid += amountOwed;</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;                                <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a65abef60d77b348ef28f57d793107c71">sendMaintenanceRepairEmail</a>(city,structure);</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                                <span class="comment">// pay what you the city can afford on what it owes</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                                <span class="keywordtype">int</span> currentDecay = structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#a428ffc550954c07ad0069e7fe3090043">getConditionDamage</a>();</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                                <span class="keywordflow">if</span>(currentDecay &gt; 0 &amp;&amp; amountOwed &gt; 0){</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;                                        <span class="keywordtype">int</span> availableFunds = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a365c80b4b636af52d9d69c95ec375205">getCityTreasury</a>();</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                                        <span class="keywordtype">float</span> costPerUnitCondition = amountOwed / currentDecay;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                                        <span class="keywordtype">int</span> pointsBack = availableFunds / costPerUnitCondition;</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                                        <span class="comment">//info(&quot;we could only get &quot; + String::valueOf(pointsBack) + &quot; back&quot;,true);</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                                        currentDecay -= pointsBack;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                                        <span class="keywordflow">if</span>(pointsBack &gt; 0)</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                                                <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a65abef60d77b348ef28f57d793107c71">sendMaintenanceRepairEmail</a>(city,structure);</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a81104254cd7036ea2e674fa47ca92cf7">subtractFromCityTreasury</a>(availableFunds);</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;                                        structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#a0181514dd0927a31a438548a81bce620">setConditionDamage</a>(currentDecay);</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                                        structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a13674df7ce0b1caf43381f5a4f4ec815">setSurplusMaintenance</a>(-(amountOwed - availableFunds));</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                                }</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;                        }</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;                }</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                <span class="comment">// pay what we can then decay it</span></div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                <span class="comment">// full maint should deduct 20%</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                <span class="keywordtype">int</span> currentDecay = structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#a428ffc550954c07ad0069e7fe3090043">getConditionDamage</a>();</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;                <span class="keywordtype">int</span> fundsAvailable = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a365c80b4b636af52d9d69c95ec375205">getCityTreasury</a>();</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                <span class="keywordtype">float</span> amountOutstanding = maintenanceDue - fundsAvailable;</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                <span class="keywordtype">int</span> currentSurplus = structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a3669b3cc362d7836a17638d07090d68b">getSurplusMaintenance</a>();</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;                <span class="keywordtype">int</span> newDecay = (1.0f * amountOutstanding) / maintenanceDue</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;                                * structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#a985259c0122f5bac513a5654539ffcf0">getMaxCondition</a>() * .25;</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;                currentSurplus -= amountOutstanding;</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;                currentDecay += newDecay;</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                <span class="comment">//info(&quot;could not pay any maint.  decaying by &quot; + String::valueOf(newDecay),true);</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;                structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a13674df7ce0b1caf43381f5a4f4ec815">setSurplusMaintenance</a>(currentSurplus);</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;                structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#a0181514dd0927a31a438548a81bce620">setConditionDamage</a>(currentDecay);</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a81104254cd7036ea2e674fa47ca92cf7">subtractFromCityTreasury</a>(fundsAvailable);</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                amountPaid += fundsAvailable;</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af29b5d23ccffa819e8ec7b1017c990b7">sendMaintenanceDecayEmail</a>(city, structure, maintenanceDue);</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        }</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        <span class="keywordflow">if</span> (structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#a428ffc550954c07ad0069e7fe3090043">getConditionDamage</a>() &gt;= structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#a985259c0122f5bac513a5654539ffcf0">getMaxCondition</a>()) {</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a077916ce4587c845367c0c2a497d9ec5">sendMaintenanceDestroyEmail</a>(city, structure);</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                        StructureManager::instance()-&gt;destroyStructure(structure);</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        }</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        <span class="keywordflow">return</span> amountPaid;</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;}</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;</div>
<div class="line"><a name="l00979"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a5c399ca9221826a4c007b5663f24cfb9">  979</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a5c399ca9221826a4c007b5663f24cfb9">CityManagerImplementation::sendMaintenanceEmail</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city, <span class="keywordtype">int</span> maint){</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a> != NULL) {</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;                ManagedReference&lt;CreatureObject*&gt; mayor = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>()).castTo&lt;CreatureObject*&gt;();</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                <span class="keywordflow">if</span>(mayor != NULL) {</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                        <span class="comment">/*</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="comment">                        stringFiles[81].addEntry(&quot;city_maint&quot;, &quot;Maintenance Report&quot;);</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;<span class="comment">                        stringFiles[81].addEntry(&quot;city_maint_body&quot;, &quot;Mayor %TO,A total of %DI credits has been paid from the city treasury for maintenance and upkeep of structures.&quot;);</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="comment">                        stringFiles[81].addEntry(&quot;city_maint_subject&quot;, &quot;City Maintenance Paid&quot;);</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="comment">                        */</span></div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> emailBody(<span class="stringliteral">&quot;@city/city:city_maint_body&quot;</span>);</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                        emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#aa35ce7d0a7a3b96baff3e88100b3f5f8">setDI</a>(maint);</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                        emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(mayor);</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                        Locker clock(mayor, city);</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                        <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                        chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:treasury_withdraw_from&quot;</span>, <span class="stringliteral">&quot;@city/city:city_maint_subject&quot;</span>, emailBody, mayor-&gt;getFirstName(), NULL);</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                }</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        }</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;}</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;</div>
<div class="line"><a name="l01002"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a65abef60d77b348ef28f57d793107c71"> 1002</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a65abef60d77b348ef28f57d793107c71">CityManagerImplementation::sendMaintenanceRepairEmail</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city, <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure){</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a> != NULL) {</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                ManagedReference&lt;CreatureObject*&gt; mayor = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>()).castTo&lt;CreatureObject*&gt;();</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                <span class="keywordflow">if</span>(mayor != NULL) {</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                        <span class="comment">/*</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="comment">                        stringFiles[81].addEntry(&quot;structure_repaired_body&quot;, &quot;Mayor %TO,Repair work has been done on structure %TT.  You can check the structure&#39;s condition in the structure report at the City Management terminal.&quot;);</span></div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="comment">                        stringFiles[81].addEntry(&quot;structure_repaired_subject&quot;, &quot;Structure Repaired&quot;);</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;<span class="comment">                        */</span></div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> emailBody(<span class="stringliteral">&quot;@city/city:structure_repaired_body&quot;</span>);</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                        emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(mayor);</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                        emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#a46d29e48d6738ce32cc73e6e7225bdf7">setTT</a>(structure);</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                        Locker clock(mayor, city);</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                        <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                        chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:treasury_withdraw_from&quot;</span>, <span class="stringliteral">&quot;@city/city:structure_repaired_subject&quot;</span>, emailBody, mayor-&gt;getFirstName(), NULL);</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;                }</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        }</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;}</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;</div>
<div class="line"><a name="l01025"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af29b5d23ccffa819e8ec7b1017c990b7"> 1025</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af29b5d23ccffa819e8ec7b1017c990b7">CityManagerImplementation::sendMaintenanceDecayEmail</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city, <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure, <span class="keywordtype">int</span> maintenanceDue){</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a> != NULL) {</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                ManagedReference&lt;CreatureObject*&gt; mayor = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>()).castTo&lt;CreatureObject*&gt;();</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                        <span class="keywordflow">if</span>(mayor != NULL) {</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                                <span class="comment">/*</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;<span class="comment">                                stringFiles[81].addEntry(&quot;structure_damaged_body&quot;, &quot;Mayor %TT,There was insufficient money to pay for the maintenance of the structure %TO.  The amount required was %DI credits.  The structure has been damaged.  You can check the structure&#39;s condition in the structure report at the City Management terminal.&quot;);</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="comment">                                stringFiles[81].addEntry(&quot;structure_damaged_subject&quot;, &quot;Insufficient Maintenance, Structure Damaged&quot;);</span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;<span class="comment">                                */</span></div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                                <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> emailBody(<span class="stringliteral">&quot;@city/city:structure_damaged_body&quot;</span>);</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;                                emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(structure);</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                                emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#a46d29e48d6738ce32cc73e6e7225bdf7">setTT</a>(mayor);</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                                emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#aa35ce7d0a7a3b96baff3e88100b3f5f8">setDI</a>(maintenanceDue);</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                                Locker clock(mayor, city);</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                                <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                                chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:treasury_withdraw_from&quot;</span>, <span class="stringliteral">&quot;@city/city:structure_damaged_subject&quot;</span>, emailBody, mayor-&gt;getFirstName(), NULL);</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;                        }</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;        }</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;}</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;</div>
<div class="line"><a name="l01049"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a077916ce4587c845367c0c2a497d9ec5"> 1049</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a077916ce4587c845367c0c2a497d9ec5">CityManagerImplementation::sendMaintenanceDestroyEmail</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city, <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure){</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a> != NULL) {</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;                ManagedReference&lt;CreatureObject*&gt; mayor = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>()).castTo&lt;CreatureObject*&gt;();</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;                <span class="keywordflow">if</span>(mayor != NULL) {</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;                        <span class="comment">/*</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;<span class="comment">                        stringFiles[81].addEntry(&quot;structure_destroyed_maint_body&quot;, &quot;Alert Mayor %TO!The structure (or object) %TT was condemned and destroyed due to lack of maintenance!&quot;);</span></div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;<span class="comment">                        stringFiles[81].addEntry(&quot;structure_destroyed_maint_subject&quot;, &quot;Insufficient Maintenance, Structure DESTROYED&quot;);</span></div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;<span class="comment">                        */</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> emailBody(<span class="stringliteral">&quot;@city/city:structure_destroyed_maint_body&quot;</span>);</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;                        emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(mayor);</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;                        emailBody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#a46d29e48d6738ce32cc73e6e7225bdf7">setTT</a>(<span class="stringliteral">&quot;@building_name:&quot;</span> + structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ac9512907e896bceb2529abb091b56853">getObjectNameStringIdName</a>());</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;                        Locker clock(mayor, city);</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                        <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                        chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:treasury_withdraw_from&quot;</span>, <span class="stringliteral">&quot;@city/city:structure_destroyed_maint_subject&quot;</span>, emailBody, mayor-&gt;getFirstName(), NULL);</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                }</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        }</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;}</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;</div>
<div class="line"><a name="l01069"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa613392b7f2546036715ef06d656da58"> 1069</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa613392b7f2546036715ef06d656da58">CityManagerImplementation::updateCityVoting</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                <span class="keywordtype">bool</span> <span class="keyword">override</span>) {</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;        <span class="keywordflow">if</span> (!city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#af26485314808f17ec92f1437f77c3aa0">isVotingPeriodOver</a>() &amp;&amp; !<span class="keyword">override</span>)</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;        VectorMap&lt;uint64, int&gt;* candidates = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a258070dcc9ffa9f25a4f99fe781ce8ef">getCandidates</a>();</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        uint64 incumbentID = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>();</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;        String incumbentName = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        uint64 topCandidate = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>(); <span class="comment">//Incumbent mayor defaults as the top candidate.</span></div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;        <span class="keywordtype">int</span> topVotes = 0;</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;        <span class="comment">//Loop through the candidate votes.</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;        ManagedReference&lt;SceneObject*&gt; oldmayor =</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;                        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(incumbentID);</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;        <span class="keywordflow">if</span> (oldmayor != NULL &amp;&amp; oldmayor-&gt;isPlayerCreature()) {</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayorcreature = cast&lt;CreatureObject*&gt; (oldmayor.get());</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;                <span class="keywordflow">if</span> (mayorcreature != NULL)</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;                        incumbentName = mayorcreature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>();</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        }</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; candidates-&gt;size(); ++i) {</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;                VectorMapEntry&lt;uint64, int&gt; entry = candidates-&gt;elementAt(i);</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;                uint64 candidateID = entry.getKey();</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;                <span class="keywordtype">int</span> votes = entry.getValue();</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;                <span class="comment">//Ensure that each vote is for a valid citizen candidate by a current city citizen.</span></div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;                <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a12545e74ea01ac6c44be8cbe199372a7">isCitizen</a>(candidateID) &amp;&amp; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a4b3996b958b2e7a8ae0b21c62b47453d">isCandidate</a>(candidateID)) {</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;                        ManagedReference&lt;SceneObject*&gt; mayorObject = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;                                        candidateID);</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;                        <span class="keywordflow">if</span> (mayorObject != NULL &amp;&amp; mayorObject-&gt;isPlayerCreature()) {</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;                                Locker _crosslock(mayorObject, city);</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;                                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor = cast&lt;CreatureObject*&gt; (</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;                                                mayorObject.get());</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;                                Reference&lt;PlayerObject*&gt; ghost =</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;                                                mayorObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a849f36343da6cfb8a4e8f1b138669ab1">getSlottedObject</a>(<span class="stringliteral">&quot;ghost&quot;</span>).castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>*&gt; ();</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;                                <span class="comment">//Make sure the candidate is still a politician.</span></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                                <span class="keywordflow">if</span> (mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ab41bcbd8f2c21a96fa9dab007d7e9fa1">hasSkill</a>(<span class="stringliteral">&quot;social_politician_novice&quot;</span>)) {</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                                        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#ac71e2c1717091e3cc64f7bbac238c6f1">addExperience</a>(<span class="stringliteral">&quot;political&quot;</span>, votes * 300, <span class="keyword">true</span>);</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;                                        <span class="keywordflow">if</span> (votes &gt; topVotes) {</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;                                                topCandidate = candidateID;</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;                                                topVotes = votes;</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;                                        }</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;                                }</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;                        }</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;                }</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        }</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;        <span class="comment">//Make them the new mayor.</span></div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a2a20a4c5c3cbeacb5aa2d539364c3889">setMayorID</a>(topCandidate);</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#abf52ad58d75a0915790a5225de80c935">resetMayoralVotes</a>();</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#afa3af2b21bb99fa3d00cbd93397c6184">resetCandidates</a>();</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a870527ff400a4d0fecd6e2e6196c5f84">resetVotingPeriod</a>();</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        <span class="comment">// transfer structures to new mayor</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        <span class="keywordflow">if</span> (incumbentID != topCandidate)</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a48f2508240cc17c4cd04ff48bb882ac7">transferCivicStructuresToMayor</a>();</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;        <span class="comment">// send e-mail to mayors and citizens</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;        ManagedReference&lt;SceneObject*&gt; obj = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(topCandidate);</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor = NULL;</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;        <span class="keywordflow">if</span> (obj != NULL &amp;&amp; obj-&gt;isCreatureObject()) {</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;                mayor = cast&lt;CreatureObject*&gt; (obj.get());</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        }</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;        String winnerName;</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;        <span class="keywordflow">if</span> (mayor != NULL)</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;                winnerName = mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>();</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> emailbody;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        String subject;</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        <span class="comment">// send email to the incumbent</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;        <span class="keywordflow">if</span> (topCandidate == incumbentID) {</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;                emailbody.<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1variables_1_1_string_id.html#ae45668d6dfbdcec7d28d9d953f5e1ba2">setStringId</a>(<span class="stringliteral">&quot;@city/city:election_incumbent_win_body&quot;</span>); <span class="comment">//&quot;Congratulations, Mayor %TT!The populace of %TO has elected to retain you for another term.</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;                emailbody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;                emailbody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#a46d29e48d6738ce32cc73e6e7225bdf7">setTT</a>(winnerName);</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;                subject = <span class="stringliteral">&quot;@city/city:election_incumbent_win_subject&quot;</span>; <span class="comment">// &quot;Election Won&quot;</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;                chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>, subject, emailbody,</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;                                incumbentName, NULL);</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;                <span class="comment">// send a mail to the new mayor</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;                emailbody.<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1variables_1_1_string_id.html#ae45668d6dfbdcec7d28d9d953f5e1ba2">setStringId</a>(<span class="stringliteral">&quot;@city/city:election_new_mayor_body&quot;</span>); <span class="comment">// Congratulations, Mayor %TT! You have been elected the new mayor of %TO</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;                subject = <span class="stringliteral">&quot;@city/city:election_new_mayor_subject&quot;</span>; <span class="comment">// Congratulations Mayor!</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;                emailbody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#a46d29e48d6738ce32cc73e6e7225bdf7">setTT</a>(winnerName);</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;                emailbody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;                chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>, subject, emailbody,</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;                                winnerName, NULL);</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;                emailbody.<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1variables_1_1_string_id.html#ae45668d6dfbdcec7d28d9d953f5e1ba2">setStringId</a>(<span class="stringliteral">&quot;@city/city:election_incumbent_lost_body&quot;</span>); <span class="comment">// Citizen,It is with regret that we inform you that you have lost the position of Mayor of %TO to %TT.</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;                emailbody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;                emailbody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#a46d29e48d6738ce32cc73e6e7225bdf7">setTT</a>(winnerName);</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;                subject = <span class="stringliteral">&quot;@city/city:election_incumbent_lost_subject&quot;</span>; <span class="comment">// election lost</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;                chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>, subject, emailbody,</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                                incumbentName, NULL);</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        }</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;        <span class="comment">// send mailto all citizens</span></div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;        <span class="keywordflow">if</span> (topCandidate == incumbentID)</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;                emailbody.<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1variables_1_1_string_id.html#ae45668d6dfbdcec7d28d9d953f5e1ba2">setStringId</a>(<span class="stringliteral">&quot;@city/city:public_election_inc_body&quot;</span>); <span class="comment">//The city elections for %TT have been held.  The incumbent Mayor is victorious!</span></div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;                emailbody.<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1variables_1_1_string_id.html#ae45668d6dfbdcec7d28d9d953f5e1ba2">setStringId</a>(<span class="stringliteral">&quot;@city/city:public_election_body&quot;</span>); <span class="comment">//&quot;The city elections for %TT have been held.  The incumbent Mayor has lost the election!  The new Mayor is citizen %TO</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;        emailbody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#a46d29e48d6738ce32cc73e6e7225bdf7">setTT</a>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;        emailbody.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(winnerName);</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa31cb49656b2d044e646c23d2074bcea">sendMail</a>(city, <span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>,</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                        <span class="stringliteral">&quot;@city/city:public_election_subject&quot;</span>, emailbody, NULL);</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;}</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;</div>
<div class="line"><a name="l01189"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a65e7d04b97721c169d4c9cc38f1be387"> 1189</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a65e7d04b97721c169d4c9cc38f1be387">CityManagerImplementation::contractCity</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city) {</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        uint8 newRank = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>() - 1;</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        <span class="keywordflow">if</span> (newRank == <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a14f3ad6202f487f689b5d3db3d82dfd0">CLIENT</a>) {</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;                StructureManager::instance()-&gt;destroyStructure(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a471c584ed2befda8a2d9e9ca1287cb4e">getCityHall</a>());</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        }</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;        ManagedReference&lt;SceneObject*&gt; obj = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>());</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;        <span class="keywordflow">if</span> (obj != NULL &amp;&amp; obj-&gt;isCreatureObject()) {</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor = cast&lt;CreatureObject*&gt; (obj.get());</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;                <span class="comment">//Send out contraction mail.</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;city_contract_body&quot;</span>);</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;                params.setTO(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                params.setDI(newRank);</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;                UnicodeString subject = <span class="stringliteral">&quot;@city/city:city_contract_subject&quot;</span>;</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;                <span class="keywordflow">if</span> (newRank == <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa4f33cd081599752ae889cc6565e459f">OUTPOST</a>) {</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                        params.setStringId(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;city_invalid_body&quot;</span>);</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                        subject = <span class="stringliteral">&quot;@city/city:city_invalid_subject&quot;</span>;</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;                }</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;                chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>, subject, params,</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;                                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>(), NULL);</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        }</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;        <a class="code" href="class_citizen_list.html">CitizenList</a>* cityMilitia = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a5af0e107e2bbe4fa51ad899496513f97">getMilitiaMembers</a>();</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        SortedVector&lt;uint64&gt; militiaMembers;</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; cityMilitia-&gt;size(); ++i) {</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;                militiaMembers.put(cityMilitia-&gt;get(i));</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;        }</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a501f7aba70b45d7d9ac355ef056afca0">removeAmenitiesOutsideCity</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ad79d7ab45533faee283cc9834ee849ef">radiusPerRank</a>.get(newRank - 1));</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#abcaa2e51c3ea573aa6b46b98cdc62ef8">setCityRank</a>(newRank);</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a41aedb5573c8cc6c81ddbc48ddd1048c">setRadius</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ad79d7ab45533faee283cc9834ee849ef">radiusPerRank</a>.get(newRank - 1));</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a97a3a96020ea2d702d1427773ee74d9f">destroyAllStructuresForRank</a>(uint8(newRank + 1));</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; militiaMembers.size(); ++i) {</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a1154da55b449deae66073193a3f8c50c">addMilitiaMember</a>(militiaMembers.get(i));</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;        }</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a7bc938c2ff7cc44feba04c76a92f78c7">cleanupCitizens</a>();</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;}</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;</div>
<div class="line"><a name="l01241"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd8c58cb1865d1e4bc2fbdbe62b871d9"> 1241</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd8c58cb1865d1e4bc2fbdbe62b871d9">CityManagerImplementation::expandCity</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city) {</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;        uint8 currentRank = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>();</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;        <span class="keywordflow">if</span> (currentRank == <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a8ed5cca987f59248cd6e04f5b3e5079a">METROPOLIS</a>) <span class="comment">//City doesn&#39;t expand if it&#39;s metropolis.</span></div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;        uint8 newRank = currentRank + 1;</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;        <a class="code" href="classserver_1_1zone_1_1_zone.html">Zone</a>* zone = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a38a4f242f4f0fab87dda020dcf433563">getZone</a>();</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;        <span class="keywordflow">if</span> (zone == NULL)</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;        ManagedReference&lt;SceneObject*&gt; obj = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>());</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;        <span class="keywordflow">if</span> (obj != NULL &amp;&amp; obj-&gt;isCreatureObject()) {</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor = cast&lt;CreatureObject*&gt; (obj.get());</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;                <span class="comment">//Send out expansion mail.</span></div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;city_expand_body&quot;</span>);</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;                params.setTO(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;                params.setDI(newRank);</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;                UnicodeString subject = <span class="stringliteral">&quot;@city/city:city_expand_subject&quot;</span>;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a23496dac85f2d30b0e90148887c6cab3">isCityRankCapped</a>(zone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#a351fb1c2dc9bfd55792c4c41d0ec3343">getZoneName</a>(), newRank)) {</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;                        params.setStringId(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;city_expand_cap_body&quot;</span>); <span class="comment">//Capped</span></div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                        subject = <span class="stringliteral">&quot;@city/city:city_expand_cap_subject&quot;</span>;</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;                        newRank = currentRank;</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                }</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;                chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>, subject, params,</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;                                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>(), NULL);</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;        }</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;        <a class="code" href="class_citizen_list.html">CitizenList</a>* cityMilitia = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a5af0e107e2bbe4fa51ad899496513f97">getMilitiaMembers</a>();</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;        SortedVector&lt;uint64&gt; militiaMembers;</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; cityMilitia-&gt;size(); ++i) {</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;                militiaMembers.put(cityMilitia-&gt;get(i));</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;        }</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#abcaa2e51c3ea573aa6b46b98cdc62ef8">setCityRank</a>(newRank);</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a41aedb5573c8cc6c81ddbc48ddd1048c">setRadius</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ad79d7ab45533faee283cc9834ee849ef">radiusPerRank</a>.get(newRank - 1));</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; militiaMembers.size(); ++i) {</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a1154da55b449deae66073193a3f8c50c">addMilitiaMember</a>(militiaMembers.get(i));</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        }</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;}</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;</div>
<div class="line"><a name="l01294"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ac16189edccdb0da5dcd6debb0138fec1"> 1294</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ac16189edccdb0da5dcd6debb0138fec1">CityManagerImplementation::destroyCity</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city) {</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        <span class="comment">//TODO: Review this.</span></div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        Locker locker(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a15497f5fb1c92d32f56c7aff060f0f81">_this</a>.get());</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        ManagedReference&lt;SceneObject*&gt; obj = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>());</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        <a class="code" href="classserver_1_1zone_1_1_zone.html">Zone</a>* zone = NULL;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        <span class="keywordflow">if</span> (obj != NULL &amp;&amp; obj-&gt;isCreatureObject()) {</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor = cast&lt;CreatureObject*&gt; (obj.get());</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;                <span class="comment">//Send out contraction mail.</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;new_city_fail_body&quot;</span>);</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;                chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>,</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;                                <span class="stringliteral">&quot;@city/city:new_city_fail_subject&quot;</span>, params,</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>(), NULL);</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a2cbcdee3ed12597547556d05c83aac88">unregisterCity</a>(city, mayor);</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        }</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        zone = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a38a4f242f4f0fab87dda020dcf433563">getZone</a>();</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4523c855758106985f2c47e4b42622d6">cities</a>.drop(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        locker.release();</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a48cca1f965b8a1281790f7d5ca6b51c6">destroyActiveAreas</a>();</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;        ManagedReference&lt;StructureObject*&gt; cityhall = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a471c584ed2befda8a2d9e9ca1287cb4e">getCityHall</a>();</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;        <span class="keywordflow">if</span> (cityhall != NULL) {</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a2b14b625fb1e0df85fd7e796fef8f8a4">setCityHall</a>(NULL);</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;                <span class="keywordflow">if</span> (zone == NULL)</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;                        cityhall-&gt;getZone();</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;                <span class="keywordflow">if</span> (zone != NULL) {</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;                        StructureManager::instance()-&gt;destroyStructure(cityhall);</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;                }</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;        }</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;destroyObjectFromDatabase(city-&gt;_getObjectID());</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a715ccf48e6552f9ac0834cbd468985b3">setZone</a>(NULL);</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;        <span class="comment">//TODO: Destroy civic structures.</span></div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;}</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;</div>
<div class="line"><a name="l01343"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a2d56fa816eaa1bdd3ba935fde75909c9"> 1343</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a2d56fa816eaa1bdd3ba935fde75909c9">CityManagerImplementation::registerCitizen</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature) {</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;        <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;        ManagedReference&lt;SceneObject*&gt; mayor = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>());</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;        <span class="keywordflow">if</span> (mayor != NULL &amp;&amp; mayor-&gt;isCreatureObject()) {</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayorCreature = cast&lt;CreatureObject*&gt; (mayor.get());</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;new_city_citizen_body&quot;</span>);</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;                params.setTO(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a2c408356d762cb58abb38e620f263f5d">getDisplayedName</a>());</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;                chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>,</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;                                <span class="stringliteral">&quot;@city/city:new_city_citizen_subject&quot;</span>, params,</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;                                mayorCreature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>(), NULL);</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;                params.setStringId(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;new_city_citizen_other_body&quot;</span>);</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;                params.setTU(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;                params.setTT(mayorCreature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a2c408356d762cb58abb38e620f263f5d">getDisplayedName</a>());</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;                chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>,</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;                                <span class="stringliteral">&quot;@city/city:new_city_citizen_other_subject&quot;</span>, params,</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;                                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>(), NULL);</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;        }</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ab4cca3a7a75588a6c618a980140f329c">addCitizen</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>());</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;}</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;</div>
<div class="line"><a name="l01372"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ac66c9fb667809a442e761efe014b8b27"> 1372</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ac66c9fb667809a442e761efe014b8b27">CityManagerImplementation::unregisterCitizen</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <span class="keywordtype">bool</span> inactive) {</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;        <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chatManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;        ManagedReference&lt;SceneObject*&gt; mayor = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>());</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;        <span class="keywordflow">if</span> (mayor != NULL &amp;&amp; mayor-&gt;isCreatureObject()) {</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayorCreature = cast&lt;CreatureObject*&gt; (mayor.get());</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;lost_citizen_body&quot;</span>); <span class="comment">//A citizen has left your city by using the revoke option on the city terminal. Citizen Name: %TO</span></div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;                params.setTO(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a2c408356d762cb58abb38e620f263f5d">getDisplayedName</a>());</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;                UnicodeString subject = <span class="stringliteral">&quot;@city/city:lost_citizen_subject&quot;</span>;</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;                <span class="keywordflow">if</span> (inactive) {</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;                        params.setStringId(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;lost_inactive_citizen_body&quot;</span>); <span class="comment">//A citizen has been removed due to six weeks inactivity.  If they return, they can rejoin the city by redeclaring at their residence.</span></div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;                        subject = <span class="stringliteral">&quot;@city/city:lost_inactive_citizen_subject&quot;</span>; <span class="comment">//Lost Inactive Citizen!</span></div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;                }</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;                chatManager-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(<span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>, subject, params,</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;                                mayorCreature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>(), NULL);</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;        }</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a50d295fbc1c4284138aee24c899c2f67">removeCitizen</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>());</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;}</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;</div>
<div class="line"><a name="l01400"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a1072c78a5535561018852aa4d3c4e551"> 1400</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a1072c78a5535561018852aa4d3c4e551">CityManagerImplementation::sendManageMilitia</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;        <span class="keywordflow">if</span> (!ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#ac3f9119dd14b6ff118fc66be27e79b35">hasAbility</a>(<span class="stringliteral">&quot;manage_militia&quot;</span>)) {</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:cant_militia&quot;</span>); <span class="comment">//You lack the skill to manage the city militia.</span></div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;        }</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;        ManagedReference&lt;SuiListBox*&gt; listbox = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(creature,</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                        <a class="code" href="class_sui_window_type.html#a41e8b98bc2384949e0ecf77ec7f42679">SuiWindowType::CITY_MILITIA</a>);</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;        listbox-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:militia_t&quot;</span>); <span class="comment">//Manage Militia</span></div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;        listbox-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:militia_d&quot;</span>); <span class="comment">//Below is a list of current city militia members. These citizens have the ability to ban visitors from accessing city services as well as the ability to attack visitors for the purposes of law enforcement. To add a new citizen to the militia select &quot;Add Militia Member&quot; and hit OK. To remove someone from the militia, select their name and hit OK.</span></div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;        listbox-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;        listbox-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;        listbox-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_city_manage_militia_sui_callback.html">CityManageMilitiaSuiCallback</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>, city));</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        listbox-&gt;addMenuItem(<span class="stringliteral">&quot;@city/city:militia_new_t&quot;</span>, 0); <span class="comment">//Add Militia Member</span></div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;        <a class="code" href="class_citizen_list.html">CitizenList</a>* militiaMembers = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a5af0e107e2bbe4fa51ad899496513f97">getMilitiaMembers</a>();</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; militiaMembers-&gt;size(); ++i) {</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;                ManagedReference&lt;SceneObject*&gt; militant = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;                                militiaMembers-&gt;get(i));</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;                <span class="keywordflow">if</span> (militant != NULL)</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;                        listbox-&gt;addMenuItem(militant-&gt;getDisplayedName(),</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;                                        militant-&gt;getObjectID());</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;        }</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a7154531890864f9e6cc348d32caad0a8">addSuiBox</a>(listbox);</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(listbox-&gt;generateMessage());</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;}</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;</div>
<div class="line"><a name="l01437"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aff2030de98fe36e880cf8dc5530bfefe"> 1437</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aff2030de98fe36e880cf8dc5530bfefe">CityManagerImplementation::promptAddMilitiaMember</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;        ManagedReference&lt;SuiInputBox*&gt; input = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_input_box.html">SuiInputBox</a>(creature,</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;                        <a class="code" href="class_sui_window_type.html#ad10a46f6ad2f971bb894a127c2c121c8">SuiWindowType::CITY_ADD_MILITIA</a>);</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;        input-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:militia_new_t&quot;</span>); <span class="comment">//Add Militia Member</span></div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;        input-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:militia_new_d&quot;</span>);</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        input-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;        input-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;        input-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_city_add_militia_member_sui_callback.html">CityAddMilitiaMemberSuiCallback</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>, city));</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a7154531890864f9e6cc348d32caad0a8">addSuiBox</a>(input);</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(input-&gt;generateMessage());</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;}</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;</div>
<div class="line"><a name="l01456"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a05292ce106ffc045c0520ca8c776c73e"> 1456</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a05292ce106ffc045c0520ca8c776c73e">CityManagerImplementation::addMilitiaMember</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor, <span class="keyword">const</span> String&amp; playerName) {</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;        <span class="keywordflow">if</span> (!city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0c5202dda669ec9be2e86cc8055d5ea1">isMayor</a>(mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>()))</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1player_1_1_player_manager.html">PlayerManager</a>* playerManager = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getPlayerManager();</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;        uint64 militiaid = playerManager-&gt;<a class="code" href="classserver_1_1zone_1_1managers_1_1player_1_1_player_manager.html#a5e3b9f6489ae3588e38a65551fea5efe">getObjectID</a>(playerName);</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;        <span class="keywordflow">if</span> (militiaid == mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>())</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;                <span class="keywordflow">return</span>; <span class="comment">//Cannot add the mayor.</span></div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;        <span class="keywordflow">if</span> (militiaid == 0) {</div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:cant_find_player&quot;</span>); <span class="comment">//The system was unable to find that player.  Make sure they are standing within 10 meters of the city terminal and try again.</span></div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;        }</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;        <span class="keywordflow">if</span> (!city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a12545e74ea01ac6c44be8cbe199372a7">isCitizen</a>(militiaid)) {</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:not_citizen&quot;</span>); <span class="comment">//That player must be a citizen to join the city militia.</span></div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;        }</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;        ManagedReference&lt;SceneObject*&gt; obj = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(militiaid);</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;        <span class="keywordflow">if</span> (obj == NULL || !obj-&gt;isCreatureObject() || !obj-&gt;isInRange(mayor, 16.f)) {</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:cannot_find_citizen&quot;</span>); <span class="comment">//Unable to find that citizen.</span></div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;        }</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature = cast&lt;CreatureObject*&gt; (obj.get());</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:added_militia_target&quot;</span>); <span class="comment">//You have been added to the city militia.</span></div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:added_militia&quot;</span>); <span class="comment">//The player has been successfully added to the city militia.</span></div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;</div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a1154da55b449deae66073193a3f8c50c">addMilitiaMember</a>(militiaid);</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;}</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;</div>
<div class="line"><a name="l01492"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a919049aeb7a57481b225f689d8d145d0"> 1492</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a919049aeb7a57481b225f689d8d145d0">CityManagerImplementation::removeMilitiaMember</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor, uint64 militiaid) {</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;        <span class="keywordflow">if</span> (!city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0c5202dda669ec9be2e86cc8055d5ea1">isMayor</a>(mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>()))</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;</div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;        ManagedReference&lt;SceneObject*&gt; obj = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(militiaid);</div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;        <span class="keywordflow">if</span> (obj != NULL &amp;&amp; obj-&gt;isCreatureObject()) {</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature = cast&lt;CreatureObject*&gt; (obj.get());</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:removed_militia_target&quot;</span>); <span class="comment">//You have been removed from the city militia.</span></div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;        }</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:removed_militia&quot;</span>); <span class="comment">//The player has been successfully removed from the city militia.</span></div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;</div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aba0826c7c4918a7ef79c4e12ef8649fd">removeMilitiaMember</a>(militiaid);</div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;}</div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;</div>
<div class="line"><a name="l01509"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a57029a1f4bd25a8ceee92b4a7c6f8167"> 1509</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a57029a1f4bd25a8ceee92b4a7c6f8167">CityManagerImplementation::sendTreasuryReport</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;        <span class="comment">//@city/city:treasury_balance_t</span></div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;        ManagedReference&lt;SuiListBox*&gt; listbox = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(creature,</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;                        <a class="code" href="class_sui_window_type.html#a28d1c9f0547f66def0bcf6e492c16f64">SuiWindowType::CITY_TREASURY_REPORT</a>);</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;        listbox-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:treasury_balance_t&quot;</span>); <span class="comment">//Treasury Balance</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;        listbox-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:treasury_balance_d&quot;</span>); <span class="comment">//A report on the current treasury follows.</span></div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;        listbox-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;        listbox-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;        listbox-&gt;addMenuItem(</div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;                        <span class="stringliteral">&quot;@city/city:treasury &quot;</span> + String::valueOf(</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;                                        (<span class="keywordtype">int</span>) city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a365c80b4b636af52d9d69c95ec375205">getCityTreasury</a>()));</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(listbox-&gt;generateMessage());</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;}</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;</div>
<div class="line"><a name="l01526"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#add59606b1dc318c7a9fb53942ce2cebe"> 1526</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#add59606b1dc318c7a9fb53942ce2cebe">CityManagerImplementation::sendCityAdvancement</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;        ManagedReference&lt;SuiListBox*&gt; listbox = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(creature,</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;                        <a class="code" href="class_sui_window_type.html#a581e2c449d5429a92a7223e742801535">SuiWindowType::CITY_ADVANCEMENT</a>);</div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;        listbox-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:rank_info_t&quot;</span>); <span class="comment">//City Rank Info</span></div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;        listbox-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:rank_info_d&quot;</span>); <span class="comment">//The following report shows the current city rank, the current city population, the abilities of the city and the population required for the next rank.  If you have met your rank requirement, the city will advance in rank during the next city update.  Check the maintenance report for a projected time to the next update.</span></div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        listbox-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;        listbox-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;        <span class="comment">//City Abilities:</span></div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;        <span class="comment">//bank Bank</span></div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;        <span class="comment">//cantina  Cantina</span></div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;        <span class="keywordtype">int</span> rank = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>();</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;        <span class="keywordflow">if</span> (rank - 1 &gt;= <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7843d372fff4f95966d6b40365bda53c">citizensPerRank</a>.size())</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;        <span class="keywordtype">int</span> currentRank = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7843d372fff4f95966d6b40365bda53c">citizensPerRank</a>.get(rank - 1);</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;        <span class="keywordtype">int</span> nextRank = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a7843d372fff4f95966d6b40365bda53c">citizensPerRank</a>.get(rank == <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a8ed5cca987f59248cd6e04f5b3e5079a">METROPOLIS</a> ? rank - 1 : rank);</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;        <span class="comment">//pop_req_current_rankPop. Req. for Current Rank:</span></div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;        <span class="comment">//pop_req_next_rankPop. Req. for Next Rank:</span></div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;        listbox-&gt;addMenuItem(</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;                        <span class="stringliteral">&quot;@city/city:city_rank_prompt @city/city:rank&quot;</span> + String::valueOf(</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;                                        rank));</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;        listbox-&gt;addMenuItem(</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;                        <span class="stringliteral">&quot;@city/city:reg_citizen_prompt &quot;</span> + String::valueOf(</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;                                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa6caecdd8107e0a89f219c72f939a449">getCitizenCount</a>()));</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;        listbox-&gt;addMenuItem(</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;                        <span class="stringliteral">&quot;@city/city:pop_req_current_rank &quot;</span> + String::valueOf(currentRank));</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;        listbox-&gt;addMenuItem(</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;                        <span class="stringliteral">&quot;@city/city:pop_req_next_rank &quot;</span> + String::valueOf(nextRank));</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(listbox-&gt;generateMessage());</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;}</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;</div>
<div class="line"><a name="l01563"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4472de2a2002d229da73855549458aba"> 1563</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a4472de2a2002d229da73855549458aba">CityManagerImplementation::promptRegisterCity</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;        <span class="keywordflow">if</span> (!city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0c5202dda669ec9be2e86cc8055d5ea1">isMayor</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>()))</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;        <span class="keywordflow">if</span> (!ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#ac3f9119dd14b6ff118fc66be27e79b35">hasAbility</a>(<span class="stringliteral">&quot;city_map&quot;</span>)) {</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:cant_register&quot;</span>); <span class="comment">//You lack the ability to register your city!</span></div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;        }</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>() &lt; <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a3287fd57c83386c7aa56fda7e18d818f">TOWNSHIP</a>) {</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:cant_register_rank&quot;</span>); <span class="comment">//Your city must be rank 3 (Township) to be registered on the planetary map.</span></div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;        }</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;        ManagedReference&lt;SuiMessageBox*&gt; box = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_message_box.html">SuiMessageBox</a>(creature,</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;                        <a class="code" href="class_sui_window_type.html#a027b0760eb754d5dddfc3945d7dec37f">SuiWindowType::CITY_REGISTER</a>);</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;        box-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:register_t&quot;</span>); <span class="comment">//Register City</span></div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;        box-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:register_d&quot;</span>);</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;        box-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;        box-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;        box-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_city_register_sui_callback.html">CityRegisterSuiCallback</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>, city));</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a7154531890864f9e6cc348d32caad0a8">addSuiBox</a>(box);</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(box-&gt;generateMessage());</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;}</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;</div>
<div class="line"><a name="l01595"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ae76309581701b48b2e3337015be81dad"> 1595</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ae76309581701b48b2e3337015be81dad">CityManagerImplementation::promptUnregisterCity</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;</div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;        <span class="keywordflow">if</span> (!city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0c5202dda669ec9be2e86cc8055d5ea1">isMayor</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>()))</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;        ManagedReference&lt;SuiMessageBox*&gt; box = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_message_box.html">SuiMessageBox</a>(creature,</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;                        <a class="code" href="class_sui_window_type.html#a027b0760eb754d5dddfc3945d7dec37f">SuiWindowType::CITY_REGISTER</a>);</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;        box-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:unregister_t&quot;</span>); <span class="comment">//Unregister City</span></div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;        box-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:unregister_d&quot;</span>);</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;        box-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;        box-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;        box-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_city_register_sui_callback.html">CityRegisterSuiCallback</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>, city, <span class="keyword">true</span>));</div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a7154531890864f9e6cc348d32caad0a8">addSuiBox</a>(box);</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(box-&gt;generateMessage());</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;}</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;</div>
<div class="line"><a name="l01617"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#adaf92de697fba49fa91a8cb32667f9fd"> 1617</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#adaf92de697fba49fa91a8cb32667f9fd">CityManagerImplementation::registerCity</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor) {</div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;        Reference&lt;PlanetMapCategory*&gt; cityCat =</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;                        TemplateManager::instance()-&gt;getPlanetMapCategoryByName(<span class="stringliteral">&quot;city&quot;</span>);</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;        <span class="keywordflow">if</span> (cityCat == NULL)</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#abd8f59d3cd885d0060a0429ff760b6c4">setRegistered</a>(<span class="keyword">true</span>);</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;        ManagedReference&lt;Region*&gt; aa = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a7c7b98a8b80680ac7748ec0e0d25a65c">getRegion</a>(0);</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;        aa-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#abc6466edb9c18e806becdae637a5c270">setPlanetMapCategory</a>(cityCat);</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;        aa-&gt;getZone()-&gt;getPlanetManager()-&gt;addRegion(city);</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;        aa-&gt;getZone()-&gt;registerObjectWithPlanetaryMap(aa);</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa13d95546a90b2bb1b8530db6f3fcc0e">getStructuresCount</a>(); i++) {</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;                ManagedReference&lt;StructureObject*&gt; structure = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa93555dd8ca38b76fb752a883248a1b3">getCivicStructure</a>(</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;                                i);</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;                aa-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a83c519b8b1e57fcc329e85689ef9fb1a">getZone</a>()-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#ab8d2aa7e16bee819e7a29f694c9c844f">registerObjectWithPlanetaryMap</a>(structure);</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;        }</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a82bfa78b35409a710f28878622b4d77e">getCommercialStructuresCount</a>(); i++) {</div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;                ManagedReference&lt;StructureObject*&gt; structure =</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;                                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a234cfe1cb5e68bea3c03571dc82c9047">getCommercialStructure</a>(i);</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;                aa-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a83c519b8b1e57fcc329e85689ef9fb1a">getZone</a>()-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#ab8d2aa7e16bee819e7a29f694c9c844f">registerObjectWithPlanetaryMap</a>(structure);</div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;        }</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:registered&quot;</span>); <span class="comment">//Your city is now registered on the planetary map. All civic and major commercial structures in the city are also registered and can be found with the /find command.</span></div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;}</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;</div>
<div class="line"><a name="l01647"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a2cbcdee3ed12597547556d05c83aac88"> 1647</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a2cbcdee3ed12597547556d05c83aac88">CityManagerImplementation::unregisterCity</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor) {</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#abd8f59d3cd885d0060a0429ff760b6c4">setRegistered</a>(<span class="keyword">false</span>);</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;</div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a7064f7cd9834a5becd17746d7229e1d7">getRegionsCount</a>() != 0) {</div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;                ManagedReference&lt;Region*&gt; aa = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a7c7b98a8b80680ac7748ec0e0d25a65c">getRegion</a>(0);</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;                <a class="code" href="classserver_1_1zone_1_1_zone.html">Zone</a>* aaZone = aa-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a83c519b8b1e57fcc329e85689ef9fb1a">getZone</a>();</div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;                <span class="keywordflow">if</span> (aaZone != NULL) {</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;                        aaZone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#af00432887b203714a019b02fa82354cc">unregisterObjectWithPlanetaryMap</a>(aa);</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;                        aaZone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#a47f3a3d6d076c833e76dbd682b1c069f">getPlanetManager</a>()-&gt;<a class="code" href="classserver_1_1zone_1_1managers_1_1planet_1_1_planet_manager.html#a758fdea1b2fd25e1c7b6d0f44d7f647c">dropRegion</a>(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;</div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa13d95546a90b2bb1b8530db6f3fcc0e">getStructuresCount</a>(); i++) {</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;                                ManagedReference&lt;StructureObject*&gt; structure =</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;                                                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa93555dd8ca38b76fb752a883248a1b3">getCivicStructure</a>(i);</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;                                aaZone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#af00432887b203714a019b02fa82354cc">unregisterObjectWithPlanetaryMap</a>(structure);</div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;                        }</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;                        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a82bfa78b35409a710f28878622b4d77e">getCommercialStructuresCount</a>(); i++) {</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;                                ManagedReference&lt;StructureObject*&gt; structure =</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;                                                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a234cfe1cb5e68bea3c03571dc82c9047">getCommercialStructure</a>(i);</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;                                aaZone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#af00432887b203714a019b02fa82354cc">unregisterObjectWithPlanetaryMap</a>(structure);</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;                        }</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;                }</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;                aa-&gt;setPlanetMapCategory(NULL);</div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;        }</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:unregistered&quot;</span>); <span class="comment">//Your city is no longer registered on the planetary map.</span></div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;}</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;</div>
<div class="line"><a name="l01679"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a9e11072449171a0192a6d4288f3a9add"> 1679</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a9e11072449171a0192a6d4288f3a9add">CityManagerImplementation::promptAdjustTaxes</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;        <span class="keywordflow">if</span> (!ghost-&gt;hasAbility(<span class="stringliteral">&quot;manage_taxes&quot;</span>)) {</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:cant_tax&quot;</span>); <span class="comment">//You lack the knowledge to manage the city&#39;s taxes.</span></div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;        }</div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;        ManagedReference&lt;SuiListBox*&gt; listbox = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(mayor,</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;                        <a class="code" href="class_sui_window_type.html#a1bd92199d912ae6510e0f698ca369ab1">SuiWindowType::CITY_ADJUST_TAX</a>);</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        listbox-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:adjust_taxes_t&quot;</span>); <span class="comment">//Adjust Taxes</span></div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;        listbox-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:adjust_taxes_d&quot;</span>); <span class="comment">//Select the tax you wish to adjust from the list below.</span></div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;        listbox-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;        listbox-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;        listbox-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_city_adjust_tax_sui_callback.html">CityAdjustTaxSuiCallback</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>, city));</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;</div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a237d57a92e7fc9be9c859bb0e7118118">cityTaxes</a>.size(); ++i) {</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;                <a class="code" href="class_city_tax.html">CityTax</a>* cityTax = &amp;<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a237d57a92e7fc9be9c859bb0e7118118">cityTaxes</a>.get(i);</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;                listbox-&gt;addMenuItem(cityTax-&gt;<a class="code" href="class_city_tax.html#a4d51364b3259ab57f932940bb59ab591">getMenuText</a>(), i); <span class="comment">//Property Tax</span></div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;        }</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;        ghost-&gt;addSuiBox(listbox);</div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(listbox-&gt;generateMessage());</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;}</div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;</div>
<div class="line"><a name="l01708"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a6892331b4d8cb7633a384816ff43b963"> 1708</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a6892331b4d8cb7633a384816ff43b963">CityManagerImplementation::promptSetTax</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor, <span class="keywordtype">int</span> selectedTax, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;        <a class="code" href="class_city_tax.html">CityTax</a>* cityTax = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a530ee8f9d85b091dd1cce154a2fede61">getCityTax</a>(selectedTax);</div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;        <span class="keywordflow">if</span> (cityTax == NULL)</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;        <span class="keywordflow">if</span> (!ghost-&gt;hasAbility(<span class="stringliteral">&quot;manage_taxes&quot;</span>)) {</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:cant_tax&quot;</span>); <span class="comment">//You lack the knowledge to manage the city&#39;s taxes.</span></div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;        }</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;        ManagedReference&lt;SuiInputBox*&gt; inputbox = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_input_box.html">SuiInputBox</a>(mayor,</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;                        <a class="code" href="class_sui_window_type.html#a253f3c098503fb53ddabc64931972ce7">SuiWindowType::CITY_TAX_PROMPT</a>);</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;        inputbox-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;        inputbox-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;        inputbox-&gt;setCallback(</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;                        <span class="keyword">new</span> <a class="code" href="class_city_set_tax_sui_callback.html">CitySetTaxSuiCallback</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>, city, selectedTax));</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;        inputbox-&gt;setPromptTitle(cityTax-&gt;<a class="code" href="class_city_tax.html#a02cc946d2184a61514e31914a013b4c1">getInputTitle</a>());</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;        inputbox-&gt;setPromptText(cityTax-&gt;<a class="code" href="class_city_tax.html#a4b6eba1dfcbd74f5cbe375f87213ba68">getInputText</a>());</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;</div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;        ghost-&gt;addSuiBox(inputbox);</div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(inputbox-&gt;generateMessage());</div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;}</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;</div>
<div class="line"><a name="l01738"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af89e549f65b320c8da8bfdce632f889d"> 1738</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af89e549f65b320c8da8bfdce632f889d">CityManagerImplementation::setTax</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city, <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor,</div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;                <span class="keywordtype">int</span> selectedTax, <span class="keywordtype">int</span> value) {</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;        <a class="code" href="class_city_tax.html">CityTax</a>* cityTax = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a530ee8f9d85b091dd1cce154a2fede61">getCityTax</a>(selectedTax);</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;</div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;        <span class="keywordflow">if</span> (cityTax == NULL)</div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;</div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;        <span class="keywordflow">if</span> (value &lt; cityTax-&gt;getMinValue() || value &gt; cityTax-&gt;<a class="code" href="class_city_tax.html#a14902c8fc739e7ddb05b37f4a46d5331">getMaxValue</a>()) {</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:tax_out_of_range&quot;</span>); <span class="comment">//That tax value is outside the range limitations.</span></div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;        }</div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;        Locker _lock(city, mayor);</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#afb2a4d77aa04fb40018529a401bc1209">setTax</a>(selectedTax, value);</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;        _lock.release();</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(cityTax-&gt;<a class="code" href="class_city_tax.html#ac26aa544c7ec827d9ef3dc5a49600de9">getSystemMessage</a>());</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;        params.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#aa35ce7d0a7a3b96baff3e88100b3f5f8">setDI</a>(value);</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(params);</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;        <span class="comment">//Send out emails to all residents.</span></div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;        params.setStringId(cityTax-&gt;<a class="code" href="class_city_tax.html#ae88846cc12e661c8399ad7500b5c3dec">getEmailBody</a>());</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;        params.setTO(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad458f0b0e4d6adb4649ddcc2fea8f98e">getRegionName</a>());</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;</div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa31cb49656b2d044e646c23d2074bcea">sendMail</a>(city, <span class="stringliteral">&quot;@city/city:new_city_from&quot;</span>, cityTax-&gt;<a class="code" href="class_city_tax.html#adb2225163426f47eb6159edaf17c3bb7">getEmailSubject</a>(),</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;                        params, NULL);</div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;}</div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;</div>
<div class="line"><a name="l01770"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a2ba1892ab4c945098b0366a6e079aa29"> 1770</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a2ba1892ab4c945098b0366a6e079aa29">CityManagerImplementation::sendMaintenanceReport</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;        <span class="comment">//TODO: Encapsulate this, and clean up.</span></div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;</div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;        <span class="keywordflow">if</span> (city == NULL || creature == NULL)</div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;</div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;</div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;</div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;        <span class="keywordtype">int</span> seconds = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a8995c18136bcda1cf04e3737d82c2ff5">getTimeToUpdate</a>();</div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;        <span class="keywordtype">int</span> days = floor(seconds / 86400);</div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;        seconds -= days * 86400;</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;        <span class="keywordtype">int</span> hours = floor(seconds / 3600);</div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;        seconds -= hours * 3600;</div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;</div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;        <span class="keywordtype">int</span> minutes = floor(seconds / 60);</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;        seconds -= minutes * 60;</div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;        StringBuffer buffer;</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;        <span class="keywordflow">if</span> (days &gt; 0) {</div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;                buffer &lt;&lt; days &lt;&lt; <span class="stringliteral">&quot; day&quot;</span>;</div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;</div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;                <span class="keywordflow">if</span> (days &gt; 1)</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;                        buffer &lt;&lt; <span class="stringliteral">&quot;s&quot;</span>;</div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;                <span class="keywordflow">if</span> (hours &gt; 0 || minutes &gt; 0 || seconds &gt; 0)</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;                        buffer &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;        }</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;        <span class="keywordflow">if</span> (hours &gt; 0) {</div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;                buffer &lt;&lt; hours &lt;&lt; <span class="stringliteral">&quot; hour&quot;</span>;</div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;                <span class="keywordflow">if</span> (hours &gt; 1)</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;                        buffer &lt;&lt; <span class="stringliteral">&quot;s&quot;</span>;</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;                <span class="keywordflow">if</span> (minutes &gt; 0 || seconds &gt; 0)</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;                        buffer &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;        }</div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;        <span class="keywordflow">if</span> (minutes &gt; 0) {</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;                buffer &lt;&lt; minutes &lt;&lt; <span class="stringliteral">&quot; minute&quot;</span>;</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;                <span class="keywordflow">if</span> (minutes &gt; 1)</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;                        buffer &lt;&lt; <span class="stringliteral">&quot;s&quot;</span>;</div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;</div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;                <span class="keywordflow">if</span> (seconds &gt; 0)</div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;                        buffer &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;        }</div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;</div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;        <span class="keywordflow">if</span> (seconds &gt; 0) {</div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;                buffer &lt;&lt; seconds &lt;&lt; <span class="stringliteral">&quot; second&quot;</span>;</div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;</div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;                <span class="keywordflow">if</span> (seconds &gt; 1)</div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;                        buffer &lt;&lt; <span class="stringliteral">&quot;s&quot;</span>;</div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;        }</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;</div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;        String updateStr = buffer.toString();</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;        <span class="keywordflow">if</span> (updateStr.isEmpty())</div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;                updateStr = <span class="stringliteral">&quot;Now&quot;</span>;</div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;        <span class="comment">//StringIdChatParameter params(&quot;city/city&quot;, &quot;city_update_eta&quot;); //Next City Update: %TO</span></div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;        <span class="comment">//params.setTO(updateStr);</span></div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;        <span class="comment">//creature-&gt;sendSystemMessage(params);</span></div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;        <span class="keywordtype">int</span> totalcost = 0;</div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;</div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;        ManagedReference&lt;SuiListBox*&gt; maintList = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(creature,</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;                        <a class="code" href="class_sui_window_type.html#a28d1c9f0547f66def0bcf6e492c16f64">SuiWindowType::CITY_TREASURY_REPORT</a>);</div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;        maintList-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:maint_info_t&quot;</span>);</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;        maintList-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:maint_info_d&quot;</span>);</div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;</div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;        maintList-&gt;addMenuItem(<span class="stringliteral">&quot;Next City Update: &quot;</span> + updateStr);</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;        Locker <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a1393454953396e85abca95f96e53002b">lock</a>(city);</div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;        <a class="code" href="class_template_manager.html">TemplateManager</a>* templateManager = TemplateManager::instance();</div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa13d95546a90b2bb1b8530db6f3fcc0e">getStructuresCount</a>(); i++) {</div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;                ManagedReference&lt;StructureObject*&gt; structure = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aa93555dd8ca38b76fb752a883248a1b3">getCivicStructure</a>(</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;                                i);</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;</div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;                <span class="keywordflow">if</span> (structure != NULL) {</div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;                        String maintString = structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a2c408356d762cb58abb38e620f263f5d">getDisplayedName</a>();</div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;</div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;                                        <span class="keywordflow">if</span> (templateManager != NULL) {</div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;                                <span class="keywordflow">if</span> (structure-&gt;getObjectTemplate() == NULL)</div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;                                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;                                Reference&lt;SharedStructureObjectTemplate*&gt; serverTemplate =</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;                                                cast&lt;SharedStructureObjectTemplate*&gt; (</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;                                                                structure-&gt;getObjectTemplate());</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;                                <span class="keywordflow">if</span> (serverTemplate != NULL) {</div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;                                        <span class="keywordtype">int</span> thiscost = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> * serverTemplate-&gt;getCityMaintenanceAtRank(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>()-1);</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;                                        totalcost += thiscost;</div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;</div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;                                        <span class="keywordflow">if</span>(structure-&gt;isCityHall() &amp;&amp; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ad56c53a132122899eb6ddda90cf7e3b4">isRegistered</a>())</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;                                                        thiscost += 5000;</div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;</div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;                                        maintString += <span class="stringliteral">&quot; : &quot;</span> + String::valueOf(thiscost);</div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;                                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;                                        maintString += <span class="stringliteral">&quot; : NA&quot;</span>;</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;                                }</div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;</div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;                        }</div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;</div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;                        maintList-&gt;addMenuItem(maintString);</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;                }</div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;        }</div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;</div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a1909bfc6ff4c1976edc852b9121e4626">getSkillTrainerCount</a>(); i++) {</div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;                ManagedReference&lt;SceneObject*&gt; trainer = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#af029271a23f82bb97fefe096bb530d0d">getCitySkillTrainer</a>(i);</div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;                <span class="keywordtype">int</span> trainerCost = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> * 1500;</div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;                <span class="keywordflow">if</span> (trainer != NULL) {</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;                        totalcost += trainerCost;</div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;                        maintList-&gt;addMenuItem(trainer-&gt;getDisplayedName() + <span class="stringliteral">&quot; : &quot;</span> + String::valueOf(trainerCost), i);</div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;                }</div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;        }</div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;</div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aac874fe482ee7ca468ecb41d603b532a">getDecorationCount</a>(); i++) {</div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;                ManagedReference&lt;SceneObject*&gt; sceno = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ab5d8853aaf48f02823e05630818d8748">getCityDecoration</a>(i);</div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;                <span class="keywordflow">if</span> (sceno != NULL &amp;&amp; sceno-&gt;isStructureObject()) {</div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;                        <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure = cast&lt;StructureObject*&gt;(sceno.get());</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;</div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;                        <span class="keywordflow">if</span> (templateManager != NULL) {</div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;                                        <span class="keywordflow">if</span> (structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a49977bbe7ffeb660df3173c94421068b">getObjectTemplate</a>() == NULL)</div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;                                                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;</div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;                                        Reference&lt;SharedStructureObjectTemplate*&gt; serverTemplate =</div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;                                                        cast&lt;SharedStructureObjectTemplate*&gt; (structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a49977bbe7ffeb660df3173c94421068b">getObjectTemplate</a>());</div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;                                        <span class="keywordtype">int</span> decCost = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> * serverTemplate-&gt;getCityMaintenanceAtRank(city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>()-1);</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;                                        totalcost += decCost;</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;                                        maintList-&gt;addMenuItem(sceno-&gt;getDisplayedName() + <span class="stringliteral">&quot; : &quot;</span> + String::valueOf(decCost));</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;                        }</div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;</div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( sceno != NULL) {</div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;                        <span class="keywordtype">int</span> decCost = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> * 1500;</div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;                        totalcost += decCost;</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;                        maintList-&gt;addMenuItem(sceno-&gt;getDisplayedName() + <span class="stringliteral">&quot; : &quot;</span> + String::valueOf(decCost));</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;                }</div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;        }</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;</div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a4b347ca199a62a035b87c509cab1cbb4">getMissionTerminalCount</a>(); i++) {</div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;                ManagedReference&lt;SceneObject*&gt; term = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a2d919f46e00bfa81405beb4a095cb98d">getCityMissionTerminal</a>(i);</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;                <span class="keywordtype">int</span> terminalCost = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> * 1500;</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;                <span class="keywordflow">if</span> (term != NULL) {</div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;                        totalcost += terminalCost;</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;                        maintList-&gt;addMenuItem(term-&gt;getDisplayedName() + <span class="stringliteral">&quot; : &quot;</span> + String::valueOf(terminalCost));</div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;                }</div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;        }</div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#af04b8f1d4e6cf8b5f2fecce013b8a438">getCitySpecialization</a>() != <span class="stringliteral">&quot;&quot;</span>) {</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;                <a class="code" href="class_city_specialization.html">CitySpecialization</a>* spec = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abef3f0a0193809488108f3285cd34fee">getCitySpecialization</a>(</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;                                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#af04b8f1d4e6cf8b5f2fecce013b8a438">getCitySpecialization</a>());</div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;</div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;                <span class="keywordflow">if</span> (spec != NULL) {</div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;                        <span class="keywordtype">int</span> speccost = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abd1fdf222d9ce73284f5c05516c9b0ee">maintenanceDiscount</a> * spec-&gt;<a class="code" href="class_city_specialization.html#ae006c9f8a85002311153eb6380da90e8">getCost</a>();</div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;                        totalcost += speccost;</div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;                        maintList-&gt;addMenuItem(</div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;                                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#af04b8f1d4e6cf8b5f2fecce013b8a438">getCitySpecialization</a>() + <span class="stringliteral">&quot; : &quot;</span> + String::valueOf(</div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;                                                        speccost));</div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;                }</div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;</div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;        }</div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;        maintList-&gt;addMenuItem(<span class="stringliteral">&quot;Total: &quot;</span> + String::valueOf(totalcost));</div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;</div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a7154531890864f9e6cc348d32caad0a8">addSuiBox</a>(maintList);</div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(maintList-&gt;generateMessage());</div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;}</div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;</div>
<div class="line"><a name="l01952"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a8a7c65303eafb44f8fb1f87054745d22"> 1952</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a8a7c65303eafb44f8fb1f87054745d22">CityManagerImplementation::isCityInRange</a>(<a class="code" href="classserver_1_1zone_1_1_zone.html">Zone</a>* zone, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y) {</div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;}</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;</div>
<div class="line"><a name="l01956"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a21d237cb2d3abe26f86a7e00b9a706ba"> 1956</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a21d237cb2d3abe26f86a7e00b9a706ba">CityManagerImplementation::sendMayoralStandings</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;        ManagedReference&lt;SuiListBox*&gt; listbox = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(creature,</div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;                        <a class="code" href="class_sui_window_type.html#a5b8bf4921d2e81a8ea33973169129a26">SuiWindowType::CITY_MAYOR_STANDINGS</a>);</div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;        listbox-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:mayoral_standings_d&quot;</span>);</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;        listbox-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:mayoral_standings_t&quot;</span>);</div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;        listbox-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;        listbox-&gt;setCancelButton(<span class="keyword">true</span>, <span class="stringliteral">&quot;@cancel&quot;</span>);</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;</div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;        uint64 mayorid = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>();</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;        ManagedReference&lt;SceneObject*&gt; mayor = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(mayorid);</div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;</div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;        <span class="comment">// removed when taking out mayoral auto register</span></div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;        <span class="comment">//if (mayor != NULL)</span></div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;        <span class="comment">//      listbox-&gt;addMenuItem(&quot;Incumbent: &quot; + mayor-&gt;getDisplayedName() + &quot; -- Votes: &quot; + String::valueOf(city-&gt;getCandidateVotes(mayorid)));</span></div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;</div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;        VectorMap&lt;uint64, int&gt;* candidates = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a258070dcc9ffa9f25a4f99fe781ce8ef">getCandidates</a>();</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; candidates-&gt;size(); ++i) {</div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;                VectorMapEntry&lt;uint64, int&gt;* entry = &amp;candidates-&gt;elementAt(i);</div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;                uint64 oid = entry-&gt;getKey();</div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;                <span class="comment">//if (oid == mayorid)</span></div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;                <span class="comment">//      continue;</span></div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;                ManagedReference&lt;SceneObject*&gt; candidate = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(oid);</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;                <span class="keywordflow">if</span> (candidate == NULL)</div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;                <span class="keywordflow">if</span> (oid != mayorid)</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;                        listbox-&gt;addMenuItem(</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;                                        <span class="stringliteral">&quot;Challenger: &quot;</span> + candidate-&gt;getDisplayedName()</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;                                                        + <span class="stringliteral">&quot; -- Votes: &quot;</span></div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;                                                        + String::valueOf(entry-&gt;getValue()));</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;                        listbox-&gt;addMenuItem(</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;                                        <span class="stringliteral">&quot;Incumbent: &quot;</span> + mayor-&gt;getDisplayedName() + <span class="stringliteral">&quot; -- Votes: &quot;</span></div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;                                                        + String::valueOf(entry-&gt;getValue()));</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;        }</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;</div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;        <span class="keywordflow">if</span> (ghost != NULL)</div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;                ghost-&gt;addSuiBox(listbox);</div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;</div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(listbox-&gt;generateMessage());</div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;}</div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;</div>
<div class="line"><a name="l02008"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a982d4646c0bdaf4bbc39615ac30baf89"> 2008</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a982d4646c0bdaf4bbc39615ac30baf89">CityManagerImplementation::promptMayoralVote</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;        <span class="keywordflow">if</span> (!city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a12545e74ea01ac6c44be8cbe199372a7">isCitizen</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>())) {</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:vote_noncitizen&quot;</span>); <span class="comment">//You must be a citizen of the city to vote for Mayor.</span></div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;        }</div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;        VectorMap&lt;uint64, int&gt;* candidates = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a258070dcc9ffa9f25a4f99fe781ce8ef">getCandidates</a>();</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;        <span class="keywordflow">if</span> (candidates-&gt;size() &lt;= 0) {</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:no_candidates&quot;</span>); <span class="comment">//No one has registered to run.</span></div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;        }</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;        ManagedReference&lt;SuiListBox*&gt; listbox = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(creature,</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;                        <a class="code" href="class_sui_window_type.html#a8602f0a16fdc9a75387ec918e3f32e1c">SuiWindowType::CITY_MAYOR_VOTE</a>);</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;        listbox-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:mayoral_vote_t&quot;</span>); <span class="comment">//Place Mayoral Vote</span></div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;        listbox-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:mayoral_vote_d&quot;</span>); <span class="comment">//Select your desired candidate from the list below.  You may change your vote at any time.</span></div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;        listbox-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_city_mayoral_vote_sui_callback.html">CityMayoralVoteSuiCallback</a>(<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>, city));</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;        listbox-&gt;setUsingObject(terminal);</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;        listbox-&gt;setForceCloseDistance(16.f);</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;        ManagedReference&lt;SceneObject*&gt; mayor = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;                        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>());</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;        <span class="comment">// removed when taking out mayoral auto register</span></div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;        <span class="comment">//if (mayor != NULL)</span></div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;        <span class="comment">//      listbox-&gt;addMenuItem(mayor-&gt;getDisplayedName() + &quot; (Incumbent)&quot;, city-&gt;getMayorID());</span></div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;</div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; candidates-&gt;size(); ++i) {</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;                VectorMapEntry&lt;uint64, int&gt;* entry = &amp;candidates-&gt;elementAt(i);</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;                ManagedReference&lt;SceneObject*&gt; candidate = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;                                entry-&gt;getKey());</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;                <span class="keywordflow">if</span> (candidate != NULL) {</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;                        <span class="keywordflow">if</span> (candidate == mayor)</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;                                listbox-&gt;addMenuItem(</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;                                                mayor-&gt;getDisplayedName() + <span class="stringliteral">&quot; (Incumbent)&quot;</span>,</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;                                                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a9a11b4cf7a3e13c3eb61293743daba99">getMayorID</a>());</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;                                listbox-&gt;addMenuItem(</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;                                                candidate-&gt;getDisplayedName() + <span class="stringliteral">&quot; (Challenger)&quot;</span>,</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;                                                entry-&gt;getKey());</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                }</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;        }</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;        listbox-&gt;addMenuItem(<span class="stringliteral">&quot;Abstain&quot;</span>, 0);</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;        <span class="keywordflow">if</span> (ghost != NULL)</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;                ghost-&gt;addSuiBox(listbox);</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(listbox-&gt;generateMessage());</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;}</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;</div>
<div class="line"><a name="l02065"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#adacad78c646ba4a17d379859f34e0a85"> 2065</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#adacad78c646ba4a17d379859f34e0a85">CityManagerImplementation::castMayoralVote</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, uint64 oid) {</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;<span class="comment">         not_politician That citizen is not a politician.</span></div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;        <span class="keywordflow">if</span> (!city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a12545e74ea01ac6c44be8cbe199372a7">isCitizen</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>()))</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;        <span class="keywordflow">if</span> (oid != 0 &amp;&amp; !city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a4b3996b958b2e7a8ae0b21c62b47453d">isCandidate</a>(oid) &amp;&amp; !city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0c5202dda669ec9be2e86cc8055d5ea1">isMayor</a>(oid))</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;</div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;        <span class="comment">//Check if they chose to abstain from voting.</span></div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;        <span class="keywordflow">if</span> (oid == 0) {</div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:vote_abstain&quot;</span>); <span class="comment">//You have chosen to abstain in this election.</span></div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;                ManagedReference&lt;SceneObject*&gt; candidate = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(oid);</div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;</div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;                <span class="keywordflow">if</span> (candidate != NULL) {</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;                        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;@city/city:vote_placed&quot;</span>); <span class="comment">//Your vote for %TO has been recorded.</span></div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;                        params.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(candidate-&gt;getDisplayedName());</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(params);</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;                        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;                }</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;        }</div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a111a1e0a9bca898769277bf6dd4858c7">setMayoralVote</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>(), oid);</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;}</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;</div>
<div class="line"><a name="l02094"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a615f379122dd9eab9f2033d4f741184c"> 2094</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a615f379122dd9eab9f2033d4f741184c">CityManagerImplementation::registerForMayoralRace</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature) {</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;        uint64 objectid = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>();</div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;</div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;        <span class="comment">//TODO: Implement ballot lockout period.</span></div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;        <span class="comment">//registration_locked The ballot is locked during the final week of voting. You may not register or unregister for the race at this time.</span></div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;        <span class="keywordflow">if</span> (!city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a12545e74ea01ac6c44be8cbe199372a7">isCitizen</a>(objectid)) {</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:register_noncitizen&quot;</span>); <span class="comment">//Only a citizen of the city may enter the race.</span></div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;        }</div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;</div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;        <span class="comment">/* Remove auto regiseter.  mayor can now restier for the race</span></div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;<span class="comment">         if (city-&gt;isMayor(objectid)) {</span></div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;<span class="comment">         creature-&gt;sendSystemMessage(&quot;@city/city:register_incumbent&quot;); //You are the incumbent Mayor and are automatically registered in the race.</span></div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;<span class="comment">         return;</span></div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;<span class="comment">         }</span></div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;<span class="comment">         */</span></div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a2a11d6c0ffcd6c39cbc8803e529275df">isVotingLocked</a>()) {</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:registration_locked&quot;</span>); <span class="comment">// &quot;The ballot is locked during the final week of voting.You may not register or unregister for the race at this time.&quot;);</span></div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;        }</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a4b3996b958b2e7a8ae0b21c62b47453d">isCandidate</a>(objectid)) {</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:unregistered_race&quot;</span>); <span class="comment">//You have unregistered from the mayoral race.</span></div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;                city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a1aec5406b746875d8d86a3c18a4b4743">removeCandidate</a>(objectid);</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;        }</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;        <span class="comment">//Check to see if this creature is the mayor of another city.</span></div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;        uint64 declaredOidResidence = ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a0174bd18a3f8f399d3cf07f71791f64d">getDeclaredResidence</a>();</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;        ManagedReference&lt;BuildingObject*&gt; declaredResidence = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a3732ab513b8b56ad579dca074a460482">getZoneServer</a>()-&gt;<a class="code" href="classserver_1_1zone_1_1_zone_server.html#a8e09d3df7c2e98ad0b5628552ea27df6">getObject</a>(declaredOidResidence).castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1building_1_1_building_object.html">BuildingObject</a>*&gt;();</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;        <span class="keywordflow">if</span> (declaredResidence != NULL) {</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;                ManagedReference&lt;CityRegion*&gt; declaredCity =</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;                                declaredResidence-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a6ed514df7f0abf4ca435a11c5b5c6c96">getCityRegion</a>();</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;</div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;                <span class="keywordflow">if</span> (declaredCity != NULL &amp;&amp; declaredCity-&gt;isMayor(objectid) &amp;&amp; city</div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;                                != declaredCity) {</div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:already_mayor&quot;</span>); <span class="comment">//You are already the mayor of a city.  You may not be mayor of another city.</span></div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;                        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;                }</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;        }</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;        <span class="comment">//Check to see if they are a Novice Politician</span></div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;        <span class="keywordflow">if</span> (!creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ab41bcbd8f2c21a96fa9dab007d7e9fa1">hasSkill</a>(<span class="stringliteral">&quot;social_politician_novice&quot;</span>)) {</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:register_nonpolitician&quot;</span>); <span class="comment">//You must be at least a Novice Politician in order to run for mayor.</span></div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;        }</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;        <span class="keywordflow">if</span> (!creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a00d3ae68696c723a5c492034584c981d">checkCooldownRecovery</a>(<span class="stringliteral">&quot;register_mayor&quot;</span>)) {</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:register_timestamp&quot;</span>); <span class="comment">//You may only register to run once within a 24 hour period.</span></div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;        }</div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;        city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#ab15fbf04abfc596ed72dcc00d011cead">addCandidate</a>(objectid);</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:register_congrats&quot;</span>); <span class="comment">//Congratulations, you are now listed on the ballot for the Mayoral race!</span></div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;<span class="preprocessor">#ifndef CITY_DEBUG</span></div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;<span class="preprocessor"></span>        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a9267544fb30b04445f5b2933f4b11907">addCooldown</a>(<span class="stringliteral">&quot;register_mayor&quot;</span>, 24 * 3600 * 1000); <span class="comment">//Can only vote once per day.</span></div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;<span class="preprocessor"></span>        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;rceb&quot;</span>); <span class="comment">//%TO has entered the race for mayor. You can now vote for this candidate at the city voting terminal.</span></div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;        params.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a2c408356d762cb58abb38e620f263f5d">getDisplayedName</a>());</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;        <span class="comment">//Loop through all citizens, and send this message</span></div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;        <a class="code" href="class_citizen_list.html">CitizenList</a>* citizenList = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a4b20894db20b3255da35b65f2b93a24b">getCitizenList</a>();</div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; citizenList-&gt;size(); ++i) {</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;                uint64 oid = citizenList-&gt;get(i);</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;</div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;                <span class="comment">//Skip the person registering.</span></div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;                <span class="keywordflow">if</span> (oid == objectid)</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;</div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;                ManagedReference&lt;SceneObject*&gt; obj = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(oid);</div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;</div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;                <span class="keywordflow">if</span> (obj == NULL || !obj-&gt;isPlayerCreature())</div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;</div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creo = cast&lt;CreatureObject*&gt; (obj.get());</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;                creo-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(params);</div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;        }</div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;}</div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;</div>
<div class="line"><a name="l02185"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abef3f0a0193809488108f3285cd34fee"> 2185</a></span>&#160;<a class="code" href="class_city_specialization.html">CitySpecialization</a>* <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#abef3f0a0193809488108f3285cd34fee">CityManagerImplementation::getCitySpecialization</a>(</div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;                <span class="keyword">const</span> String&amp; name) {</div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa497717f9cff392a7d369a74e741af39">citySpecializations</a>.containsKey(name))</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;                <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;        <span class="keywordflow">return</span> &amp;<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa497717f9cff392a7d369a74e741af39">citySpecializations</a>.get(name);</div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;}</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;</div>
<div class="line"><a name="l02193"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a530ee8f9d85b091dd1cce154a2fede61"> 2193</a></span>&#160;<a class="code" href="class_city_tax.html">CityTax</a>* <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a530ee8f9d85b091dd1cce154a2fede61">CityManagerImplementation::getCityTax</a>(<span class="keywordtype">int</span> idx) {</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;        <span class="keywordflow">if</span> (idx &gt; <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a237d57a92e7fc9be9c859bb0e7118118">cityTaxes</a>.size() - 1 || idx &lt; 0)</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;                <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;</div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;        <span class="keywordflow">return</span> &amp;<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a237d57a92e7fc9be9c859bb0e7118118">cityTaxes</a>.get(idx);</div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;}</div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;</div>
<div class="line"><a name="l02200"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa31cb49656b2d044e646c23d2074bcea"> 2200</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#aa31cb49656b2d044e646c23d2074bcea">CityManagerImplementation::sendMail</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;                <span class="keyword">const</span> String&amp; sender, <span class="keyword">const</span> UnicodeString&amp; subject,</div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a>&amp; params, <a class="code" href="classserver_1_1zone_1_1objects_1_1waypoint_1_1_waypoint_object.html">WaypointObject</a>* waypoint) {</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;        <a class="code" href="classserver_1_1chat_1_1_chat_manager.html">ChatManager</a>* chat = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getChatManager();</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;        <a class="code" href="class_citizen_list.html">CitizenList</a>* citizenList = city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a4b20894db20b3255da35b65f2b93a24b">getCitizenList</a>();</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;</div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;        <span class="keywordflow">if</span> (citizenList == NULL)</div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; citizenList-&gt;size(); ++i) {</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;                uint64 citizenID = citizenList-&gt;get(i);</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;                ManagedReference&lt;SceneObject*&gt; obj = <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#af67b2bec7d445debfbaf514cffe98cdc">zoneServer</a>-&gt;getObject(citizenID);</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;                <span class="keywordflow">if</span> (obj == NULL || !obj-&gt;isPlayerCreature())</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creo = obj.castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>*&gt; ();</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;                <span class="comment">//TODO: Modify Chat Manager so that you can send a creo instead of simply the firstname, since sendMail eventually gets the creo anyways</span></div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;                chat-&gt;<a class="code" href="classserver_1_1chat_1_1_chat_manager.html#ae42a9b310b5485d414670b7bd2741534">sendMail</a>(sender, subject, params, creo-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>(), waypoint);</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;        }</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;}</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;</div>
<div class="line"><a name="l02224"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#adbfd30f70662ba30c37296403bf7441f"> 2224</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#adbfd30f70662ba30c37296403bf7441f">CityManagerImplementation::fixMayor</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city,</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor) {</div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;        <span class="keywordflow">if</span> (mayor == NULL &amp;&amp; !mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#acf5493018ed9c75309bf695a188d297d">isPlayerCreature</a>())</div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;</div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;        uint64 mayorid = mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>();</div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;        <span class="keywordflow">if</span> (city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a0c5202dda669ec9be2e86cc8055d5ea1">isMayor</a>(mayorid) &amp;&amp; !city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a12545e74ea01ac6c44be8cbe199372a7">isCitizen</a>(mayorid)) {</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;                <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#a2d56fa816eaa1bdd3ba935fde75909c9">registerCitizen</a>(city, mayor);</div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;Mayor is already a citizen.&quot;</span>);</div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;        }</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;</div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;}</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;</div>
<div class="line"><a name="l02244"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ab6f3fd8d0454644ca9de9640ab286e0a"> 2244</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ab6f3fd8d0454644ca9de9640ab286e0a">CityManagerImplementation::canSupportMoreDecorations</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city) {</div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;        <span class="keywordflow">if</span> (city == NULL)</div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;</div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;        <span class="keywordflow">return</span> city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#aac874fe482ee7ca468ecb41d603b532a">getDecorationCount</a>() &lt; (<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#acff7e85fe64edea54512de7904f1b99e">decorationsPerRank</a></div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;                        * city-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html#a92998cdb2c5c5d1623c53062718e7b51">getCityRank</a>());</div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;</div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;}</div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;</div>
<div class="line"><a name="l02253"></a><span class="lineno"><a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ae59455ae45dfb5a485a1fee3c363338d"> 2253</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager_implementation.html#ae59455ae45dfb5a485a1fee3c363338d">CityManagerImplementation::sendChangeCityName</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_city_region.html">CityRegion</a>* city, <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* mayor){</div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;        <span class="keywordflow">if</span>(ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a28e55f1da8ea7d975b8a2d9d3c68550a">hasSuiBoxWindowType</a>(<a class="code" href="class_sui_window_type.html#a1d4b176991a00bafe40faa2d564ffd6a">SuiWindowType::CITY_RENAME</a>))</div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;        <span class="keywordflow">if</span>(!mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a00d3ae68696c723a5c492034584c981d">checkCooldownRecovery</a>(<span class="stringliteral">&quot;rename_city_cooldown&quot;</span>) &amp;&amp; !ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#af8a4ad9500d4ad3898954a9bde6e6ea6">isPrivileged</a>()){</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;                mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;You can&#39;t change the city name now&quot;</span>);</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;        }</div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;        ManagedReference&lt;SuiInputBox*&gt; inputBox = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_input_box.html">SuiInputBox</a>(mayor, <a class="code" href="class_sui_window_type.html#a1d4b176991a00bafe40faa2d564ffd6a">SuiWindowType::CITY_RENAME</a>, 0);</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;        inputBox-&gt;setPromptTitle(<span class="stringliteral">&quot;@city/city:city_name_new_t&quot;</span>); <span class="comment">//Change City Name</span></div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;        inputBox-&gt;setPromptText(<span class="stringliteral">&quot;@city/city:city_name_new_d&quot;</span>); <span class="comment">//Enter the new city name below.  Your city must be uniquely named for this planet.  Note that the citizens of your town will receive an email notifying them of the city name change.</span></div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;        inputBox-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_rename_city_sui_callback.html">RenameCitySuiCallback</a>(mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a83c519b8b1e57fcc329e85689ef9fb1a">getZone</a>(), city) );</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;</div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a7154531890864f9e6cc348d32caad0a8">addSuiBox</a>(inputBox);</div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;        mayor-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(inputBox-&gt;generateMessage());</div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 15 2013 17:28:34 for Core3 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
