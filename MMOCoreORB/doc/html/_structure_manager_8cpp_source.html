<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Core3: /Users/victor/git/Core3Mda/MMOCoreORB/src/server/zone/managers/structure/StructureManager.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Core3
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_075bb3ff235063c77951cd176d15a741.html">server</a></li><li class="navelem"><a class="el" href="dir_9e27d73ba17b043ea65c9708c594875e.html">zone</a></li><li class="navelem"><a class="el" href="dir_09f2800c98a68987a1cd7da559bc6100.html">managers</a></li><li class="navelem"><a class="el" href="dir_097362ba2515706d264932bbc2944402.html">structure</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">StructureManager.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_structure_manager_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * StructureManager.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *  Created on: 01/08/2012</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *      Author: swgemu</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_structure_manager_8h.html">StructureManager.h</a>&quot;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="server_2zone_2objects_2scene_2_scene_object_8h.html">server/zone/objects/scene/SceneObject.h</a>&quot;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_config_manager_8h.html">server/conf/ConfigManager.h</a>&quot;</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="server_2zone_2objects_2creature_2_creature_object_8h.html">server/zone/objects/creature/CreatureObject.h</a>&quot;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_planet_manager_8h.html">server/zone/managers/planet/PlanetManager.h</a>&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_g_c_w_manager_8h.html">server/zone/managers/gcw/GCWManager.h</a>&quot;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_shared_structure_object_template_8h.html">server/zone/templates/tangible/SharedStructureObjectTemplate.h</a>&quot;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_zone_server_8h.html">server/zone/ZoneServer.h</a>&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_active_area_8h.html">server/zone/objects/area/ActiveArea.h</a>&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_structure_deed_8h.html">server/zone/objects/tangible/deed/structure/StructureDeed.h</a>&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_region_8h.html">server/zone/objects/region/Region.h</a>&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="server_2zone_2objects_2player_2_player_object_8h.html">server/zone/objects/player/PlayerObject.h</a>&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_place_structure_session_8h.html">server/zone/objects/player/sessions/PlaceStructureSession.h</a>&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_destroy_structure_session_8h.html">server/zone/objects/player/sessions/DestroyStructureSession.h</a>&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_terrain_manager_8h.html">server/zone/managers/terrain/TerrainManager.h</a>&quot;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_cell_object_8h.html">server/zone/objects/cell/CellObject.h</a>&quot;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_building_object_8h.html">server/zone/objects/building/BuildingObject.h</a>&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_region_8h.html">server/zone/objects/region/CityRegion.h</a>&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_city_manager_8h.html">server/zone/managers/city/CityManager.h</a>&quot;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_sui_message_box_8h.html">server/zone/objects/player/sui/messagebox/SuiMessageBox.h</a>&quot;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_sui_transfer_box_8h.html">server/zone/objects/player/sui/transferbox/SuiTransferBox.h</a>&quot;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_sui_input_box_8h.html">server/zone/objects/player/sui/inputbox/SuiInputBox.h</a>&quot;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_structure_pay_uncondemn_maintenance_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/StructurePayUncondemnMaintenanceSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_find_lost_items_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/FindLostItemsSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_delete_all_items_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/DeleteAllItemsSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_structure_status_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/StructureStatusSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_name_structure_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/NameStructureSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_structure_pay_maintenance_sui_callback_8h.html">server/zone/objects/player/sui/callbacks/StructurePayMaintenanceSuiCallback.h</a>&quot;</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_string_id_manager_8h.html">server/zone/managers/stringid/StringIdManager.h</a>&quot;</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_boundary_rectangle_8h.html">server/zone/objects/terrain/layer/boundaries/BoundaryRectangle.h</a>&quot;</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_g_c_w_manager_8h.html">server/zone/managers/gcw/GCWManager.h</a>&quot;</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_destroy_structure_task_8h.html">tasks/DestroyStructureTask.h</a>&quot;</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a1dad44767a8fa310db9be55a5a9c0bc0">   41</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_structure_manager.html#a1dad44767a8fa310db9be55a5a9c0bc0">StructureManager::loadPlayerStructures</a>(<span class="keyword">const</span> String&amp; zoneName) {</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        info(<span class="stringliteral">&quot;Loading player structures from playerstructures.db&quot;</span>);</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        ObjectDatabaseManager* dbManager = ObjectDatabaseManager::instance();</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;        ObjectDatabase* playerStructuresDatabase =</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;                        ObjectDatabaseManager::instance()-&gt;loadObjectDatabase(</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;                                        <span class="stringliteral">&quot;playerstructures&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        <span class="keywordflow">if</span> (playerStructuresDatabase == NULL) {</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;                error(<span class="stringliteral">&quot;Could not load the player structures database.&quot;</span>);</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;        }</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        <span class="keywordtype">int</span> i = 0;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        <span class="keywordflow">try</span> {</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;                ObjectDatabaseIterator iterator(playerStructuresDatabase);</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;                uint64 objectID;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;                ObjectInputStream* objectData = <span class="keyword">new</span> ObjectInputStream(2000);</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;                String zoneReference;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;                <span class="keywordflow">while</span> (iterator.getNextKeyAndValue(objectID, objectData)) {</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;                        <span class="keywordflow">if</span> (!Serializable::getVariable&lt;String&gt;(String(<span class="stringliteral">&quot;SceneObject.zone&quot;</span>).hashCode(),</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                                        &amp;zoneReference, objectData)) {</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;                                objectData-&gt;clear();</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;                                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;                        }</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;                        <span class="keywordflow">if</span> (zoneName != zoneReference) {</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;                                objectData-&gt;clear();</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;                                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;                        }</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                        Reference&lt;SceneObject*&gt; <span class="keywordtype">object</span> = <a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>-&gt;<a class="code" href="classserver_1_1zone_1_1_zone_server.html#a8e09d3df7c2e98ad0b5628552ea27df6">getObject</a>(objectID);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;                        <span class="keywordflow">if</span> (<span class="keywordtype">object</span> != NULL) {</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                                ++i;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;                                <span class="keywordflow">if</span>(object-&gt;isGCWBase()){</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;                                        <a class="code" href="classserver_1_1zone_1_1_zone.html">Zone</a>* zone = <span class="keywordtype">object</span>-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a83c519b8b1e57fcc329e85689ef9fb1a">getZone</a>();</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                                        <span class="keywordflow">if</span>(zone == NULL)</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                                                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                                        <a class="code" href="classserver_1_1zone_1_1managers_1_1gcw_1_1_g_c_w_manager.html">GCWManager</a>* gcwMan = zone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#aa056430c4b957310506f03079dc69b47">getGCWManager</a>();</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                                        <span class="keywordflow">if</span>(gcwMan == NULL)</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                                                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                                        gcwMan-&gt;<a class="code" href="classserver_1_1zone_1_1managers_1_1gcw_1_1_g_c_w_manager.html#a007a748b4e64fbe44ba173c39ab2d16e">registerGCWBase</a>(cast&lt;BuildingObject*&gt;(<span class="keywordtype">object</span>.<span class="keyword">get</span>()),<span class="keyword">false</span>);</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                                }</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                                <span class="keywordflow">if</span> (ConfigManager::instance()-&gt;isProgressMonitorActivated())</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                                        printf(<span class="stringliteral">&quot;\r\tLoading player structures [%d] / [?]\t&quot;</span>, i);</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;                        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;                                error(</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                                                <span class="stringliteral">&quot;Failed to deserialize structure with objectID: &quot;</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                                                                + String::valueOf(objectID));</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                        }</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                        objectData-&gt;clear();</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;                }</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;                <span class="keyword">delete</span> objectData;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        } <span class="keywordflow">catch</span> (DatabaseException&amp; e) {</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                error(</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                                <span class="stringliteral">&quot;Database exception in StructureManager::loadPlayerStructures(): &quot;</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                                                + e.getMessage());</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        }</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        info(String::valueOf(i) + <span class="stringliteral">&quot; player structures loaded for &quot;</span> + zoneName + <span class="stringliteral">&quot;.&quot;</span>,</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                        <span class="keyword">true</span>);</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;}</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno"><a class="code" href="class_structure_manager.html#ae14eab2fa37a1cf6b56c3faf53a1beb4">  119</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="class_structure_manager.html#ae14eab2fa37a1cf6b56c3faf53a1beb4">StructureManager::getStructureFootprint</a>(<a class="code" href="classserver_1_1zone_1_1templates_1_1_shared_object_template.html">SharedObjectTemplate</a>* objectTemplate, <span class="keywordtype">int</span> angle, <span class="keywordtype">float</span>&amp; l0, <span class="keywordtype">float</span>&amp; w0, <span class="keywordtype">float</span>&amp; l1, <span class="keywordtype">float</span>&amp; w1) {</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <a class="code" href="class_shared_structure_object_template.html">SharedStructureObjectTemplate</a>* serverTemplate = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_shared_structure_object_template.html">SharedStructureObjectTemplate</a>*<span class="keyword">&gt;</span>(objectTemplate);</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="keywordflow">if</span> (serverTemplate == NULL)</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        <a class="code" href="class_structure_footprint.html">StructureFootprint</a>* structureFootprint = serverTemplate-&gt;<a class="code" href="class_shared_tangible_object_template.html#ae845f7d66c4dd0e4b37a945533180bb6">getStructureFootprint</a>();</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="comment">//float l = 5; //Along the x axis.</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        <span class="comment">//float w = 5; //Along the y axis.</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keywordflow">if</span> (structureFootprint != NULL) {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                <span class="comment">//if (structureFootprint-&gt;getRowSize() &gt; structureFootprint-&gt;getColSize())</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                <span class="comment">//      angle = angle + 180;</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                <span class="keywordtype">float</span> centerX = (structureFootprint-&gt;<a class="code" href="class_structure_footprint.html#aaa0c8527109f9c0e90ebb168514c52a4">getCenterX</a>() * 8) + 4;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                <span class="keywordtype">float</span> centerY = (structureFootprint-&gt;<a class="code" href="class_structure_footprint.html#af453729a1b559a3b7a0f4d7cf0ada1d2">getCenterY</a>() * 8) + 4;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                <span class="comment">//info (&quot;centerX:&quot; + String::valueOf(centerX) + &quot; centerY:&quot; + String::valueOf(centerY), true);</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                <span class="keywordtype">float</span> topLeftX = -centerX;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                <span class="keywordtype">float</span> topLeftY = (structureFootprint-&gt;<a class="code" href="class_structure_footprint.html#a432c00d5ad6096fc658a6e837fc05744">getRowSize</a>() * 8 ) - centerY;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                <span class="keywordtype">float</span> bottomRightX = (8 * structureFootprint-&gt;<a class="code" href="class_structure_footprint.html#aa455253f652402f6bb4cae052bcbf0e0">getColSize</a>() - centerX);</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                <span class="keywordtype">float</span> bottomRightY = -centerY;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;                w0 = MIN(topLeftX, bottomRightX);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;                l0 = MIN(topLeftY, bottomRightY);</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                w1 = MAX(topLeftX, bottomRightX);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                l1 = MAX(topLeftY, bottomRightY);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;                Matrix4 translationMatrix;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                translationMatrix.setTranslation(0, 0, 0);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;                <span class="keywordtype">float</span> rad = (float)(angle) * Math::DEG2RAD;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                <span class="keywordtype">float</span> cosRad = cos(rad);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;                <span class="keywordtype">float</span> sinRad = sin(rad);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;                Matrix3 rot;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                rot[0][0] = cosRad;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                rot[0][2] = -sinRad;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                rot[1][1] = 1;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                rot[2][0] = sinRad;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                rot[2][2] = cosRad;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;                Matrix4 rotateMatrix;</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                rotateMatrix.setRotationMatrix(rot);</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                Matrix4 moveAndRotate = (translationMatrix * rotateMatrix);</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                Vector3 pointBottom(w0, 0, l0);</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                Vector3 pointTop(w1, 0, l1);</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                Vector3 resultBottom = pointBottom * moveAndRotate;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                Vector3 resultTop = pointTop * moveAndRotate;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                w0 = MIN(resultBottom.getX(), resultTop.getX());</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                l0 = MIN(resultBottom.getZ(), resultTop.getZ());</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;                w1 = MAX(resultTop.getX(), resultBottom.getX());</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                l1 = MAX(resultTop.getZ(), resultBottom.getZ());</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;                <span class="comment">//info(&quot;objectTemplate:&quot; + objectTemplate-&gt;getFullTemplateString() + &quot; :&quot; + structureFootprint-&gt;toString(), true);</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                <span class="comment">//info(&quot;angle:&quot; + String::valueOf(angle) + &quot; w0:&quot; + String::valueOf(w0) + &quot; l0:&quot; + String::valueOf(l0) + &quot; w1:&quot; + String::valueOf(w1) + &quot; l1:&quot; + String::valueOf(l1), true);</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        }</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;}</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div>
<div class="line"><a name="l00189"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a012a21787dcb67a4b55d5866679f1c73">  189</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="class_structure_manager.html#a012a21787dcb67a4b55d5866679f1c73">StructureManager::placeStructureFromDeed</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature,</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1deed_1_1structure_1_1_structure_deed.html">StructureDeed</a>* deed, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">int</span> angle) {</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        ManagedReference&lt;Zone*&gt; zone = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a83c519b8b1e57fcc329e85689ef9fb1a">getZone</a>();</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <span class="comment">//Already placing a structure?</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        <span class="keywordflow">if</span> (zone == NULL</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                        || creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a000e42ba7c8a14db91e82dbf12c54232">containsActiveSession</a>(</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                                        <a class="code" href="class_session_facade_type.html#a16fde8e2f317dc291b4bd7dc128efcab">SessionFacadeType::PLACESTRUCTURE</a>))</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        ManagedReference&lt;PlanetManager*&gt; planetManager = zone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#a47f3a3d6d076c833e76dbd682b1c069f">getPlanetManager</a>();</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        String serverTemplatePath = deed-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1deed_1_1_deed.html#a1fd9817d2e5df00a869d5265e2f5dd65">getGeneratedObjectTemplate</a>();</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        <span class="keywordflow">if</span> (deed-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#ad09f60b9095d5e921af9c8908b1bce8e">getFaction</a>() != 0 &amp;&amp; creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#ad09f60b9095d5e921af9c8908b1bce8e">getFaction</a>() != deed-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#ad09f60b9095d5e921af9c8908b1bce8e">getFaction</a>()) {</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;You are not the correct faction&quot;</span>);</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        }</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        Reference&lt;SharedStructureObjectTemplate*&gt; serverTemplate =</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                        <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_shared_structure_object_template.html">SharedStructureObjectTemplate</a>*<span class="keyword">&gt;</span>(<a class="code" href="class_structure_manager.html#aaa369f70e8680b35315f74431dab6408">templateManager</a>-&gt;<a class="code" href="class_template_manager.html#ab7a7a7985cf7d669fed4dda137c6d29a">getTemplate</a>(</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                                        serverTemplatePath.hashCode()));</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        <span class="comment">//Check to see if this zone allows this structure.</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;        <span class="keywordflow">if</span> (serverTemplate == NULL</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;                        || !serverTemplate-&gt;isAllowedZone(zone-&gt;getZoneName())) {</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:wrong_planet&quot;</span>); <span class="comment">//That deed cannot be used on this planet.</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        }</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="keywordflow">if</span> (!planetManager-&gt;isBuildingPermittedAt(x, y, creature)) {</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:not_permitted&quot;</span>); <span class="comment">//Building is not permitted here.</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        }</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        SortedVector&lt;ManagedReference&lt;ActiveArea*&gt; &gt; objects;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        zone-&gt;getInRangeActiveAreas(x, y, &amp;objects, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        ManagedReference&lt;CityRegion*&gt; city;</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; objects.size(); ++i) {</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1area_1_1_active_area.html">ActiveArea</a>* area = objects.get(i).get();</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;                <span class="keywordflow">if</span> (!area-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1area_1_1_active_area.html#a00018fc7d855efa5228a36bd146def17">isRegion</a>())</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                city = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classserver_1_1zone_1_1objects_1_1region_1_1_region.html">Region</a>*<span class="keyword">&gt;</span>(area)-&gt;getCityRegion();</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                <span class="keywordflow">if</span> (city != NULL)</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                        <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        }</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        SortedVector&lt;ManagedReference&lt;QuadTreeEntry*&gt; &gt; inRangeObjects;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        zone-&gt;getInRangeObjects(x, y, 128, &amp;inRangeObjects, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <span class="keywordtype">float</span> placingFootprintLength0, placingFootprintWidth0, placingFootprintLength1, placingFootprintWidth1;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="class_structure_manager.html#ae14eab2fa37a1cf6b56c3faf53a1beb4">getStructureFootprint</a>(serverTemplate, angle, placingFootprintLength0, placingFootprintWidth0, placingFootprintLength1, placingFootprintWidth1)) {</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                <span class="keywordtype">float</span> x0 = x + placingFootprintWidth0;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                <span class="keywordtype">float</span> y0 = y + placingFootprintLength0;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                <span class="keywordtype">float</span> x1 = x + placingFootprintWidth1;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                <span class="keywordtype">float</span> y1 = y + placingFootprintLength1;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                <a class="code" href="class_boundary_rectangle.html">BoundaryRectangle</a> placingFootprint(x0, y0, x1, y1);</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                <span class="comment">//info(&quot;placing center x:&quot; + String::valueOf(x) + &quot; y:&quot; + String::valueOf(y), true);</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                <span class="comment">//info(&quot;placingFootprint x0:&quot; + String::valueOf(x0) + &quot; y0:&quot; + String::valueOf(y0) + &quot; x1:&quot; + String::valueOf(x1) + &quot; y1:&quot; + String::valueOf(y1), true);</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; inRangeObjects.size(); ++i) {</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                        <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* scene = inRangeObjects.get(i).castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>*&gt;();</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                        <span class="keywordflow">if</span> (scene == NULL)</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                        <span class="keywordtype">float</span> l0 = -5; <span class="comment">//Along the x axis.</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                        <span class="keywordtype">float</span> w0 = -5; <span class="comment">//Along the y axis.</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                        <span class="keywordtype">float</span> l1 = 5;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                        <span class="keywordtype">float</span> w1 = 5;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;                        <span class="keywordflow">if</span> (<a class="code" href="class_structure_manager.html#ae14eab2fa37a1cf6b56c3faf53a1beb4">getStructureFootprint</a>(scene-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a49977bbe7ffeb660df3173c94421068b">getObjectTemplate</a>(), scene-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a910e0278f19ab10c39bf564a1b068b68">getDirectionAngle</a>(), l0, w0, l1, w1))</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                        <span class="keywordtype">float</span> xx0 = scene-&gt;getPositionX() + (w0 + 0.1);</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                        <span class="keywordtype">float</span> yy0 = scene-&gt;getPositionY() + (l0 + 0.1);</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;                        <span class="keywordtype">float</span> xx1 = scene-&gt;getPositionX() + (w1 - 0.1);</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                        <span class="keywordtype">float</span> yy1 = scene-&gt;getPositionY() + (l1 - 0.1);</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                        <a class="code" href="class_boundary_rectangle.html">BoundaryRectangle</a> rect(xx0, yy0, xx1, yy1);</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                        <span class="comment">//info(&quot;existing footprint xx0:&quot; + String::valueOf(xx0) + &quot; yy0:&quot; + String::valueOf(yy0) + &quot; xx1:&quot; + String::valueOf(xx1) + &quot; yy1:&quot; + String::valueOf(yy1), true);</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                        <span class="comment">// check 4 points of the current rect</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                        <span class="keywordflow">if</span> (rect.<a class="code" href="class_boundary_rectangle.html#aa37efb7980ce0f5d2b1ad4eb242b6862">containsPoint</a>(x0, y0)</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                                        || rect.<a class="code" href="class_boundary_rectangle.html#aa37efb7980ce0f5d2b1ad4eb242b6862">containsPoint</a>(x0, y1)</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                                        || rect.<a class="code" href="class_boundary_rectangle.html#aa37efb7980ce0f5d2b1ad4eb242b6862">containsPoint</a>(x1, y0)</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                                        || rect.<a class="code" href="class_boundary_rectangle.html#aa37efb7980ce0f5d2b1ad4eb242b6862">containsPoint</a>(x1, y1) ) {</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                                <span class="comment">//info(&quot;existing footprint contains placing point&quot;, true);</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:no_room&quot;</span>); <span class="comment">//there is no room to place the structure here..</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                        }</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;                        <span class="keywordflow">if</span> (placingFootprint.<a class="code" href="class_boundary_rectangle.html#aa37efb7980ce0f5d2b1ad4eb242b6862">containsPoint</a>(xx0, yy0)</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;                                        || placingFootprint.<a class="code" href="class_boundary_rectangle.html#aa37efb7980ce0f5d2b1ad4eb242b6862">containsPoint</a>(xx0, yy1)</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;                                        || placingFootprint.<a class="code" href="class_boundary_rectangle.html#aa37efb7980ce0f5d2b1ad4eb242b6862">containsPoint</a>(xx1, yy0)</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;                                        || placingFootprint.<a class="code" href="class_boundary_rectangle.html#aa37efb7980ce0f5d2b1ad4eb242b6862">containsPoint</a>(xx1, yy1)</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;                                        || (xx0 == x0 &amp;&amp; yy0 == y0 &amp;&amp; xx1 == x1 &amp;&amp; yy1 == y1)) {</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;                                <span class="comment">//info(&quot;placing footprint contains existing point&quot;, true);</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;                                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:no_room&quot;</span>); <span class="comment">//there is no room to place the structure here.</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;                                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;                        }</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;                }</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        }</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        <span class="keywordtype">int</span> rankRequired = serverTemplate-&gt;getCityRankRequired();</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <span class="keywordflow">if</span> (city == NULL &amp;&amp; rankRequired &gt; 0) {</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:build_no_city&quot;</span>);</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        }</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        <span class="keywordflow">if</span> (city != NULL) {</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                <span class="keywordflow">if</span> (city-&gt;isZoningEnabled()</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                                &amp;&amp; !city-&gt;hasZoningRights(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>())) {</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:no_rights&quot;</span>); <span class="comment">//You don&#39;t have the right to place that structure in this city. The mayor or one of the city milita must grant you zoning rights first.</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                }</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                <span class="keywordflow">if</span> (rankRequired != 0 &amp;&amp; city-&gt;getCityRank() &lt; rankRequired) {</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> param(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;rank_req&quot;</span>);</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                        param.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#aa35ce7d0a7a3b96baff3e88100b3f5f8">setDI</a>(rankRequired);</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                        param.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(<span class="stringliteral">&quot;city/city&quot;</span>, <span class="stringliteral">&quot;rank&quot;</span> + String::valueOf(rankRequired));</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(param);</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                }</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                <span class="keywordflow">if</span> (serverTemplate-&gt;isCivicStructure() &amp;&amp; !city-&gt;isMayor(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>()) ) {</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:cant_place_civic&quot;</span>);<span class="comment">//&quot;This structure must be placed within the borders of the city in which you are mayor.&quot;</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                }</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                <span class="keywordflow">if</span> (serverTemplate-&gt;isUniqueStructure()</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                                &amp;&amp; city-&gt;hasUniqueStructure(</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                                                serverTemplate-&gt;getServerObjectCRC())) {</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:cant_place_unique&quot;</span>); <span class="comment">//This city can only support a single structure of this type.</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                }</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        }</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        Locker _lock(deed, creature);</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        <span class="keywordflow">if</span>(serverTemplate-&gt;isDerivedFrom(<span class="stringliteral">&quot;object/building/faction_perk/base/shared_factional_building_base.iff&quot;</span>)){</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                <a class="code" href="classserver_1_1zone_1_1_zone.html">Zone</a>* zone = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a83c519b8b1e57fcc329e85689ef9fb1a">getZone</a>();</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                <span class="keywordflow">if</span>(zone == NULL)</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                <a class="code" href="classserver_1_1zone_1_1managers_1_1gcw_1_1_g_c_w_manager.html">GCWManager</a>* gcwMan = zone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#aa056430c4b957310506f03079dc69b47">getGCWManager</a>();</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                <span class="keywordflow">if</span>(gcwMan == NULL)</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                <span class="keywordflow">if</span>(!gcwMan-&gt;<a class="code" href="classserver_1_1zone_1_1managers_1_1gcw_1_1_g_c_w_manager.html#a4ae5ba963161fae5dc0f8cf9e3d78f3b">canPlaceMoreBases</a>(creature))</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        }</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        <span class="comment">//Ensure that it is the correct deed, and that it is in a container in the creature&#39;s inventory.</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="keywordflow">if</span> (deed == NULL || !deed-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#afd39e1d755b790a6d96e5fb050aa7ca5">isASubChildOf</a>(creature)) {</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:no_possession&quot;</span>); <span class="comment">//You no longer are in possession of the deed for this structure. Aborting construction.</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        }</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        <a class="code" href="class_template_manager.html">TemplateManager</a>* <a class="code" href="class_structure_manager.html#aaa369f70e8680b35315f74431dab6408">templateManager</a> = TemplateManager::instance();</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="keywordflow">if</span> (ghost != NULL) {</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                String abilityRequired = serverTemplate-&gt;getAbilityRequired();</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                <span class="keywordflow">if</span> (!abilityRequired.isEmpty() &amp;&amp; !ghost-&gt;hasAbility(abilityRequired)) {</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:&quot;</span> + abilityRequired);</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                }</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                <span class="keywordtype">int</span> lots = serverTemplate-&gt;getLotSize();</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                <span class="keywordflow">if</span> (!ghost-&gt;hasLotsRemaining(lots)) {</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> param(<span class="stringliteral">&quot;@player_structure:not_enough_lots&quot;</span>);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                        param.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#aa35ce7d0a7a3b96baff3e88100b3f5f8">setDI</a>(lots);</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(param);</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                }</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        }</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        <span class="comment">//Validate that the structure can be placed at the given coordinates:</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="comment">//Ensure that no other objects impede on this structures footprint, or overlap any city regions or no build areas.</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        <span class="comment">//Make sure that the player has zoning rights in the area.</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;        ManagedReference&lt;PlaceStructureSession*&gt; session =</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                        <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sessions_1_1_place_structure_session.html">PlaceStructureSession</a>(creature, deed);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#aa2090f0934065e8c52d2841d9540ddd4">addActiveSession</a>(<a class="code" href="class_session_facade_type.html#a16fde8e2f317dc291b4bd7dc128efcab">SessionFacadeType::PLACESTRUCTURE</a>, session);</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;        <span class="comment">//Construct the structure.</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        session-&gt;constructStructure(x, y, angle);</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <span class="comment">//Remove the deed from it&#39;s container.</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        deed-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a2271c9f2c7daf53aa576ccfc9dea2dfa">destroyObjectFromWorld</a>(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;}</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div>
<div class="line"><a name="l00405"></a><span class="lineno"><a class="code" href="class_structure_manager.html#ad875aa56c2aae84f53f9100c502b18c3">  405</a></span>&#160;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* <a class="code" href="class_structure_manager.html#ad875aa56c2aae84f53f9100c502b18c3">StructureManager::placeStructure</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature,</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                <span class="keyword">const</span> String&amp; structureTemplatePath, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">int</span> angle) {</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        ManagedReference&lt;Zone*&gt; zone = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a83c519b8b1e57fcc329e85689ef9fb1a">getZone</a>();</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        <span class="keywordflow">if</span> (zone == NULL)</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <a class="code" href="class_terrain_manager.html">TerrainManager</a>* terrainManager =</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                        zone-&gt;getPlanetManager()-&gt;getTerrainManager();</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <a class="code" href="class_shared_structure_object_template.html">SharedStructureObjectTemplate</a>* serverTemplate =</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                        <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_shared_structure_object_template.html">SharedStructureObjectTemplate</a>*<span class="keyword">&gt;</span>(<a class="code" href="class_structure_manager.html#aaa369f70e8680b35315f74431dab6408">templateManager</a>-&gt;<a class="code" href="class_template_manager.html#ab7a7a7985cf7d669fed4dda137c6d29a">getTemplate</a>(</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                                        structureTemplatePath.hashCode()));</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <span class="keywordflow">if</span> (serverTemplate == NULL) {</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                info(<span class="stringliteral">&quot;server template is null&quot;</span>);</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        }</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        <span class="keywordtype">float</span> z = zone-&gt;getHeight(x, y);</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <span class="keywordtype">float</span> floraRadius = serverTemplate-&gt;<a class="code" href="classserver_1_1zone_1_1templates_1_1_shared_object_template.html#add2c5dd0a779e0d7d48595daf9174811">getClearFloraRadius</a>();</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        <span class="keywordtype">bool</span> snapToTerrain = serverTemplate-&gt;<a class="code" href="classserver_1_1zone_1_1templates_1_1_shared_object_template.html#a63df831706f24851f36565f42ded2afc">getSnapToTerrain</a>();</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        Reference&lt;StructureFootprint*&gt; structureFootprint =</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                        serverTemplate-&gt;<a class="code" href="class_shared_tangible_object_template.html#ae845f7d66c4dd0e4b37a945533180bb6">getStructureFootprint</a>();</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        <span class="keywordtype">float</span> w0 = -5; <span class="comment">//Along the x axis.</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        <span class="keywordtype">float</span> l0 = -5; <span class="comment">//Along the y axis.</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <span class="keywordtype">float</span> l1 = 5;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        <span class="keywordtype">float</span> w1 = 5;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        <span class="keywordtype">float</span> zIncreaseWhenNoAvailableFootprint = 0.f; <span class="comment">//TODO: remove this when it has been verified that all buildings have astructure footprint.</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="keywordflow">if</span> (structureFootprint != NULL) {</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                <span class="comment">//If the angle is odd, then swap them.</span></div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;                <a class="code" href="class_structure_manager.html#ae14eab2fa37a1cf6b56c3faf53a1beb4">getStructureFootprint</a>(serverTemplate, angle, l0, w0, l1, w1);</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                <span class="keywordflow">if</span> (!serverTemplate-&gt;<a class="code" href="classserver_1_1zone_1_1templates_1_1_shared_object_template.html#ab04394027ca874c1f92830474f54db28">isCampStructureTemplate</a>())</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                        warning(</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                                        <span class="stringliteral">&quot;Structure with template &#39;&quot;</span> + structureTemplatePath</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;                                                        + <span class="stringliteral">&quot;&#39; has no structure footprint.&quot;</span>);</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                zIncreaseWhenNoAvailableFootprint = 5.f;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        }</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        <span class="keywordflow">if</span> (floraRadius &gt; 0 &amp;&amp; !snapToTerrain)</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;                z = terrainManager-&gt;<a class="code" href="class_terrain_manager.html#a323f11072d0aacf5429c6d8690a98b6d">getHighestHeight</a>(x + w0, y + l0, x + w1, y + l1, 1)</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;                                + zIncreaseWhenNoAvailableFootprint;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        String strDatabase = <span class="stringliteral">&quot;playerstructures&quot;</span>;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        <span class="keywordtype">bool</span> bIsFactionBuilding = (serverTemplate-&gt;<a class="code" href="classserver_1_1zone_1_1templates_1_1_shared_object_template.html#a2644a4924e98968febb9aa8631348b16">getGameObjectType</a>()</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;                        == <a class="code" href="class_scene_object_type.html#ab159470dc7ebe48331cfb4c39aa9943c">SceneObjectType::FACTIONBUILDING</a>);</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        <span class="keywordflow">if</span> (bIsFactionBuilding || serverTemplate-&gt;<a class="code" href="classserver_1_1zone_1_1templates_1_1_shared_object_template.html#a2644a4924e98968febb9aa8631348b16">getGameObjectType</a>() == <a class="code" href="class_scene_object_type.html#a3edbb6c438429d304a012c5886851a49">SceneObjectType::TURRET</a>) {</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                strDatabase = <span class="stringliteral">&quot;playerstructures&quot;</span>;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        }</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        ManagedReference&lt;SceneObject*&gt; obj =</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;                        ObjectManager::instance()-&gt;createObject(</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;                                        structureTemplatePath.hashCode(), 1, strDatabase);</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="keywordflow">if</span> (obj == NULL || !obj-&gt;isStructureObject()) {</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                <span class="keywordflow">if</span> (obj != NULL)</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;                        obj-&gt;destroyObjectFromDatabase(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                error(</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                                <span class="stringliteral">&quot;Failed to create structure with template: &quot;</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                                                + structureTemplatePath);</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        }</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structureObject = cast&lt;StructureObject*&gt;(obj.get());</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a7dbf2dcd8af0ed2ee30440e466a31d63">setOwnerObjectID</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>());</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a5e59650f4a77de2860db37171c44ac73">grantPermission</a>(<span class="stringliteral">&quot;ADMIN&quot;</span>, creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>());</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a98695a6273ce2f05ccf349231c50443f">setOwnerName</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>());</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        <span class="keywordflow">if</span>(structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#aecd298357968c484a39566cf9f4ad498">isTurret</a>() || structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a4c292fea68b9714008433296f2b56a65">isMinefield</a>()){</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#af5907cc6e1cce27fae8d1d21e92c4d82">setFaction</a>(creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html#ad09f60b9095d5e921af9c8908b1bce8e">getFaction</a>());</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;        }</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1building_1_1_building_object.html">BuildingObject</a>* buildingObject = NULL;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        <span class="keywordflow">if</span> (structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#af6239c08a91da25525461b4cabe43a0e">isBuildingObject</a>()) {</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;                buildingObject = cast&lt;BuildingObject*&gt;(structureObject);</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;                <span class="keywordflow">if</span> (buildingObject != NULL)</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;                        buildingObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1building_1_1_building_object.html#aaace1cf07ba221786576327158d3b909">createCellObjects</a>();</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        }</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;        structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#aba9c9b0c9fa825ad064a28c4a72c8373">setPublicStructure</a>(serverTemplate-&gt;<a class="code" href="class_shared_structure_object_template.html#a4f41f8ca7f751fbb4bc8c4f2de829f7e">isPublicStructure</a>());</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        structureObject-&gt;initializePosition(x, z, y);</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a3f3fbcae54e5ef77f451e38a912fb95f">rotate</a>(angle);</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        <span class="comment">//structureObject-&gt;insertToZone(zone);</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        zone-&gt;transferObject(structureObject, -1, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a53c35e445ec4433215532310a9040657">createChildObjects</a>();</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a9cbe523005288ae29a559b2af61c0038">notifyStructurePlaced</a>(creature);</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        <span class="keywordflow">return</span> structureObject;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;}</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div>
<div class="line"><a name="l00503"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a2b0fc6c932dc051265026bd538cd2066">  503</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="class_structure_manager.html#a2b0fc6c932dc051265026bd538cd2066">StructureManager::destroyStructure</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structureObject) {</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        Reference&lt;DestroyStructureTask*&gt; task = <span class="keyword">new</span> <a class="code" href="class_destroy_structure_task.html">DestroyStructureTask</a>(structureObject);</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        task-&gt;execute();</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="comment">/*ManagedReference&lt;Zone*&gt; zone = structureObject-&gt;getZone();</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">        if (zone == NULL)</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="comment">                return 0;</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">        float x = structureObject-&gt;getPositionX();</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment">        float y = structureObject-&gt;getPositionY();</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="comment">        float z = zone-&gt;getHeight(x, y);</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="comment">        if (structureObject-&gt;isBuildingObject()) {</span></div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="comment">                ManagedReference&lt;BuildingObject*&gt; buildingObject =</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment">                                cast&lt;BuildingObject*&gt;(structureObject);</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="comment">                for (uint32 i = 1; i &lt;= buildingObject-&gt;getTotalCellNumber(); ++i) {</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="comment">                        ManagedReference&lt;CellObject*&gt; cellObject = buildingObject-&gt;getCell(</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="comment">                                        i);</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="comment">                        int childObjects = cellObject-&gt;getContainerObjectsSize();</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="comment">                        if (cellObject == NULL || childObjects &lt;= 0)</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">                                continue;</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="comment">                        //Traverse the vector backwards since the size will change as objects are removed.</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment">                        for (int j = childObjects - 1; j &gt;= 0; --j) {</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="comment">                                ManagedReference&lt;SceneObject*&gt; obj =</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="comment">                                                cellObject-&gt;getContainerObject(j);</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="comment">                                if (obj-&gt;isPlayerCreature()) {</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="comment">                                        CreatureObject* playerCreature =</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="comment">                                                        cast&lt;CreatureObject*&gt;(obj.get());</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="comment">                                        playerCreature-&gt;teleport(x, z, y, 0);</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="comment">                                }</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="comment">                        }</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="comment">                }</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="comment">        }</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">        //Get the owner of the structure, and remove the structure from their possession.</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="comment">        ManagedReference&lt;SceneObject*&gt; owner = zone-&gt;getZoneServer()-&gt;getObject(</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">                        structureObject-&gt;getOwnerObjectID());</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="comment">        if (owner != NULL) {</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="comment">                ManagedReference&lt;SceneObject*&gt; ghost = owner-&gt;getSlottedObject(&quot;ghost&quot;);</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="comment">                if (ghost != NULL &amp;&amp; ghost-&gt;isPlayerObject()) {</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="comment">                        PlayerObject* playerObject = cast&lt;PlayerObject*&gt;(ghost.get());</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="comment">                        playerObject-&gt;removeOwnedStructure(structureObject);</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="comment">                }</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="comment">        }</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">        structureObject-&gt;destroyObjectFromWorld(true);</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">        structureObject-&gt;destroyObjectFromDatabase(true);</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="comment">        structureObject-&gt;notifyObservers(ObserverEventType::OBJECTDESTRUCTION, structureObject, 0);</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="comment">        return 0;*/</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;}</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div>
<div class="line"><a name="l00565"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a71107fdda9bed9244468b142213edc7c">  565</a></span>&#160;String <a class="code" href="class_structure_manager.html#a71107fdda9bed9244468b142213edc7c">StructureManager::getTimeString</a>(uint32 timestamp) {</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <span class="keywordflow">if</span>( timestamp == 0 ){</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        }</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;        String abbrvs[3] = { <span class="stringliteral">&quot;minutes&quot;</span>, <span class="stringliteral">&quot;hours&quot;</span>, <span class="stringliteral">&quot;days&quot;</span> };</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;        <span class="keywordtype">int</span> intervals[3] = { 60, 3600, 86400 };</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        <span class="keywordtype">int</span> values[3] = { 0, 0, 0 };</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        StringBuffer str;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 2; i &gt; -1; --i) {</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                values[i] = floor((<span class="keywordtype">float</span>) timestamp / intervals[i]);</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                timestamp -= values[i] * intervals[i];</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                <span class="keywordflow">if</span> (values[i] &gt; 0) {</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                        <span class="keywordflow">if</span> (str.length() &gt; 0){</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                                str &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                        }</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                        str &lt;&lt; values[i] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; abbrvs[i];</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                }</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        }</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        <span class="keywordflow">return</span> <span class="stringliteral">&quot;(&quot;</span> + str.toString() + <span class="stringliteral">&quot;)&quot;</span>;</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;}</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div>
<div class="line"><a name="l00594"></a><span class="lineno"><a class="code" href="class_structure_manager.html#adc179ab2702212cefee16687c53da527">  594</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="class_structure_manager.html#adc179ab2702212cefee16687c53da527">StructureManager::declareResidence</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* player,</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structureObject) {</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        <span class="keywordflow">if</span> (!structureObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#af6239c08a91da25525461b4cabe43a0e">isBuildingObject</a>()) {</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;                player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                                <span class="stringliteral">&quot;@player_structure:residence_must_be_building&quot;</span>); <span class="comment">//Your declared residence must be a building.</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        }</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;        <span class="keywordflow">if</span> (!player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a00d3ae68696c723a5c492034584c981d">checkCooldownRecovery</a>(<span class="stringliteral">&quot;declare_residence&quot;</span>) &amp;&amp; !ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#af8a4ad9500d4ad3898954a9bde6e6ea6">isPrivileged</a>()) {</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                Time* timeremaining = player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad5a0e79832f01f0b233d75e33b83f5cf">getCooldownTime</a>(<span class="stringliteral">&quot;declare_residence&quot;</span>);</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;player_structure&quot;</span>,</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                                <span class="stringliteral">&quot;change_residence_time&quot;</span>); <span class="comment">//You cannot change residence for %NO hours.</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                params.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#acef7284c4d5a0686ccc5a5cc19b7a581">setTO</a>(</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;                                String::valueOf(</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;                                                ceil(timeremaining-&gt;miliDifference() / -3600000.f)));</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;                player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(params);</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        }</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        ManagedReference&lt;BuildingObject*&gt; buildingObject =</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                        cast&lt;BuildingObject*&gt;(structureObject);</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        <span class="keywordflow">if</span> (!buildingObject-&gt;isOwnerOf(player)) {</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:declare_must_be_owner&quot;</span>); <span class="comment">//You must be the owner of the building to declare residence.</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        }</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        uint64 objectid = player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ae94c183ef49973a95acfbae3fc382366">getObjectID</a>();</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        uint64 declaredOidResidence = ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a0174bd18a3f8f399d3cf07f71791f64d">getDeclaredResidence</a>();</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        ManagedReference&lt;BuildingObject*&gt; declaredResidence =</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                        <a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>-&gt;<a class="code" href="classserver_1_1zone_1_1_zone_server.html#a8e09d3df7c2e98ad0b5628552ea27df6">getObject</a>(declaredOidResidence).castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1building_1_1_building_object.html">BuildingObject</a>*&gt;();</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        ManagedReference&lt;CityRegion*&gt; cityRegion = buildingObject-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a6ed514df7f0abf4ca435a11c5b5c6c96">getCityRegion</a>();</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager.html">CityManager</a>* cityManager = <a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>-&gt;<a class="code" href="classserver_1_1zone_1_1_zone_server.html#aabad05b5911aa70a9a3202861e48893e">getCityManager</a>();</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        <span class="keywordflow">if</span> (declaredResidence != NULL) {</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                <span class="keywordflow">if</span> (declaredResidence == buildingObject) {</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                        player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:already_residence&quot;</span>); <span class="comment">//This building is already your residence.</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                }</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                ManagedReference&lt;CityRegion*&gt; residentCity =</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                                declaredResidence-&gt;getCityRegion();</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                <span class="keywordflow">if</span> (residentCity != NULL) {</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                        Locker lock(residentCity, player);</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                        <span class="keywordflow">if</span> (residentCity-&gt;isMayor(objectid)) {</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                                player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:mayor_residence_change&quot;</span>); <span class="comment">//As a city Mayor, your residence is always the city hall of the city in which you are mayor.  You cannot declare a new residence.</span></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                                <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                        }</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                        cityManager-&gt;<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager.html#a493fb68cf6310513b74b7a0a2681a996">unregisterCitizen</a>(residentCity, player);</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                }</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:change_residence&quot;</span>); <span class="comment">//You change your residence to this building.</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:declared_residency&quot;</span>); <span class="comment">//You have declared your residency here.</span></div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        }</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        <span class="keywordflow">if</span> (cityRegion != NULL) {</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                Locker lock(cityRegion, player);</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                <span class="keywordflow">if</span> (cityRegion-&gt;isMayor(objectid) &amp;&amp; structureObject != cityRegion-&gt;getCityHall()) {</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                        player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@city/city:mayor_residence_change&quot;</span>); <span class="comment">//As a city Mayor, your residence is always the city hall of the city in which you are mayor.  You cannot declare a new residence.</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                }</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                cityManager-&gt;<a class="code" href="classserver_1_1zone_1_1managers_1_1city_1_1_city_manager.html#a5073b26528130f324749bf44b529943a">registerCitizen</a>(cityRegion, player);</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        }</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        <span class="comment">//Set the characters home location to this structure.</span></div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;        ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#a483ee9bb944e7e4d1a4db1e411d7c98c">setDeclaredResidence</a>(buildingObject);</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        <span class="keywordflow">if</span>(declaredResidence != NULL){</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;                Locker oldLock(declaredResidence, player);</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;                declaredResidence-&gt;setResidence(<span class="keyword">false</span>);</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        }</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        Locker newLock(buildingObject,player);</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        buildingObject-&gt;setResidence(<span class="keyword">true</span>);</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;        player-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a9267544fb30b04445f5b2933f4b11907">addCooldown</a>(<span class="stringliteral">&quot;declare_residence&quot;</span>, 24 * 3600 * 1000); <span class="comment">//1 day</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;}</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;</div>
<div class="line"><a name="l00688"></a><span class="lineno"><a class="code" href="class_structure_manager.html#af8fb500e8da9dbd1e23c784f2189c420">  688</a></span>&#160;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* <a class="code" href="class_structure_manager.html#af8fb500e8da9dbd1e23c784f2189c420">StructureManager::getInRangeParkingGarage</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* obj,</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                <span class="keywordtype">int</span> range) {</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        ManagedReference&lt;Zone*&gt; zone = obj-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a83c519b8b1e57fcc329e85689ef9fb1a">getZone</a>();</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        <span class="keywordflow">if</span> (zone == NULL)</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        SortedVector&lt;ManagedReference&lt;QuadTreeEntry*&gt; &gt; closeSceneObjects;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        zone-&gt;<a class="code" href="classserver_1_1zone_1_1_zone.html#a0368cb41425dc57613c5f292401fcc44">getInRangeObjects</a>(obj-&gt;getPositionX(), obj-&gt;getPositionY(), 128,</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;                        &amp;closeSceneObjects, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; closeSceneObjects.size(); ++i) {</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* scno = cast&lt;SceneObject*&gt;(closeSceneObjects.get(i).get());</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;                <span class="keywordflow">if</span> (scno == obj)</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;                        <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;                <span class="keywordflow">if</span> (scno-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a0151bf4ab26360e4df272993f38622cd">isGarage</a>() &amp;&amp; scno-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ad2506e688bcb2a9d653ecb1057884260">isInRange</a>(obj, range))</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;                        <span class="keywordflow">return</span> scno;</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;        }</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;}</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div>
<div class="line"><a name="l00713"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a4421e5c904733c503cc183430c503dbf">  713</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="class_structure_manager.html#a4421e5c904733c503cc183430c503dbf">StructureManager::redeedStructure</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature) {</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        ManagedReference&lt;DestroyStructureSession*&gt; session = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a574a6ad43037b1d25e948c9cdb21be18">getActiveSession</a>(<a class="code" href="class_session_facade_type.html#adf69f740a6cb37832657f0df4a51a16c">SessionFacadeType::DESTROYSTRUCTURE</a>).castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sessions_1_1_destroy_structure_session.html">DestroyStructureSession</a>*&gt;();</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        <span class="keywordflow">if</span> (session == NULL)</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;        ManagedReference&lt;StructureObject*&gt; structureObject =</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                        session-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sessions_1_1_destroy_structure_session.html#ae645d684ae71914b45248eb5191d2e4d">getStructureObject</a>();</div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        <span class="keywordflow">if</span> (structureObject == NULL)</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        Locker _locker(structureObject);</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        ManagedReference&lt;StructureDeed*&gt; deed =</div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                        <a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>-&gt;<a class="code" href="classserver_1_1zone_1_1_zone_server.html#a8e09d3df7c2e98ad0b5628552ea27df6">getObject</a>(</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                                        structureObject-&gt;getDeedObjectID()).castTo&lt;StructureDeed*&gt;();</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        <span class="keywordtype">int</span> maint = structureObject-&gt;getSurplusMaintenance();</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        <span class="keywordtype">int</span> redeedCost = structureObject-&gt;getRedeedCost();</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;</div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="keywordflow">if</span> (deed != NULL &amp;&amp; structureObject-&gt;isRedeedable()) {</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                Locker _lock(deed, structureObject);</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                ManagedReference&lt;SceneObject*&gt; inventory = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a849f36343da6cfb8a4e8f1b138669ab1">getSlottedObject</a>(</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                                <span class="stringliteral">&quot;inventory&quot;</span>);</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                <span class="keywordflow">if</span> (inventory == NULL || inventory-&gt;isContainerFull()) {</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:inventory_full&quot;</span>); <span class="comment">//This installation can not be redeeded because your inventory does not have room to put the deed.</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;                                        <span class="stringliteral">&quot;@player_structure:deed_reclaimed_failed&quot;</span>); <span class="comment">//Structure destroy and deed reclaimed FAILED!</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;                        <span class="keywordflow">return</span> session-&gt;cancelSession();</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;                        deed-&gt;setSurplusMaintenance(maint - redeedCost);</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;                        deed-&gt;setSurplusPower(structureObject-&gt;getSurplusPower());</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;                        structureObject-&gt;setDeedObjectID(0); <span class="comment">//Set this to 0 so the deed doesn&#39;t get destroyed with the structure.</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;                        <a class="code" href="class_structure_manager.html#a2b0fc6c932dc051265026bd538cd2066">destroyStructure</a>(structureObject);</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;                        inventory-&gt;transferObject(deed, -1, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                        inventory-&gt;broadcastObject(deed, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:deed_reclaimed&quot;</span>); <span class="comment">//Structure destroyed and deed reclaimed.</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;                }</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;                <a class="code" href="class_structure_manager.html#a2b0fc6c932dc051265026bd538cd2066">destroyStructure</a>(structureObject);</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:structure_destroyed&quot;</span>); <span class="comment">//Structured destroyed.</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        }</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <span class="keywordflow">return</span> session-&gt;cancelSession();</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;}</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;</div>
<div class="line"><a name="l00765"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a428287875d0b64ca754cefdaed386ac0">  765</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_structure_manager.html#a428287875d0b64ca754cefdaed386ac0">StructureManager::promptDeleteAllItems</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature,</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure) {</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        ManagedReference&lt;SuiMessageBox*&gt; sui = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_message_box.html">SuiMessageBox</a>(creature, 0x00);</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        sui-&gt;setUsingObject(structure);</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;        sui-&gt;setPromptTitle(<span class="stringliteral">&quot;@player_structure:delete_all_items&quot;</span>); <span class="comment">//Delete All Items</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;        sui-&gt;setPromptText(<span class="stringliteral">&quot;@player_structure:delete_all_items_d&quot;</span>); <span class="comment">//This command will delete every object in your house.  Are you ABSOLUTELY sure you want to destroy every object in your house?</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;        sui-&gt;setCancelButton(<span class="keyword">true</span>, <span class="stringliteral">&quot;@cancel&quot;</span>);</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        sui-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_delete_all_items_sui_callback.html">DeleteAllItemsSuiCallback</a>(<a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>));</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        <span class="keywordflow">if</span> (ghost != NULL) {</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;                ghost-&gt;addSuiBox(sui);</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(sui-&gt;generateMessage());</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        }</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;}</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;</div>
<div class="line"><a name="l00782"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a1fcfc982b3bc669e1ebbe0df338f32fa">  782</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_structure_manager.html#a1fcfc982b3bc669e1ebbe0df338f32fa">StructureManager::promptFindLostItems</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature,</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure) {</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        ManagedReference&lt;SuiMessageBox*&gt; sui = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_message_box.html">SuiMessageBox</a>(creature, 0x00);</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        sui-&gt;setUsingObject(structure);</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        sui-&gt;setPromptTitle(<span class="stringliteral">&quot;@player_structure:move_first_item&quot;</span>); <span class="comment">//Find Lost Items</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        sui-&gt;setPromptText(<span class="stringliteral">&quot;@player_structure:move_first_item_d&quot;</span>); <span class="comment">//This command will move the first item in your house to your location...</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        sui-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_find_lost_items_sui_callback.html">FindLostItemsSuiCallback</a>(<a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>));</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        <span class="keywordflow">if</span> (ghost != NULL) {</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;                ghost-&gt;addSuiBox(sui);</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(sui-&gt;generateMessage());</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        }</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;}</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;</div>
<div class="line"><a name="l00798"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a1286163435a03150b4e5624e3581a3e0">  798</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_structure_manager.html#a1286163435a03150b4e5624e3581a3e0">StructureManager::moveFirstItemTo</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature,</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure) {</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        <span class="keywordflow">if</span> (!structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#af6239c08a91da25525461b4cabe43a0e">isBuildingObject</a>())</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        ManagedReference&lt;BuildingObject*&gt; building =</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;                        cast&lt;BuildingObject*&gt;(structure);</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        Locker _lock(building, creature);</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <span class="keywordflow">for</span> (uint32 i = 1; i &lt;= building-&gt;getTotalCellNumber(); ++i) {</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                ManagedReference&lt;CellObject*&gt; cell = building-&gt;getCell(i);</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                <span class="keywordtype">int</span> size = cell-&gt;getContainerObjectsSize();</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; size; ++j) {</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                        ManagedReference&lt;SceneObject*&gt; childObject =</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                                        cell-&gt;getContainerObject(j);</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;                        <span class="keywordflow">if</span> (childObject-&gt;isVendor())</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                        <span class="comment">//if (!building-&gt;containsChildObject(childObject) &amp;&amp; !childObject-&gt;isCreatureObject()) {</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                        <span class="keywordflow">if</span> (creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a43d86202d8d07e7a320e55e53f598982">getParent</a>() != NULL</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;                                        &amp;&amp; !building-&gt;containsChildObject(childObject)</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                                        &amp;&amp; !childObject-&gt;isCreatureObject()) {</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                                <span class="keywordflow">if</span> (creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a43d86202d8d07e7a320e55e53f598982">getParent</a>().get()-&gt;getParent().get()</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                                                == childObject-&gt;getParent().get()-&gt;getParent().get()) {</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;                                        childObject-&gt;teleport(creature-&gt;getPositionX(),</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                                                        creature-&gt;getPositionZ(), creature-&gt;getPositionY(),</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                                                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a5f9d75a074069ba002361eccd14b0e4c">getParentID</a>());</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                                        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                                                        <span class="stringliteral">&quot;@player_structure:moved_first_item&quot;</span>); <span class="comment">//The first item in your house has been moved to your location.</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;                                }</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;                                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                        }</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                }</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        }</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;}</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div>
<div class="line"><a name="l00840"></a><span class="lineno"><a class="code" href="class_structure_manager.html#aed162836134680d9c39dff7a5072eb94">  840</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_structure_manager.html#aed162836134680d9c39dff7a5072eb94">StructureManager::reportStructureStatus</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature,</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure) {</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;        <span class="comment">//Close the window if it is already open.</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;        ghost-&gt;closeSuiWindowType(<a class="code" href="class_sui_window_type.html#a0deb716ba2c9d291f23d79fc658663bf">SuiWindowType::STRUCTURE_STATUS</a>);</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;        ManagedReference&lt;SuiListBox*&gt; status = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1listbox_1_1_sui_list_box.html">SuiListBox</a>(creature,</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                        <a class="code" href="class_sui_window_type.html#a0deb716ba2c9d291f23d79fc658663bf">SuiWindowType::STRUCTURE_STATUS</a>);</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;        status-&gt;setPromptTitle(<span class="stringliteral">&quot;@player_structure:structure_status_t&quot;</span>); <span class="comment">//Structure Status</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;        status-&gt;setPromptText(</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                        <span class="stringliteral">&quot;@player_structure:structure_name_prompt &quot;</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;                                        + structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a2c408356d762cb58abb38e620f263f5d">getDisplayedName</a>()); <span class="comment">//Structure Name:</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        status-&gt;setUsingObject(structure);</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        status-&gt;setOkButton(<span class="keyword">true</span>, <span class="stringliteral">&quot;@refresh&quot;</span>);</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;        status-&gt;setCancelButton(<span class="keyword">true</span>, <span class="stringliteral">&quot;@cancel&quot;</span>);</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        status-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_structure_status_sui_callback.html">StructureStatusSuiCallback</a>(<a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>));</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;        ManagedReference&lt;SceneObject*&gt; ownerObject = <a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>-&gt;<a class="code" href="classserver_1_1zone_1_1_zone_server.html#a8e09d3df7c2e98ad0b5628552ea27df6">getObject</a>(</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;                        structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a8d886c42927a8b947e0b09bc9d78eee8">getOwnerObjectID</a>());</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        <span class="keywordflow">if</span> (ownerObject != NULL &amp;&amp; ownerObject-&gt;isCreatureObject()) {</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* owner = cast&lt;CreatureObject*&gt;(ownerObject.get());</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;                status-&gt;addMenuItem(</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;                                <span class="stringliteral">&quot;@player_structure:owner_prompt &quot;</span> + owner-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#adfe0236a74e0df605e1bf429578e4ab9">getFirstName</a>());</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;        }</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;        uint64 declaredOidResidence = ghost-&gt;getDeclaredResidence();</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        ManagedReference&lt;BuildingObject*&gt; declaredResidence =</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;                        <a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>-&gt;<a class="code" href="classserver_1_1zone_1_1_zone_server.html#a8e09d3df7c2e98ad0b5628552ea27df6">getObject</a>(declaredOidResidence).castTo&lt;<a class="code" href="classserver_1_1zone_1_1objects_1_1building_1_1_building_object.html">BuildingObject</a>*&gt;();</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;        <span class="keywordflow">if</span> (declaredResidence == structure) {</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                status-&gt;addMenuItem(<span class="stringliteral">&quot;@player_structure:declared_residency&quot;</span>); <span class="comment">//You have declared your residency here.</span></div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;        }</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;        <span class="keywordflow">if</span> (structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a6b206ead2c6a1629b7e3b54a5d5c7a44">isPrivateStructure</a>() &amp;&amp; !structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#ae4bddcf55925d17b71a59d1f70b0d835">isCivicStructure</a>()) {</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;                status-&gt;addMenuItem(<span class="stringliteral">&quot;@player_structure:structure_private&quot;</span>); <span class="comment">//This structure is private</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                status-&gt;addMenuItem(<span class="stringliteral">&quot;@player_structure:structure_public&quot;</span>); <span class="comment">//This structure is public</span></div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        }</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        status-&gt;addMenuItem(</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                        <span class="stringliteral">&quot;@player_structure:condition_prompt &quot;</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;                                        + String::valueOf(structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a0e1424b3e841e8482af4e220d5e4d292">getDecayPercentage</a>()) + <span class="stringliteral">&quot;%&quot;</span>);</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        <span class="keywordflow">if</span> (!structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#ae4bddcf55925d17b71a59d1f70b0d835">isCivicStructure</a>()) {</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                <span class="keywordtype">float</span> secsRemainingMaint = 0.f;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;                <span class="keywordflow">if</span>( structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a3669b3cc362d7836a17638d07090d68b">getSurplusMaintenance</a>() &gt; 0 ){</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;                        secsRemainingMaint = ((float)structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a3669b3cc362d7836a17638d07090d68b">getSurplusMaintenance</a>() / (float)structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#ad67c7d70206e5c793679c278d9b8bf16">getMaintenanceRate</a>())*3600;</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                }</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                status-&gt;addMenuItem(</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                        <span class="stringliteral">&quot;@player_structure:maintenance_pool_prompt &quot;</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                                        + String::valueOf( (<span class="keywordtype">int</span>) floor( (<span class="keywordtype">float</span>) structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a3669b3cc362d7836a17638d07090d68b">getSurplusMaintenance</a>()))</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                                        + <span class="stringliteral">&quot; &quot;</span></div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                                        + <a class="code" href="class_structure_manager.html#a71107fdda9bed9244468b142213edc7c">getTimeString</a>( (uint32)secsRemainingMaint ) );</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                status-&gt;addMenuItem(</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                        <span class="stringliteral">&quot;@player_structure:maintenance_rate_prompt &quot;</span></div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                                        + String::valueOf(structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#ad67c7d70206e5c793679c278d9b8bf16">getMaintenanceRate</a>())</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                                        + <span class="stringliteral">&quot; cr/hr&quot;</span>);</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                <span class="comment">// property tax</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;                <span class="keywordflow">if</span>(!structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#ae4bddcf55925d17b71a59d1f70b0d835">isCivicStructure</a>() &amp;&amp; structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a6ed514df7f0abf4ca435a11c5b5c6c96">getCityRegion</a>() != NULL){</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;                        ManagedReference&lt;CityRegion*&gt; city = structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a6ed514df7f0abf4ca435a11c5b5c6c96">getCityRegion</a>().get();</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                        <span class="keywordflow">if</span>(city != NULL){</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                                <span class="keywordtype">float</span> propertytax = city-&gt;getPropertyTax();</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                                status-&gt;addMenuItem(</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                                                        <span class="stringliteral">&quot;@city/city:property_tax_prompt : &quot;</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                                                                        + String::valueOf(ceil( propertytax / 100.f * structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#ad67c7d70206e5c793679c278d9b8bf16">getMaintenanceRate</a>()))</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                                                                        +  <span class="stringliteral">&quot; cr/hr&quot;</span>);</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                        }</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                }</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;                status-&gt;addMenuItem(</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                        <span class="stringliteral">&quot;@player_structure:maintenance_mods_prompt &quot;</span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                                        + structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a5af8c0cb3efb5b7812304852a763bb5e">getMaintenanceMods</a>());</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        }</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        <span class="keywordflow">if</span> (structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a874ad9f204f27cc3d9f9ec1f9c46ce24">isInstallationObject</a>() &amp;&amp; !structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#afc3de987cf1309b41d76318b8f640c7b">isGeneratorObject</a>() &amp;&amp; !structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#ae4bddcf55925d17b71a59d1f70b0d835">isCivicStructure</a>()) {</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1installation_1_1_installation_object.html">InstallationObject</a>* installation = cast&lt;InstallationObject*&gt;(structure);</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;                <span class="keywordtype">float</span> secsRemainingPower = 0.f;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;                <span class="keywordflow">if</span>( installation-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a3725c30cb54e943e620109669995bd25">getSurplusPower</a>() &gt; 0 ){</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;                        secsRemainingPower = ((float)installation-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a3725c30cb54e943e620109669995bd25">getSurplusPower</a>() / (float)installation-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a5abd202f7c1683dbd99fd376f8f04e6f">getBasePowerRate</a>())*3600;</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;                }</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;                status-&gt;addMenuItem(</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;                                <span class="stringliteral">&quot;@player_structure:power_reserve_prompt &quot;</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                                                + String::valueOf( (<span class="keywordtype">int</span>) installation-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a3725c30cb54e943e620109669995bd25">getSurplusPower</a>())</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;                                                + <span class="stringliteral">&quot; &quot;</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;                                                + <a class="code" href="class_structure_manager.html#a71107fdda9bed9244468b142213edc7c">getTimeString</a>( (uint32)secsRemainingPower ) );</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;                status-&gt;addMenuItem(</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;                                <span class="stringliteral">&quot;@player_structure:power_consumption_prompt &quot;</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;                                                + String::valueOf(</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;                                                                (<span class="keywordtype">int</span>) installation-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a5abd202f7c1683dbd99fd376f8f04e6f">getBasePowerRate</a>())</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;                                                + <span class="stringliteral">&quot; @player_structure:units_per_hour&quot;</span>);</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        }</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        <span class="keywordflow">if</span> (structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#af6239c08a91da25525461b4cabe43a0e">isBuildingObject</a>()) {</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1building_1_1_building_object.html">BuildingObject</a>* building = cast&lt;BuildingObject*&gt;(structure);</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                status-&gt;addMenuItem(</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                                <span class="stringliteral">&quot;@player_structure:items_in_building_prompt &quot;</span></div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;                                                + String::valueOf(</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                                                                building-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1building_1_1_building_object.html#a41bb3fb145cc76986848e0f9c5139ec9">getCurrentNumberOfPlayerItems</a>())); <span class="comment">//Number of Items in Building:</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;        }</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        ghost-&gt;addSuiBox(status);</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(status-&gt;generateMessage());</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;}</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;</div>
<div class="line"><a name="l00959"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a23ad1c949fe7dbb60143a656fa086b13">  959</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_structure_manager.html#a23ad1c949fe7dbb60143a656fa086b13">StructureManager::promptNameStructure</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature,</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure, <a class="code" href="classserver_1_1zone_1_1objects_1_1tangible_1_1_tangible_object.html">TangibleObject</a>* <span class="keywordtype">object</span>) {</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        ManagedReference&lt;SuiInputBox*&gt; inputBox = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_input_box.html">SuiInputBox</a>(creature,</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                        <a class="code" href="class_sui_window_type.html#a37a98c51bfd03e00ed6e25e95d71c9e8">SuiWindowType::OBJECT_NAME</a>);</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;        <span class="keywordflow">if</span> (<span class="keywordtype">object</span> == NULL) {</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;                inputBox-&gt;setUsingObject(structure);</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;                inputBox-&gt;setUsingObject(<span class="keywordtype">object</span>);</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        }</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        inputBox-&gt;setPromptTitle(<span class="stringliteral">&quot;@base_player:set_name&quot;</span>); <span class="comment">//Set Name</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        inputBox-&gt;setPromptText(<span class="stringliteral">&quot;@player_structure:structure_name_prompt&quot;</span>); <span class="comment">//Structure Name:</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        inputBox-&gt;setMaxInputSize(128);</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        inputBox-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_name_structure_sui_callback.html">NameStructureSuiCallback</a>(<a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>));</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;        inputBox-&gt;setForceCloseDistance(32);</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        ghost-&gt;addSuiBox(inputBox);</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(inputBox-&gt;generateMessage());</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;}</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;</div>
<div class="line"><a name="l00983"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a543dd9f92698d89aef44c2c2d1034f36">  983</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_structure_manager.html#a543dd9f92698d89aef44c2c2d1034f36">StructureManager::promptPayUncondemnMaintenance</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature,</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure) {</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL) {</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        }</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;        <span class="keywordtype">int</span> uncondemnCost = -structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a3669b3cc362d7836a17638d07090d68b">getSurplusMaintenance</a>();</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;        ManagedReference&lt;SuiMessageBox*&gt; sui;</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;        String text;</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;        <span class="keywordflow">if</span> (creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a3e78db552e8aa8f9e5e81d72d88f3b73">getCashCredits</a>() + creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#aedb1c9c6d544501b62f723e5a5e83ac1">getBankCredits</a>()</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                        &gt;= uncondemnCost) {</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;                <span class="comment">//Owner can un-condemn the structure.</span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                sui = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_message_box.html">SuiMessageBox</a>(creature,</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                                <a class="code" href="class_sui_window_type.html#a9e85919197103727b75f8b6df18cf418">SuiWindowType::STRUCTURE_UNCONDEMN_CONFIRM</a>);</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                <span class="keywordflow">if</span> (sui == NULL) {</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                        <span class="comment">//TODO: what message should be shown here?</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                }</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                <span class="comment">//TODO: investigate sui packets to see if it is possible to send StringIdChatParameter directly.</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                String textStringId =</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                                <span class="stringliteral">&quot;@player_structure:structure_condemned_owner_has_credits&quot;</span>;</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                text =</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                                StringIdManager::instance()-&gt;getStringId(</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                                                textStringId.hashCode()).toString();</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;                text = text.replaceFirst(<span class="stringliteral">&quot;%DI&quot;</span>, String::valueOf(uncondemnCost));</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                sui-&gt;setCancelButton(<span class="keyword">true</span>, <span class="stringliteral">&quot;@cancel&quot;</span>);</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                sui-&gt;setCallback(</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                                <span class="keyword">new</span> <a class="code" href="class_structure_pay_uncondemn_maintenance_sui_callback.html">StructurePayUncondemnMaintenanceSuiCallback</a>(<a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>));</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                <span class="comment">//Owner cannot un-condemn the structure.</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                sui = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_message_box.html">SuiMessageBox</a>(creature, <a class="code" href="class_sui_window_type.html#a04c0727b8d6d9bb9fdf3db3e38b09aeb">SuiWindowType::NONE</a>);</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;                <span class="keywordflow">if</span> (sui == NULL) {</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                        <span class="comment">//TODO: what message should be shown here?</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                }</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                <span class="comment">//TODO: investigate sui packets to see if it is possible to send StringIdChatParameter directly.</span></div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                String textStringId =</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                                <span class="stringliteral">&quot;@player_structure:structure_condemned_owner_no_credits&quot;</span>;</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;                text =</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                                StringIdManager::instance()-&gt;getStringId(</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                                                textStringId.hashCode()).toString();</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;                text = text.replaceFirst(<span class="stringliteral">&quot;%DI&quot;</span>, String::valueOf(uncondemnCost));</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                sui-&gt;setCancelButton(<span class="keyword">false</span>, <span class="stringliteral">&quot;@cancel&quot;</span>);</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;        }</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;        sui-&gt;setPromptText(text);</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;        sui-&gt;setOkButton(<span class="keyword">true</span>, <span class="stringliteral">&quot;@ok&quot;</span>);</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        sui-&gt;setPromptTitle(<span class="stringliteral">&quot;@player_structure:fix_condemned_title&quot;</span>);</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;        sui-&gt;setUsingObject(structure);</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;        ghost-&gt;addSuiBox(sui);</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(sui-&gt;generateMessage());</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;}</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;</div>
<div class="line"><a name="l01045"></a><span class="lineno"><a class="code" href="class_structure_manager.html#af7f44194608503089315681118a6955e"> 1045</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_structure_manager.html#af7f44194608503089315681118a6955e">StructureManager::promptPayMaintenance</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure,</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html">SceneObject</a>* terminal) {</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;        <span class="keywordtype">int</span> availableCredits = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a3e78db552e8aa8f9e5e81d72d88f3b73">getCashCredits</a>();</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        <span class="keywordflow">if</span> (availableCredits &lt;= 0) {</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:no_money&quot;</span>); <span class="comment">//You do not have any money to pay maintenance.</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;        }</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;        ManagedReference&lt;PlayerObject*&gt; ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;        <span class="keywordflow">if</span> (ghost == NULL)</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        <span class="comment">//Get the most up to date maintenance count.</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;        structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a4992c446309160504b62c93da60c068b">updateStructureStatus</a>();</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        <span class="keywordtype">int</span> surplusMaintenance = (int) floor(</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                        (<span class="keywordtype">float</span>) structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a3669b3cc362d7836a17638d07090d68b">getSurplusMaintenance</a>());</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        ManagedReference&lt;SuiTransferBox*&gt; sui = <span class="keyword">new</span> <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1sui_1_1messagebox_1_1_sui_transfer_box.html">SuiTransferBox</a>(creature,</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                        <a class="code" href="class_sui_window_type.html#af4f343b9a13692b169a92d91f48c069c">SuiWindowType::STRUCTURE_MANAGE_MAINTENANCE</a>);</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        sui-&gt;setCallback(<span class="keyword">new</span> <a class="code" href="class_structure_pay_maintenance_sui_callback.html">StructurePayMaintenanceSuiCallback</a>(<a class="code" href="class_structure_manager.html#ad64b3d9737d470366549401f105a90be">server</a>));</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        sui-&gt;setPromptTitle(<span class="stringliteral">&quot;@player_structure:select_amount&quot;</span>); <span class="comment">//Select Amount</span></div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        sui-&gt;setUsingObject(structure);</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;        sui-&gt;setPromptText(</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;                        <span class="stringliteral">&quot;@player_structure:select_maint_amount \n@player_structure:current_maint_pool &quot;</span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;                                        + String::valueOf(surplusMaintenance));</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        sui-&gt;addFrom(<span class="stringliteral">&quot;@player_structure:total_funds&quot;</span>,</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;                        String::valueOf(availableCredits),</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;                        String::valueOf(availableCredits), <span class="stringliteral">&quot;1&quot;</span>);</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;        sui-&gt;addTo(<span class="stringliteral">&quot;@player_structure:to_pay&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>);</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;        ghost-&gt;addSuiBox(sui);</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ac0a95f597b213ca7c728942bfb8a3760">sendMessage</a>(sui-&gt;generateMessage());</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;}</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;</div>
<div class="line"><a name="l01082"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a0be59994de68c4704f92a576bd59175a"> 1082</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_structure_manager.html#a0be59994de68c4704f92a576bd59175a">StructureManager::payMaintenance</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure,</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;                <a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html">CreatureObject</a>* creature, <span class="keywordtype">int</span> amount) {</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;        <span class="keywordflow">if</span> (!creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#ad2506e688bcb2a9d653ecb1057884260">isInRange</a>(structure, 16.f)</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;                        &amp;&amp; creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a0affccda47c32f2777f0a8874163d462">getRootParent</a>() != structure) {</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:pay_out_of_range&quot;</span>); <span class="comment">//You have moved out of range of your original /payMaintenance target. Aborting...</span></div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        }</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        <span class="keywordtype">int</span> cash = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a3e78db552e8aa8f9e5e81d72d88f3b73">getCashCredits</a>();</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        <span class="keywordflow">if</span> (cash &lt; amount) {</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;                creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(<span class="stringliteral">&quot;@player_structure:insufficient_funds&quot;</span>); <span class="comment">//You have insufficient funds to make this deposit.</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;                <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        }</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        <a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html">StringIdChatParameter</a> params(<span class="stringliteral">&quot;base_player&quot;</span>, <span class="stringliteral">&quot;prose_pay_success&quot;</span>); <span class="comment">//You successfully make a payment of %DI credits to %TT.</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;        params.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#a46d29e48d6738ce32cc73e6e7225bdf7">setTT</a>(structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a2c408356d762cb58abb38e620f263f5d">getDisplayedName</a>());</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;        params.<a class="code" href="classserver_1_1chat_1_1_string_id_chat_parameter.html#aa35ce7d0a7a3b96baff3e88100b3f5f8">setDI</a>(amount);</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#ad60087a1560819c9da80f4dd19b298ab">sendSystemMessage</a>(params);</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a403e0ac095a11784dc1daa3db8cba351">subtractCashCredits</a>(amount);</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;        structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#a1e4cc519c134d3538a0fa12c08c2c903">addMaintenance</a>(amount);</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        <a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html">PlayerObject</a>* ghost = creature-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1creature_1_1_creature_object.html#a958438b0ec0972ba60fa3cbdb54f0f24">getPlayerObject</a>();</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        <span class="keywordflow">if</span> (ghost-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1player_1_1_player_object.html#ac3f9119dd14b6ff118fc66be27e79b35">hasAbility</a>(<span class="stringliteral">&quot;maintenance_fees_1&quot;</span>)){</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;                structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#af959293b7ec34c400efc83900f5bb53d">setMaintenanceReduced</a>(<span class="keyword">true</span>);</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        }<span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html#af959293b7ec34c400efc83900f5bb53d">setMaintenanceReduced</a>(<span class="keyword">false</span>);</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        }</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;}</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;</div>
<div class="line"><a name="l01115"></a><span class="lineno"><a class="code" href="class_structure_manager.html#a6f43266c29105f67319807bd956f1a85"> 1115</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_structure_manager.html#a6f43266c29105f67319807bd956f1a85">StructureManager::isInStructureFootprint</a>(<a class="code" href="classserver_1_1zone_1_1objects_1_1structure_1_1_structure_object.html">StructureObject</a>* structure, <span class="keywordtype">float</span> positionX, <span class="keywordtype">float</span> positionY, <span class="keywordtype">int</span> extraFootprintMargin){</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;        <span class="keywordflow">if</span>(structure == NULL)</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        <span class="keywordflow">if</span>(structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a49977bbe7ffeb660df3173c94421068b">getObjectTemplate</a>() == NULL)</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;        Reference&lt;SharedStructureObjectTemplate*&gt; serverTemplate =</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;                                <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_shared_structure_object_template.html">SharedStructureObjectTemplate</a>*<span class="keyword">&gt;</span>(structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a49977bbe7ffeb660df3173c94421068b">getObjectTemplate</a>());</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;        <span class="keywordtype">float</span> placingFootprintLength0, placingFootprintWidth0, placingFootprintLength1, placingFootprintWidth1;</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        StructureManager::instance()-&gt;<a class="code" href="class_shared_tangible_object_template.html#ae845f7d66c4dd0e4b37a945533180bb6">getStructureFootprint</a>(serverTemplate, structure-&gt;<a class="code" href="classserver_1_1zone_1_1objects_1_1scene_1_1_scene_object.html#a910e0278f19ab10c39bf564a1b068b68">getDirectionAngle</a>(), placingFootprintLength0, placingFootprintWidth0, placingFootprintLength1, placingFootprintWidth1);</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;        <span class="comment">//info(&quot;object: &quot; + obj-&gt;getObjectNameStringIdName() + &quot; obj x = &quot; + String::valueOf(obj-&gt;getPositionX()) + &quot; y= &quot; + String::valueOf(obj-&gt;getPositionY()),true);</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;        <span class="keywordtype">float</span> x0 = structure-&gt;getPositionX() + placingFootprintWidth0 + extraFootprintMargin;</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;        <span class="keywordtype">float</span> y0 = structure-&gt;getPositionY() + placingFootprintLength0 + extraFootprintMargin;</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;        <span class="keywordtype">float</span> x1 = structure-&gt;getPositionX() + placingFootprintWidth1 + extraFootprintMargin;</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;        <span class="keywordtype">float</span> y1 = structure-&gt;getPositionY() + placingFootprintLength1 + extraFootprintMargin;</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;        <a class="code" href="class_boundary_rectangle.html">BoundaryRectangle</a> structureFootprint(x0, y0, x1, y1);</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;        <span class="keywordflow">return</span> structureFootprint.<a class="code" href="class_boundary_rectangle.html#aa37efb7980ce0f5d2b1ad4eb242b6862">containsPoint</a>(positionX, positionY);</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 15 2013 17:28:40 for Core3 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
